<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grupo CCM | Plan Digital 2026</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary:#2563eb; --primary-hover:#1d4ed8;
      --bg-body:#f3f4f6; --bg-card:#fff;
      --text-main:#111827; --text-muted:#6b7280;
      --border-color:#e5e7eb;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);
      --shadow-md:0 6px 16px rgba(17,24,39,.08);
      --shadow-lg:0 14px 30px rgba(17,24,39,.12);
      --r:14px;
    }
    body{
      background:var(--bg-body);
      font-family:'Inter',sans-serif;
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }
    .app-shell{max-width:1400px;}
    .navbar-ccm{
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border-color);
      box-shadow:var(--shadow-sm);
      padding:.75rem 0;
    }
    .brand-icon{
      width:34px;height:34px;border-radius:10px;
      background:#eff6ff;color:var(--primary);
      display:flex;align-items:center;justify-content:center;
    }
    .brand-title{font-weight:800;font-size:1rem;letter-spacing:-.02em;}
    .brand-sub{font-size:.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;}
    .cardx{
      background:var(--bg-card);
      border:1px solid var(--border-color);
      border-radius:var(--r);
      box-shadow:var(--shadow-sm);
      overflow:hidden;
    }
    .cardx:hover{box-shadow:var(--shadow-md);}
    .section-title{font-weight:800;letter-spacing:-.02em;}
    .mini{color:var(--text-muted);font-size:.9rem;}
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.86em;color:var(--primary);
      background:#eff6ff;padding:2px 8px;border-radius:8px;border:1px solid #dbeafe;
      display:inline-block;
    }
    .btn{
      padding:.55rem 1rem;border-radius:10px;
      font-weight:600;font-size:.9rem;
      transition:all .18s ease;border:1px solid transparent;
    }
    .btn-primary{background:var(--primary);border-color:var(--primary);}
    .btn-primary:hover{background:var(--primary-hover);border-color:var(--primary-hover);transform:translateY(-1px);}
    .btn-light{background:#fff;border-color:var(--border-color);color:#374151;}
    .btn-light:hover{background:#f9fafb;border-color:#d1d5db;color:#111827;}
    .nav-tabs{border-bottom:1px solid var(--border-color);gap:1rem;}
    .nav-tabs .nav-link{border:none;color:var(--text-muted);font-weight:700;padding:.85rem .35rem;background:transparent;}
    .nav-tabs .nav-link:hover{color:var(--primary);}
    .nav-tabs .nav-link.active{color:var(--primary);border-bottom:2px solid var(--primary);background:transparent;}
    .table thead th{
      background:#f9fafb;color:#6b7280;
      font-size:.75rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;
      border-bottom:1px solid var(--border-color);
      padding:.85rem 1rem;
      white-space:nowrap;
    }
    .table tbody td{
      padding:.9rem 1rem;border-bottom:1px solid var(--border-color);
      vertical-align:middle;font-size:.92rem;
    }
    .table-hover tbody tr:hover{background:#f9fafb;}
    .badge-status{
      padding:4px 10px;border-radius:999px;
      font-size:.75rem;font-weight:800;
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid rgba(0,0,0,.06);
    }
    .badge-status::before{content:'';width:7px;height:7px;border-radius:50%;background:currentColor;}
    .st-muted{background:#f3f4f6;color:#4b5563;}
    .st-blue{background:#eff6ff;color:#2563eb;}
    .st-green{background:#ecfdf5;color:#059669;}
    .st-amber{background:#fffbeb;color:#d97706;}
    .st-red{background:#fef2f2;color:#dc2626;}
    .form-control,.form-select{
      border-radius:10px;border-color:var(--border-color);
      padding:.62rem .8rem;font-size:.92rem;
    }
    .form-control:focus,.form-select:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,.12);
    }
    .req{color:#dc2626;font-weight:900;}
    .truncate-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
    .loading{
      position:fixed;inset:0;background:rgba(255,255,255,.78);
      backdrop-filter:blur(2px);
      display:none;align-items:center;justify-content:center;z-index:3000;
    }
    .loading .box{
      background:#fff;border:1px solid var(--border-color);
      border-radius:16px;box-shadow:var(--shadow-lg);
      padding:18px 22px;display:flex;gap:12px;align-items:center;
      min-width:240px;
    }
    .alert-stack{
      position:fixed;top:84px;right:18px;z-index:2500;
      display:flex;flex-direction:column;gap:10px;width:390px;max-width:calc(100vw - 36px);
    }
    .alert-card{
      background:#fff;border:1px solid var(--border-color);
      border-left:5px solid var(--primary);
      border-radius:12px;box-shadow:var(--shadow-md);
      padding:12px 14px;display:flex;gap:12px;align-items:flex-start;
      animation:slideIn .22s ease;
    }
    .alert-card.success{border-left-color:#059669;}
    .alert-card.danger{border-left-color:#dc2626;}
    .alert-card.warning{border-left-color:#d97706;}
    @keyframes slideIn{from{transform:translateX(10%);opacity:0}to{transform:translateX(0);opacity:1}}
    .hidden{display:none!important;}
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.85em;background:#f3f4f6;border:1px solid #e5e7eb;border-bottom-width:2px;
      padding:2px 6px;border-radius:8px;color:#374151;
    }
  </style>
</head>

<body>
  <div class="alert-stack" id="alertStack"></div>

  <nav class="navbar navbar-ccm sticky-top">
    <div class="container-fluid app-shell px-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-icon"><i class="bi bi-grid-fill"></i></div>
        <div class="min-w-0">
          <div class="brand-title">Grupo CCM</div>
          <div class="brand-sub">Plan Digital 2026</div>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge bg-light text-dark border fw-semibold py-2 px-3 rounded-pill" id="whoami">Cargando…</span>
        <button class="btn btn-light btn-sm" id="btnLogout" disabled><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell my-5 px-4">

    <!-- LOGIN -->
    <div id="loginView" class="cardx p-5 mx-auto" style="max-width: 480px;">
      <div class="text-center mb-4">
        <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3" style="width: 50px; height: 50px;">
          <i class="bi bi-shield-lock-fill fs-5"></i>
        </div>
        <h4 class="fw-bold mb-1">Iniciar sesión</h4>
        <p class="text-muted small mb-0">Accede al panel de Marketing.</p>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold small">Correo electrónico</label>
        <input type="email" class="form-control" id="loginEmail" placeholder="nombre@grupoccm.com" autocomplete="username">
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold small">Contraseña</label>
        <input type="password" class="form-control" id="loginPass" placeholder="••••••••" autocomplete="current-password">
      </div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-link px-0 small text-decoration-none" id="btnForgotPass" type="button">¿Olvidaste tu clave?</button>
        <span class="text-muted small">Tip: Enter para ingresar</span>
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSignIn">
        <i class="bi bi-box-arrow-in-right me-1"></i>Ingresar
      </button>
      <div class="text-center mt-3 small text-muted">Powered by Supabase</div>
    </div>

    <!-- APP -->
    <div id="appView" class="hidden">
      <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
        <div>
          <h3 class="section-title mb-1">Panel de Control</h3>
          <div class="mini">Campañas · Piezas · Métricas · Leads</div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-light bg-white" id="btnSeed"><i class="bi bi-database-add me-2 text-muted"></i>Seed 2026</button>
          <div class="vr mx-2 text-muted"></div>
          <button class="btn btn-primary" id="btnNewCampaign"><i class="bi bi-plus-lg me-1"></i>Campaña</button>
          <button class="btn btn-primary" id="btnNewPiece"><i class="bi bi-plus-lg me-1"></i>Pieza</button>
          <button class="btn btn-primary" id="btnNewMetric"><i class="bi bi-plus-lg me-1"></i>Métrica</button>
          <button class="btn btn-primary" id="btnNewLead"><i class="bi bi-plus-lg me-1"></i>Lead</button>
        </div>
      </div>

      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCampaigns" type="button" role="tab">
            <i class="bi bi-calendar-range me-2"></i>Campañas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPieces" type="button" role="tab">
            <i class="bi bi-grid me-2"></i>Piezas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMetrics" type="button" role="tab">
            <i class="bi bi-bar-chart me-2"></i>Métricas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLeads" type="button" role="tab">
            <i class="bi bi-people me-2"></i>Leads
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- CAMPAIGNS -->
        <div class="tab-pane fade show active" id="tabCampaigns" role="tabpanel">
          <div class="cardx">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-light bg-opacity-50">
              <div class="fw-bold small text-uppercase text-muted">Listado de campañas</div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-light" id="btnReloadCampaigns" title="Actualizar"><i class="bi bi-arrow-clockwise"></i></button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblCampaigns">
                <thead>
                  <tr>
                    <th>Bimestre</th>
                    <th>Nombre</th>
                    <th>Estado</th>
                    <th>Vigencia</th>
                    <th>Objetivo</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- PIECES -->
        <div class="tab-pane fade" id="tabPieces" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Bimestre</label>
                  <select class="form-select" id="fBim">
                    <option value="">Todos</option>
                    <option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option>
                    <option value="B4">B4</option><option value="B5">B5</option><option value="B6">B6</option>
                  </select>
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="fCamp"></select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Estado</label>
                  <select class="form-select" id="fPStatus">
                    <option value="">Todos</option>
                    <option value="idea">Idea</option>
                    <option value="borrador">Borrador</option>
                    <option value="programada">Programada</option>
                    <option value="publicada">Publicada</option>
                    <option value="pausada">Pausada</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input class="form-control border-start-0 ps-0" id="fQ" placeholder="Nombre, pilar, gancho…">
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblPieces">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Campaña</th>
                    <th>Formato</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadPieces">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla
              </button>
            </div>
          </div>
        </div>

        <!-- METRICS -->
        <div class="tab-pane fade" id="tabMetrics" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3 align-items-end">
                <div class="col-12 col-md-6">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="mPiece"></select>
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Desde</label>
                  <input type="date" class="form-control" id="mFrom">
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Hasta</label>
                  <input type="date" class="form-control" id="mTo">
                </div>
                <div class="col-12 col-md-2 d-flex gap-2">
                  <button class="btn btn-light w-100" id="btnReloadMetrics" title="Actualizar"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblMetrics">
                <thead class="text-center">
                  <tr>
                    <th class="text-start">Pieza</th>
                    <th>Fecha</th>
                    <th>Volumen</th>
                    <th>Interacciones</th>
                    <th>Inversión</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- LEADS -->
        <div class="tab-pane fade" id="tabLeads" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="lCamp"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="lPiece"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <input class="form-control" id="lQ" placeholder="Nombre, teléfono, email…">
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblLeads">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Contacto</th>
                    <th>Estado</th>
                    <th>Resultado</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadLeads">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- FORGOT PASSWORD -->
  <div class="modal fade" id="forgotPassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Recuperar acceso</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-2">Ingresa tu correo y enviaremos el enlace de recuperación.</p>
          <input type="email" class="form-control mb-3" id="fp_email" placeholder="tu@correo.com">
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" id="btnSendResetEmail">Enviar enlace</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SET NEW PASSWORD -->
  <div class="modal fade" id="setNewPassModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Nueva contraseña</h5>
        </div>
        <div class="modal-body">
          <div class="alert alert-light border small mb-3">
            Estás en modo recuperación. Al guardar, tu contraseña se actualizará.
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold">Contraseña nueva</label>
            <input type="password" class="form-control" id="np1" placeholder="Mínimo 6 caracteres">
          </div>
          <div class="mb-4">
            <label class="form-label small fw-bold">Confirmar</label>
            <input type="password" class="form-control" id="np2">
          </div>
          <button class="btn btn-primary w-100" id="btnSetNewPass">Actualizar contraseña</button>
          <button class="btn btn-light w-100 mt-2" id="btnCancelRecovery">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CAMPAIGN MODAL -->
  <div class="modal fade" id="campaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="campaignModalTitle">Campaña</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="c_id">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label small fw-bold">Bimestre <span class="req">*</span></label>
              <select class="form-select" id="c_bim" required>
                <option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option>
                <option value="B4">B4</option><option value="B5">B5</option><option value="B6">B6</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Estado</label>
              <input class="form-control" id="c_status" placeholder="planificada">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Budget planned</label>
              <input type="number" min="0" step="0.01" class="form-control" id="c_budget" value="0">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Nombre <span class="req">*</span></label>
              <input class="form-control" id="c_name" placeholder="Ej: Arranque 2026 | Chequeo Base">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Objetivo</label>
              <input class="form-control" id="c_objective" placeholder="Ej: Generar leads chequeo inicial">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Inicio <span class="req">*</span></label>
              <input type="date" class="form-control" id="c_start" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Fin <span class="req">*</span></label>
              <input type="date" class="form-control" id="c_end" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Anchor event</label>
              <input class="form-control" id="c_anchor" placeholder="Ej: Inicio Año">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Lead magnet</label>
              <input class="form-control" id="c_magnet" placeholder="Ej: Quiz Cardiometabólico">
            </div>
          </div>

          <div class="mt-3 small text-muted">
            <span class="req">*</span> Campos obligatorios
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveCampaign">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PIECE MODAL -->
  <div class="modal fade" id="pieceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="pieceModalTitle">Pieza</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="p_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Campaña</label>
              <select class="form-select" id="p_campaign"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Estado</label>
              <select class="form-select" id="p_status">
                <option value="idea">Idea</option>
                <option value="borrador">Borrador</option>
                <option value="programada">Programada</option>
                <option value="publicada">Publicada</option>
                <option value="pausada">Pausada</option>
              </select>
            </div>

            <div class="col-md-8">
              <label class="form-label small fw-bold">Nombre <span class="req">*</span></label>
              <input class="form-control" id="p_name" placeholder="Ej: Reel - CTA Chequeo" required>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Formato <span class="req">*</span></label>
              <!-- IMPORTANTE: debe coincidir con tu enum piece_format -->
              <input class="form-control" id="p_format" placeholder="(enum piece_format)" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Pilar</label>
              <input class="form-control" id="p_pillar" placeholder="Ej: Educación / Conversión / Retención">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Visual style</label>
              <input class="form-control" id="p_visual" placeholder="Ej: Minimal / Médico / Testimonial">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Hook / Copy corto</label>
              <textarea class="form-control" id="p_hook" rows="2" placeholder="Gancho principal…"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">CTA destination</label>
              <input class="form-control" id="p_cta" placeholder="Ej: WhatsApp / Landing / Agenda">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Ad ID</label>
              <input class="form-control" id="p_adid" placeholder="Ej: FB-12345">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Canal (opcional)</label>
              <!-- channel_id es bigint FK a channels; si no usas channels aún, déjalo vacío -->
              <select class="form-select" id="p_channel"></select>
              <div class="mini mt-2">Si no tienes tabla <span class="kbd">channels</span> aún, puedes dejarlo en “(Sin canal)”.</div>
            </div>
          </div>

          <div class="mt-3 small text-muted">
            <span class="req">*</span> Campos obligatorios
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button class="btn btn-primary" id="btnSavePiece">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- METRIC MODAL -->
  <div class="modal fade" id="metricModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="metricModalTitle">Métrica</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="mx_id">
          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label small fw-bold">Pieza <span class="req">*</span></label>
              <select class="form-select" id="mx_piece" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Fecha <span class="req">*</span></label>
              <input type="date" class="form-control" id="mx_date" required>
            </div>

            <div class="col-12"><hr class="text-muted"></div>

            <div class="col-md-4 text-center">
              <label class="form-label small text-muted fw-bold">Volumen</label>
              <input class="form-control text-center fw-bold" id="mx_volume" type="number" min="0" value="0">
            </div>
            <div class="col-md-4 text-center">
              <label class="form-label small text-muted fw-bold">Interacciones</label>
              <input class="form-control text-center fw-bold" id="mx_interactions" type="number" min="0" value="0">
            </div>
            <div class="col-md-4 text-center">
              <label class="form-label small text-muted fw-bold">Inversión</label>
              <input class="form-control text-center fw-bold" id="mx_spend" type="number" min="0" step="0.01" value="0">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveMetric">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LEAD MODAL -->
  <div class="modal fade" id="leadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="leadModalTitle">Lead</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="ld_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Nombre <span class="req">*</span></label>
              <input class="form-control" id="ld_name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Teléfono</label>
              <input class="form-control" id="ld_phone" placeholder="Ej: 7xxx-xxxx">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Email</label>
              <input class="form-control" id="ld_email" type="email" placeholder="Ej: correo@dominio.com">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Origen (detalle)</label>
              <input class="form-control" id="ld_source" placeholder="Ej: Instagram DM / Form / WhatsApp">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Campaña</label>
              <select class="form-select" id="ld_campaign"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Pieza</label>
              <select class="form-select" id="ld_piece"></select>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Estado (triage)</label>
              <!-- IMPORTANTE: debe coincidir con tu enum triage_status -->
              <input class="form-control" id="ld_triage" placeholder="(enum triage_status)">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Resultado clínico</label>
              <!-- IMPORTANTE: debe coincidir con tu enum clinical_outcome -->
              <input class="form-control" id="ld_outcome" placeholder="(enum clinical_outcome)">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Fecha cita</label>
              <input class="form-control" id="ld_appt" type="datetime-local">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Ticket</label>
              <input class="form-control" id="ld_ticket" type="number" min="0" step="0.01" value="0">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Retenido</label>
              <select class="form-select" id="ld_retained">
                <option value="false">No</option>
                <option value="true">Sí</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Notas</label>
              <textarea class="form-control" id="ld_notes" rows="2"></textarea>
            </div>
          </div>

          <div class="mt-3 small text-muted">
            <span class="req">*</span> Campos obligatorios
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveLead">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="box">
      <div class="spinner-border text-primary" role="status" aria-label="cargando"></div>
      <div class="fw-bold" id="loadingText">Procesando…</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ✅ TUS DATOS (ACTUALIZADOS)
    const SUPABASE_URL = "https://rofwgcrsfrovspiholbo.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_M7gyUpsbCPRopdrmDjEeLA_SHXlnP-C";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // MAPEO SEGÚN TU ESTRUCTURA REAL
    const MAP = {
      campaigns: {
        table: 'campaigns',
        id: 'id',
        name: 'name',
        bimester: 'bimester',
        start: 'start_date',
        end: 'end_date',
        objective: 'objective',
        anchor: 'anchor_event',
        magnet: 'lead_magnet',
        budget: 'budget_planned',
        status: 'status',
        created_at: 'created_at'
      },
      pieces: {
        table: 'pieces',
        id: 'id',
        campaign_id: 'campaign_id',
        channel_id: 'channel_id',
        name: 'name',
        format: 'format',
        pillar: 'pillar',
        hook: 'hook_copy',
        visual: 'visual_style',
        cta: 'cta_destination',
        ad_id: 'ad_id',
        status: 'status',
        created_at: 'created_at'
      },
      metrics: {
        table: 'piece_metrics',
        id: 'id',
        piece_id: 'piece_id',
        date: 'date',
        volume: 'volume',
        interactions: 'interactions',
        spend: 'spend',
        created_at: 'created_at'
      },
      leads: {
        table: 'leads',
        id: 'id',
        created_at: 'created_at',
        full_name: 'full_name',
        phone: 'phone',
        email: 'email',
        source: 'source_detail',
        campaign_id: 'campaign_id',
        piece_id: 'piece_id',
        triage: 'triage_status',
        triage_notes: 'triage_notes',
        outcome: 'clinical_outcome',
        appointment: 'appointment_date',
        ticket: 'ticket_value',
        retained: 'is_retained',
        updated_at: 'updated_at'
      }
    };

    const el = (id) => document.getElementById(id);

    function setLoading(on, txt="Procesando…"){
      el('loadingText').textContent = txt;
      el('loading').style.display = on ? 'flex' : 'none';
    }

    const esc = (s) => String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");

    function showAlert(type, title, message, ttlMs=4500){
      const stack = el('alertStack');
      const card = document.createElement('div');
      card.className = `alert-card ${type || ''}`;
      const icon = type === 'success' ? 'bi-check-circle-fill text-success' :
                   type === 'warning' ? 'bi-exclamation-triangle-fill text-warning' :
                   type === 'danger'  ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary';
      card.innerHTML = `
        <i class="bi ${icon} fs-5 mt-1"></i>
        <div class="flex-grow-1">
          <div class="fw-bold">${esc(title || 'Aviso')}</div>
          <div class="small text-secondary">${esc(message || '')}</div>
        </div>
        <button class="btn-close ms-2" aria-label="cerrar" style="font-size:.7em"></button>
      `;
      stack.appendChild(card);
      const close = () => { card.style.opacity='0'; setTimeout(()=>card.remove(),250); };
      card.querySelector('.btn-close').addEventListener('click', close);
      if(ttlMs) setTimeout(()=>{ if(card.isConnected) close(); }, ttlMs);
    }

    function humanize(err){
      const raw = (err?.message || err?.error_description || String(err || ''));
      const low = raw.toLowerCase();
      if(low.includes('invalid login credentials')) return 'Correo o contraseña incorrectos.';
      if(low.includes('email not confirmed')) return 'Tu correo aún no está confirmado.';
      if(low.includes('permission denied')) return 'Tu usuario no tiene permiso por RLS (policies).';
      return raw;
    }

    function getStatusBadge(status){
      const s = String(status || '').toLowerCase();
      let cls = 'st-muted';
      if(['publicada','cerrado','ganado','retained','retenido'].some(x=>s.includes(x))) cls = 'st-green';
      else if(['programada','pendiente','seguimiento'].some(x=>s.includes(x))) cls = 'st-blue';
      else if(['pausada','warning','alerta'].some(x=>s.includes(x))) cls = 'st-amber';
      else if(['descartado','perdido','cancelado','error'].some(x=>s.includes(x))) cls = 'st-red';
      return `<span class="badge-status ${cls}">${esc(status || '—')}</span>`;
    }

    const state = {
      user: null,
      profile: null,
      campaigns: [],
      pieces: [],
      metrics: [],
      leads: [],
      channels: [] // opcional, si existe tabla channels
    };

    function campaignLabel(c){
      const b = c[MAP.campaigns.bimester] || '';
      const n = c[MAP.campaigns.name] || '';
      return `${b} · ${n}`.trim();
    }

    function pieceLabel(p){
      const n = p[MAP.pieces.name] || '';
      const f = p[MAP.pieces.format] || '';
      return `${n}${f ? ' · ' + f : ''}`;
    }

    function openSetNewPasswordModal(){
      try{
        new bootstrap.Modal(el('setNewPassModal')).show();
      }catch(_){}
    }

    async function handleSession(session){
      state.user = session?.user || null;

      if(!state.user){
        el('loginView').classList.remove('hidden');
        el('appView').classList.add('hidden');
        el('whoami').textContent = '—';
        el('btnLogout').disabled = true;
        return;
      }

      // Profile (si la policy permite SELECT por auth.uid() = id)
      try{
        const { data: prof, error } = await supabase.from('profiles').select('*').eq('id', state.user.id).maybeSingle();
        if(error) throw error;
        state.profile = prof || null;
      }catch(_){
        state.profile = null;
      }

      el('loginView').classList.add('hidden');
      el('appView').classList.remove('hidden');
      el('whoami').textContent = state.profile?.full_name || state.profile?.email || state.user.email || 'Usuario';
      el('btnLogout').disabled = false;

      if(state.campaigns.length === 0) await refreshAll();
    }

    async function init(){
      const { data } = await supabase.auth.getSession();
      await handleSession(data.session);

      supabase.auth.onAuthStateChange(async (event, session) => {
        if(event === 'PASSWORD_RECOVERY'){
          openSetNewPasswordModal();
        }
        await handleSession(session);
      });
    }

    // ---------- AUTH UI ----------
    el('btnSignIn').addEventListener('click', async ()=>{
      const email = el('loginEmail').value.trim();
      const password = el('loginPass').value;
      if(!email || !password) return showAlert('warning','Faltan datos','Ingresa tu correo y contraseña.');

      setLoading(true, 'Iniciando sesión…');
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) throw error;
        showAlert('success','Listo','Sesión iniciada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    // Enter para login
    el('loginPass').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') el('btnSignIn').click(); });

    el('btnLogout').addEventListener('click', async ()=>{
      setLoading(true,'Cerrando sesión…');
      try{
        const { error } = await supabase.auth.signOut();
        if(error) throw error;
        window.location.reload();
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    el('btnForgotPass').addEventListener('click', ()=> new bootstrap.Modal(el('forgotPassModal')).show());

    el('btnSendResetEmail').addEventListener('click', async ()=>{
      const email = el('fp_email').value.trim();
      if(!email) return showAlert('warning','Email requerido','Ingresa tu correo.');

      setLoading(true,'Enviando enlace…');
      try{
        // redirectTo debe ser la misma URL donde está hosteada tu app (GitHub Pages)
        const redirectTo = window.location.origin + window.location.pathname;
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
        if(error) throw error;
        bootstrap.Modal.getInstance(el('forgotPassModal'))?.hide();
        showAlert('success','Enviado','Revisa tu bandeja de entrada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    el('btnCancelRecovery').addEventListener('click', async ()=>{
      // Salir del flujo de recovery
      try{ bootstrap.Modal.getInstance(el('setNewPassModal'))?.hide(); }catch(_){}
      try{ await supabase.auth.signOut(); }catch(_){}
      window.location.href = window.location.origin + window.location.pathname;
    });

    el('btnSetNewPass').addEventListener('click', async ()=>{
      const p1 = el('np1').value;
      const p2 = el('np2').value;
      if(!p1 || p1.length < 6) return showAlert('warning','Seguridad','Mínimo 6 caracteres.');
      if(p1 !== p2) return showAlert('warning','Error','Las contraseñas no coinciden.');

      setLoading(true,'Actualizando contraseña…');
      try{
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if(error) throw error;
        showAlert('success','Listo','Contraseña actualizada.');
        bootstrap.Modal.getInstance(el('setNewPassModal'))?.hide();
        // refrescar UI
        await refreshAll();
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    // ---------- DATA ----------
    async function refreshAll(){
      setLoading(true,'Cargando datos…');
      try{
        await Promise.all([
          loadCampaigns(),
          loadPieces(),
          loadChannelsSafe(),
          loadMetrics(),
          loadLeads()
        ]);
        updateSelects();
        bindFilters();
        applyPiecesFilters();
        applyLeadsFilters();
        applyMetricsFilters();
      }catch(err){
        console.error(err);
        showAlert('danger','Error de conexión','No se pudieron cargar los datos.');
      }finally{
        setLoading(false);
      }
    }

    // --- CAMPAIGNS ---
    async function loadCampaigns(){
      const { data, error } = await supabase
        .from(MAP.campaigns.table)
        .select('*')
        .order(MAP.campaigns.start, { ascending: true });

      if(error) throw error;
      state.campaigns = data || [];
      renderCampaigns(state.campaigns);
    }

    function renderCampaigns(rows){
      el('tblCampaigns').querySelector('tbody').innerHTML = rows.map(r=>{
        const bim = r[MAP.campaigns.bimester] ?? '—';
        const name = r[MAP.campaigns.name] ?? '—';
        const st = r[MAP.campaigns.status] ?? '—';
        const start = r[MAP.campaigns.start] ?? '';
        const end = r[MAP.campaigns.end] ?? '';
        const obj = r[MAP.campaigns.objective] ?? '';
        return `
          <tr>
            <td><span class="mono">${esc(bim)}</span></td>
            <td>
              <div class="fw-bold text-primary">${esc(name)}</div>
              <div class="mini truncate-2" style="max-width:520px">${esc(obj)}</div>
            </td>
            <td>${getStatusBadge(st)}</td>
            <td class="small text-muted">${esc(start)} → ${esc(end)}</td>
            <td class="small text-muted truncate-2" style="max-width:260px">${esc(obj)}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-light" onclick="editCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
              <button class="btn btn-sm btn-light ms-1" onclick="delCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editCamp = (id) => openCampaignModal(state.campaigns.find(x=>String(x[MAP.campaigns.id])===String(id)));
    window.delCamp = async (id) => {
      if(!confirm('¿Borrar campaña?')) return;
      setLoading(true,'Borrando…');
      try{
        const { error } = await supabase.from(MAP.campaigns.table).delete().eq(MAP.campaigns.id, id);
        if(error) throw error;
        await loadCampaigns();
        updateSelects();
        showAlert('success','Listo','Campaña eliminada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    };

    function openCampaignModal(row=null){
      el('c_id').value = row?.[MAP.campaigns.id] || '';
      el('c_bim').value = row?.[MAP.campaigns.bimester] || 'B1';
      el('c_status').value = row?.[MAP.campaigns.status] || 'planificada';
      el('c_budget').value = row?.[MAP.campaigns.budget] ?? 0;
      el('c_name').value = row?.[MAP.campaigns.name] || '';
      el('c_objective').value = row?.[MAP.campaigns.objective] || '';
      el('c_start').value = row?.[MAP.campaigns.start] || '';
      el('c_end').value = row?.[MAP.campaigns.end] || '';
      el('c_anchor').value = row?.[MAP.campaigns.anchor] || '';
      el('c_magnet').value = row?.[MAP.campaigns.magnet] || '';
      new bootstrap.Modal(el('campaignModal')).show();
    }

    el('btnSaveCampaign').addEventListener('click', async ()=>{
      const name = el('c_name').value.trim();
      const bim = el('c_bim').value;
      const start = el('c_start').value;
      const end = el('c_end').value;

      if(!name) return showAlert('warning','Validación','El nombre es obligatorio.');
      if(!bim) return showAlert('warning','Validación','El bimestre es obligatorio.');
      if(!start || !end) return showAlert('warning','Validación','Inicio y fin son obligatorios.');

      const payload = {
        [MAP.campaigns.name]: name,
        [MAP.campaigns.bimester]: bim,
        [MAP.campaigns.start]: start,
        [MAP.campaigns.end]: end,
        [MAP.campaigns.objective]: el('c_objective').value.trim() || null,
        [MAP.campaigns.anchor]: el('c_anchor').value.trim() || null,
        [MAP.campaigns.magnet]: el('c_magnet').value.trim() || null,
        [MAP.campaigns.budget]: Number(el('c_budget').value || 0),
        [MAP.campaigns.status]: el('c_status').value.trim() || null
      };

      const id = el('c_id').value;
      setLoading(true,'Guardando campaña…');
      try{
        const q = id
          ? supabase.from(MAP.campaigns.table).update(payload).eq(MAP.campaigns.id, id)
          : supabase.from(MAP.campaigns.table).insert(payload);
        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el('campaignModal'))?.hide();
        await loadCampaigns();
        updateSelects();
        applyPiecesFilters();
        applyLeadsFilters();
        showAlert('success','Guardado','Campaña actualizada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    el('btnSeed').addEventListener('click', async ()=>{
      if(!confirm('Esto creará 6 campañas base (B1..B6). ¿Continuar?')) return;
      setLoading(true,'Creando seed…');
      try{
        const year = 2026;
        const base = [
          { bim: 'B1', start: `${year}-01-01`, end: `${year}-02-28`, name: `Arranque ${year} | Chequeo Base` , anchor:'Inicio Año', magnet:'Quiz Cardiometabólico' },
          { bim: 'B2', start: `${year}-03-01`, end: `${year}-04-30`, name: `B2 ${year} | Control Metabólico` , anchor:'Día Mundial Salud', magnet:'Checklist hábitos' },
          { bim: 'B3', start: `${year}-05-01`, end: `${year}-06-30`, name: `B3 ${year} | Corazón Fuerte` , anchor:'Mes del corazón', magnet:'Mini-guía presión' },
          { bim: 'B4', start: `${year}-07-01`, end: `${year}-08-31`, name: `B4 ${year} | Prevención` , anchor:'Regreso a rutina', magnet:'Quiz riesgo' },
          { bim: 'B5', start: `${year}-09-01`, end: `${year}-10-31`, name: `B5 ${year} | Chequeo Integral` , anchor:'Mes prevención', magnet:'Promo chequeo' },
          { bim: 'B6', start: `${year}-11-01`, end: `${year}-12-31`, name: `B6 ${year} | Cierre & Retención` , anchor:'Fin de año', magnet:'Plan 2027' }
        ];

        for(const b of base){
          const payload = {
            [MAP.campaigns.name]: b.name,
            [MAP.campaigns.bimester]: b.bim,
            [MAP.campaigns.start]: b.start,
            [MAP.campaigns.end]: b.end,
            [MAP.campaigns.status]: 'planificada',
            [MAP.campaigns.anchor]: b.anchor,
            [MAP.campaigns.magnet]: b.magnet
          };
          const { error } = await supabase.from(MAP.campaigns.table).insert(payload);
          if(error) throw error;
        }

        await loadCampaigns();
        updateSelects();
        showAlert('success','Listo','Seed creado.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    // --- CHANNELS (SAFE) ---
    async function loadChannelsSafe(){
      // Si no existe tabla channels, no rompemos la app.
      try{
        const { data, error } = await supabase.from('channels').select('id,name').order('name');
        if(error) throw error;
        state.channels = data || [];
      }catch(_){
        state.channels = [];
      }
      renderChannelSelect();
    }

    function renderChannelSelect(){
      const opts = ['<option value="">(Sin canal)</option>'];
      if(state.channels.length){
        for(const c of state.channels){
          opts.push(`<option value="${c.id}">${esc(c.name)}</option>`);
        }
      }
      el('p_channel').innerHTML = opts.join('');
    }

    // --- PIECES ---
    async function loadPieces(){
      const { data, error } = await supabase
        .from(MAP.pieces.table)
        .select('*')
        .order(MAP.pieces.created_at, { ascending:false });

      if(error) throw error;
      state.pieces = data || [];
      renderPieces(state.pieces);
    }

    function renderPieces(rows){
      el('tblPieces').querySelector('tbody').innerHTML = rows.map(r=>{
        const camp = state.campaigns.find(c=>c[MAP.campaigns.id] == r[MAP.pieces.campaign_id]);
        const nm = r[MAP.pieces.name] ?? '—';
        const fmt = r[MAP.pieces.format] ?? '—';
        const st = r[MAP.pieces.status] ?? '—';
        return `
          <tr>
            <td>
              <div class="fw-bold text-primary">${esc(nm)}</div>
              <div class="mini truncate-2">${esc(r[MAP.pieces.hook] || '')}</div>
            </td>
            <td class="small text-muted">${esc(camp ? camp[MAP.campaigns.name] : 'Sin campaña')}</td>
            <td><span class="badge bg-light text-dark border fw-semibold">${esc(fmt)}</span></td>
            <td>${getStatusBadge(st)}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-light" onclick="editPiece('${r[MAP.pieces.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
              <button class="btn btn-sm btn-light ms-1" onclick="delPiece('${r[MAP.pieces.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editPiece = (id) => {
      const row = state.pieces.find(r=>String(r[MAP.pieces.id])===String(id));
      el('p_id').value = row?.[MAP.pieces.id] || '';
      el('p_campaign').value = row?.[MAP.pieces.campaign_id] || '';
      el('p_channel').value = row?.[MAP.pieces.channel_id] || '';
      el('p_name').value = row?.[MAP.pieces.name] || '';
      el('p_format').value = row?.[MAP.pieces.format] || '';
      el('p_pillar').value = row?.[MAP.pieces.pillar] || '';
      el('p_hook').value = row?.[MAP.pieces.hook] || '';
      el('p_visual').value = row?.[MAP.pieces.visual] || '';
      el('p_cta').value = row?.[MAP.pieces.cta] || '';
      el('p_adid').value = row?.[MAP.pieces.ad_id] || '';
      el('p_status').value = row?.[MAP.pieces.status] || 'idea';
      new bootstrap.Modal(el('pieceModal')).show();
    };

    window.delPiece = async (id) => {
      if(!confirm('¿Borrar pieza?')) return;
      setLoading(true,'Borrando…');
      try{
        const { error } = await supabase.from(MAP.pieces.table).delete().eq(MAP.pieces.id, id);
        if(error) throw error;
        await loadPieces();
        updateSelects();
        applyMetricsFilters();
        applyLeadsFilters();
        showAlert('success','Listo','Pieza eliminada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    };

    el('btnSavePiece').addEventListener('click', async ()=>{
      const name = el('p_name').value.trim();
      const format = el('p_format').value.trim();
      if(!name) return showAlert('warning','Validación','El nombre es obligatorio.');
      if(!format) return showAlert('warning','Validación','El formato es obligatorio (enum).');

      const payload = {
        [MAP.pieces.campaign_id]: el('p_campaign').value || null,
        [MAP.pieces.channel_id]: el('p_channel').value ? Number(el('p_channel').value) : null,
        [MAP.pieces.name]: name,
        [MAP.pieces.format]: format,
        [MAP.pieces.pillar]: el('p_pillar').value.trim() || null,
        [MAP.pieces.hook]: el('p_hook').value.trim() || null,
        [MAP.pieces.visual]: el('p_visual').value.trim() || null,
        [MAP.pieces.cta]: el('p_cta').value.trim() || null,
        [MAP.pieces.ad_id]: el('p_adid').value.trim() || null,
        [MAP.pieces.status]: el('p_status').value || null
      };

      const id = el('p_id').value;
      setLoading(true,'Guardando pieza…');
      try{
        const q = id
          ? supabase.from(MAP.pieces.table).update(payload).eq(MAP.pieces.id, id)
          : supabase.from(MAP.pieces.table).insert(payload);
        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el('pieceModal'))?.hide();
        await loadPieces();
        updateSelects();
        applyPiecesFilters();
        showAlert('success','Guardado','Pieza actualizada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    // --- METRICS ---
    async function loadMetrics(){
      const { data, error } = await supabase
        .from(MAP.metrics.table)
        .select('*')
        .order(MAP.metrics.date, { ascending:false });

      if(error) throw error;
      state.metrics = data || [];
      renderMetrics(state.metrics);
    }

    function renderMetrics(rows){
      el('tblMetrics').querySelector('tbody').innerHTML = rows.map(r=>{
        const p = state.pieces.find(x=>x[MAP.pieces.id] == r[MAP.metrics.piece_id]);
        const name = p ? p[MAP.pieces.name] : '—';
        const fmt = p ? p[MAP.pieces.format] : '';
        const dt = r[MAP.metrics.date] || '';
        const vol = r[MAP.metrics.volume] ?? 0;
        const inter = r[MAP.metrics.interactions] ?? 0;
        const spend = r[MAP.metrics.spend] ?? 0;
        return `
          <tr>
            <td class="text-start">
              <div class="fw-bold">${esc(name)}</div>
              <div class="mini">${esc(fmt)}</div>
            </td>
            <td class="mono">${esc(dt)}</td>
            <td>${esc(vol)}</td>
            <td>${esc(inter)}</td>
            <td>$ ${esc(spend)}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-light" onclick="editMetric('${r[MAP.metrics.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editMetric = (id) => {
      const r = state.metrics.find(x=>String(x[MAP.metrics.id])===String(id));
      el('mx_id').value = r?.[MAP.metrics.id] || '';
      el('mx_piece').value = r?.[MAP.metrics.piece_id] || '';
      el('mx_date').value = r?.[MAP.metrics.date] || '';
      el('mx_volume').value = r?.[MAP.metrics.volume] ?? 0;
      el('mx_interactions').value = r?.[MAP.metrics.interactions] ?? 0;
      el('mx_spend').value = r?.[MAP.metrics.spend] ?? 0;
      new bootstrap.Modal(el('metricModal')).show();
    };

    el('btnSaveMetric').addEventListener('click', async ()=>{
      const pieceId = el('mx_piece').value;
      const date = el('mx_date').value;
      if(!pieceId) return showAlert('warning','Validación','Selecciona una pieza.');
      if(!date) return showAlert('warning','Validación','La fecha es obligatoria.');

      const payload = {
        [MAP.metrics.piece_id]: pieceId,
        [MAP.metrics.date]: date,
        [MAP.metrics.volume]: Number(el('mx_volume').value || 0),
        [MAP.metrics.interactions]: Number(el('mx_interactions').value || 0),
        [MAP.metrics.spend]: Number(el('mx_spend').value || 0)
      };

      const id = el('mx_id').value;
      setLoading(true,'Guardando métrica…');
      try{
        // Tu tabla tiene UNIQUE(piece_id, date). Usamos upsert para evitar duplicados.
        const q = id
          ? supabase.from(MAP.metrics.table).update(payload).eq(MAP.metrics.id, id)
          : supabase.from(MAP.metrics.table).upsert(payload, { onConflict: `${MAP.metrics.piece_id},${MAP.metrics.date}` });

        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el('metricModal'))?.hide();
        await loadMetrics();
        applyMetricsFilters();
        showAlert('success','Guardado','Métrica actualizada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    // --- LEADS ---
    async function loadLeads(){
      const { data, error } = await supabase
        .from(MAP.leads.table)
        .select('*')
        .order(MAP.leads.created_at, { ascending:false });

      if(error) throw error;
      state.leads = data || [];
      renderLeads(state.leads);
    }

    function fmtLocalDT(ts){
      if(!ts) return '';
      try{
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${y}-${m}-${day} ${hh}:${mm}`;
      }catch(_){ return String(ts); }
    }

    function renderLeads(rows){
      el('tblLeads').querySelector('tbody').innerHTML = rows.map(r=>{
        const created = fmtLocalDT(r[MAP.leads.created_at]);
        const name = r[MAP.leads.full_name] || '—';
        const phone = r[MAP.leads.phone] || '';
        const email = r[MAP.leads.email] || '';
        const triage = r[MAP.leads.triage] || '—';
        const out = r[MAP.leads.outcome] || '—';
        return `
          <tr>
            <td class="small text-muted">${esc(created)}</td>
            <td class="fw-bold text-primary">${esc(name)}</td>
            <td class="small">
              <div>${esc(phone)}</div>
              <div class="text-muted">${esc(email)}</div>
            </td>
            <td>${getStatusBadge(triage)}</td>
            <td>${getStatusBadge(out)}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-light" onclick="editLead('${r[MAP.leads.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
              <button class="btn btn-sm btn-light ms-1" onclick="delLead('${r[MAP.leads.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editLead = (id) => {
      const r = state.leads.find(x=>String(x[MAP.leads.id])===String(id));
      el('ld_id').value = r?.[MAP.leads.id] || '';
      el('ld_name').value = r?.[MAP.leads.full_name] || '';
      el('ld_phone').value = r?.[MAP.leads.phone] || '';
      el('ld_email').value = r?.[MAP.leads.email] || '';
      el('ld_source').value = r?.[MAP.leads.source] || '';
      el('ld_campaign').value = r?.[MAP.leads.campaign_id] || '';
      el('ld_piece').value = r?.[MAP.leads.piece_id] || '';
      el('ld_triage').value = r?.[MAP.leads.triage] || '';
      el('ld_outcome').value = r?.[MAP.leads.outcome] || '';
      el('ld_notes').value = r?.[MAP.leads.triage_notes] || '';
      // appointment_date is timestamptz; convert to datetime-local (approx)
      const ap = r?.[MAP.leads.appointment];
      el('ld_appt').value = ap ? new Date(ap).toISOString().slice(0,16) : '';
      el('ld_ticket').value = r?.[MAP.leads.ticket] ?? 0;
      el('ld_retained').value = String(r?.[MAP.leads.retained] ?? false);
      new bootstrap.Modal(el('leadModal')).show();
    };

    window.delLead = async (id) => {
      if(!confirm('¿Borrar lead?')) return;
      setLoading(true,'Borrando…');
      try{
        const { error } = await supabase.from(MAP.leads.table).delete().eq(MAP.leads.id, id);
        if(error) throw error;
        await loadLeads();
        applyLeadsFilters();
        showAlert('success','Listo','Lead eliminado.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    };

    el('btnSaveLead').addEventListener('click', async ()=>{
      const fullName = el('ld_name').value.trim();
      if(!fullName) return showAlert('warning','Validación','El nombre es obligatorio.');

      const appt = el('ld_appt').value ? new Date(el('ld_appt').value).toISOString() : null;

      const payload = {
        [MAP.leads.full_name]: fullName,
        [MAP.leads.phone]: el('ld_phone').value.trim() || null,
        [MAP.leads.email]: el('ld_email').value.trim() || null,
        [MAP.leads.source]: el('ld_source').value.trim() || null,
        [MAP.leads.campaign_id]: el('ld_campaign').value || null,
        [MAP.leads.piece_id]: el('ld_piece').value || null,
        [MAP.leads.triage]: el('ld_triage').value.trim() || null,
        [MAP.leads.triage_notes]: el('ld_notes').value.trim() || null,
        [MAP.leads.outcome]: el('ld_outcome').value.trim() || null,
        [MAP.leads.appointment]: appt,
        [MAP.leads.ticket]: Number(el('ld_ticket').value || 0),
        [MAP.leads.retained]: (el('ld_retained').value === 'true')
      };

      const id = el('ld_id').value;
      setLoading(true,'Guardando lead…');
      try{
        const q = id
          ? supabase.from(MAP.leads.table).update(payload).eq(MAP.leads.id, id)
          : supabase.from(MAP.leads.table).insert(payload);
        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el('leadModal'))?.hide();
        await loadLeads();
        applyLeadsFilters();
        showAlert('success','Guardado','Lead actualizado.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        setLoading(false);
      }
    });

    // ---------- FILTERS / SELECTS ----------
    function updateSelects(){
      const campFilter = ['<option value="">Todas</option>']
        .concat(state.campaigns.map(c=>`<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`))
        .join('');

      el('fCamp').innerHTML = campFilter;
      el('lCamp').innerHTML = campFilter.replace('Todas','(Todas)');
      el('p_campaign').innerHTML = ['<option value="">(Sin campaña)</option>']
        .concat(state.campaigns.map(c=>`<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`))
        .join('');
      el('ld_campaign').innerHTML = el('p_campaign').innerHTML;

      const pieceOpts = ['<option value="">(Todas)</option>']
        .concat(state.pieces.map(p=>`<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`))
        .join('');

      el('mPiece').innerHTML = pieceOpts;
      el('mx_piece').innerHTML = pieceOpts.replace('(Todas)','(Seleccionar)');
      el('lPiece').innerHTML = pieceOpts;
      el('ld_piece').innerHTML = ['<option value="">(Sin pieza)</option>']
        .concat(state.pieces.map(p=>`<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`))
        .join('');
    }

    function applyPiecesFilters(){
      const camp = el('fCamp').value;
      const bim = el('fBim').value;
      const st = el('fPStatus').value;
      const q = el('fQ').value.trim().toLowerCase();

      const filtered = state.pieces.filter(p=>{
        if(camp && p[MAP.pieces.campaign_id] != camp) return false;
        if(st && String(p[MAP.pieces.status] || '') !== st) return false;

        if(bim){
          const c = state.campaigns.find(x=>x[MAP.campaigns.id] == p[MAP.pieces.campaign_id]);
          if(!c || String(c[MAP.campaigns.bimester]) !== bim) return false;
        }

        if(q){
          const blob = JSON.stringify({
            name: p[MAP.pieces.name],
            format: p[MAP.pieces.format],
            pillar: p[MAP.pieces.pillar],
            hook: p[MAP.pieces.hook],
            cta: p[MAP.pieces.cta],
            status: p[MAP.pieces.status]
          }).toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      renderPieces(filtered);
    }

    function applyLeadsFilters(){
      const camp = el('lCamp').value;
      const piece = el('lPiece').value;
      const q = el('lQ').value.trim().toLowerCase();

      const filtered = state.leads.filter(l=>{
        if(camp && l[MAP.leads.campaign_id] != camp) return false;
        if(piece && l[MAP.leads.piece_id] != piece) return false;

        if(q){
          const blob = JSON.stringify({
            name: l[MAP.leads.full_name],
            phone: l[MAP.leads.phone],
            email: l[MAP.leads.email],
            source: l[MAP.leads.source],
            triage: l[MAP.leads.triage],
            outcome: l[MAP.leads.outcome]
          }).toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      renderLeads(filtered);
    }

    function applyMetricsFilters(){
      const piece = el('mPiece').value;
      const from = el('mFrom').value;
      const to = el('mTo').value;

      const filtered = state.metrics.filter(m=>{
        if(piece && m[MAP.metrics.piece_id] != piece) return false;
        const d = String(m[MAP.metrics.date] || '');
        if(from && d < from) return false;
        if(to && d > to) return false;
        return true;
      });

      renderMetrics(filtered);
    }

    function bindFilters(){
      el('btnNewCampaign').onclick = ()=> openCampaignModal();
      el('btnNewPiece').onclick = ()=>{
        el('p_id').value = '';
        el('p_campaign').value = '';
        el('p_channel').value = '';
        el('p_name').value = '';
        el('p_format').value = '';
        el('p_pillar').value = '';
        el('p_hook').value = '';
        el('p_visual').value = '';
        el('p_cta').value = '';
        el('p_adid').value = '';
        el('p_status').value = 'idea';
        new bootstrap.Modal(el('pieceModal')).show();
      };
      el('btnNewMetric').onclick = ()=>{
        el('mx_id').value = '';
        el('mx_piece').value = '';
        el('mx_date').value = new Date().toISOString().slice(0,10);
        el('mx_volume').value = 0;
        el('mx_interactions').value = 0;
        el('mx_spend').value = 0;
        new bootstrap.Modal(el('metricModal')).show();
      };
      el('btnNewLead').onclick = ()=>{
        el('ld_id').value = '';
        el('ld_name').value = '';
        el('ld_phone').value = '';
        el('ld_email').value = '';
        el('ld_source').value = '';
        el('ld_campaign').value = '';
        el('ld_piece').value = '';
        el('ld_triage').value = '';
        el('ld_outcome').value = '';
        el('ld_appt').value = '';
        el('ld_ticket').value = 0;
        el('ld_retained').value = 'false';
        el('ld_notes').value = '';
        new bootstrap.Modal(el('leadModal')).show();
      };

      el('btnReloadCampaigns').onclick = async ()=>{ setLoading(true,'Actualizando…'); try{ await loadCampaigns(); updateSelects(); }catch(e){ showAlert('danger','Error',humanize(e)); }finally{ setLoading(false);} };
      el('btnReloadPieces').onclick = async ()=>{ setLoading(true,'Actualizando…'); try{ await loadPieces(); updateSelects(); applyPiecesFilters(); }catch(e){ showAlert('danger','Error',humanize(e)); }finally{ setLoading(false);} };
      el('btnReloadMetrics').onclick = async ()=>{ setLoading(true,'Actualizando…'); try{ await loadMetrics(); applyMetricsFilters(); }catch(e){ showAlert('danger','Error',humanize(e)); }finally{ setLoading(false);} };
      el('btnReloadLeads').onclick = async ()=>{ setLoading(true,'Actualizando…'); try{ await loadLeads(); applyLeadsFilters(); }catch(e){ showAlert('danger','Error',humanize(e)); }finally{ setLoading(false);} };

      // filtros piezas
      ['fCamp','fBim','fPStatus'].forEach(id => el(id).addEventListener('change', applyPiecesFilters));
      el('fQ').addEventListener('input', applyPiecesFilters);

      // filtros leads
      ['lCamp','lPiece'].forEach(id => el(id).addEventListener('change', applyLeadsFilters));
      el('lQ').addEventListener('input', applyLeadsFilters);

      // filtros metrics
      ['mPiece','mFrom','mTo'].forEach(id => el(id).addEventListener('change', applyMetricsFilters));
    }

    // ---------- START ----------
    init();
  </script>
</body>
</html>
