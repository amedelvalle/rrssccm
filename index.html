<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grupo CCM | Plan Digital 2026</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --r: 12px;
    }

    body{ 
      background: var(--bg-body); 
      font-family: 'Inter', sans-serif; 
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .navbar-ccm {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      padding: 0.75rem 0;
    }
    .brand-title { font-weight: 700; font-size: 1rem; color: #111827; letter-spacing: -0.025em; }
    .brand-sub { font-size: 0.75rem; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .brand-icon { width: 32px; height: 32px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary); }

    .app-shell{ max-width: 1400px; }
    .cardx { 
      background: var(--bg-card); 
      border: 1px solid var(--border-color); 
      border-radius: var(--r); 
      box-shadow: var(--shadow-sm); 
      overflow: hidden; 
      transition: box-shadow 0.2s;
    }
    .cardx:hover { box-shadow: var(--shadow-md); }

    .section-title { font-weight: 700; color: #111827; letter-spacing: -0.025em; font-size: 1.25rem; }
    .mini { color: var(--text-muted); font-size: 0.875rem; }
    .mono { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.85em; color: var(--primary); background: #eff6ff; padding: 2px 6px; border-radius: 4px; }

    .btn { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem; border: 1px solid transparent; transition: all 0.2s; }
    .btn-primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); transform: translateY(-1px); }
    .btn-light { background: #fff; border-color: var(--border-color); color: #374151; }
    .btn-light:hover { background: #f9fafb; border-color: #d1d5db; color: #111827; }
    
    .nav-tabs { border-bottom: 1px solid var(--border-color); gap: 1rem; }
    .nav-tabs .nav-link { border: none; color: var(--text-muted); font-weight: 500; padding: 0.75rem 0.25rem; background: transparent; transition: color 0.2s; }
    .nav-tabs .nav-link:hover { color: var(--primary); }
    .nav-tabs .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); background: transparent; }

    .table thead th {
      background: #f9fafb;
      color: #6b7280;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
    }
    .table tbody td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.875rem; }
    .table-hover tbody tr:hover { background: #f9fafb; }
    
    .badge-status { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .badge-status::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .st-draft { background: #f3f4f6; color: #4b5563; }
    .st-scheduled { background: #eff6ff; color: #2563eb; }
    .st-published { background: #ecfdf5; color: #059669; }
    .st-paused { background: #fffbeb; color: #d97706; }
    .st-closed { background: #fef2f2; color: #dc2626; }

    .form-control, .form-select { border-radius: 8px; border-color: var(--border-color); padding: 0.6rem 0.75rem; font-size: 0.875rem; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

    .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .loading .box { background: white; padding: 20px 40px; border-radius: 12px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 10px; }
    
    .alert-stack { position: fixed; top: 80px; right: 20px; z-index: 2500; display: flex; flex-direction: column; gap: 10px; width: 380px; }
    .alert-card { background: white; border: 1px solid var(--border-color); border-left: 4px solid var(--primary); border-radius: 8px; box-shadow: var(--shadow-md); padding: 12px 16px; display: flex; gap: 12px; align-items: start; animation: slideIn 0.3s ease; }
    .alert-card.success { border-left-color: #059669; }
    .alert-card.danger { border-left-color: #dc2626; }
    
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .hidden { display: none !important; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>

<body>
  <div class="alert-stack" id="alertStack"></div>

  <nav class="navbar navbar-ccm sticky-top">
    <div class="container-fluid app-shell px-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-icon"><i class="bi bi-grid-fill"></i></div>
        <div class="min-w-0">
          <div class="brand-title">Grupo CCM</div>
          <div class="brand-sub">Plan Digital 2026</div>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge bg-light text-dark border fw-normal py-2 px-3 rounded-pill" id="whoami">Cargando...</span>
        <button class="btn btn-light btn-sm" id="btnLogout" disabled><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell my-5 px-4">

    <div id="loginView" class="cardx p-5 mx-auto" style="max-width: 480px;">
      <div class="text-center mb-4">
        <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3" style="width: 48px; height: 48px;"><i class="bi bi-shield-lock-fill fs-5"></i></div>
        <h4 class="fw-bold">Iniciar Sesión</h4>
        <p class="text-muted small">Accede al panel de control de Marketing</p>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold small">Correo electrónico</label>
        <input type="email" class="form-control" id="loginEmail" placeholder="nombre@grupoccm.com" autocomplete="username">
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold small">Contraseña</label>
        <input type="password" class="form-control" id="loginPass" placeholder="••••••••" autocomplete="current-password">
      </div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-link px-0 small text-decoration-none" id="btnForgotPass" type="button">¿Olvidaste tu clave?</button>
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSignIn">Ingresar al Sistema</button>
      <div class="text-center mt-3 small text-muted">Powered by Supabase</div>
    </div>

    <div id="appView" class="hidden">
      <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
        <div>
          <h3 class="fw-bold mb-1">Panel de Control</h3>
          <div class="mini">Gestión integral de campañas y resultados.</div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-light bg-white" id="btnSeed"><i class="bi bi-database-add me-2 text-muted"></i>Seed Inicial</button>
          <div class="vr mx-2 text-muted"></div>
          <button class="btn btn-primary" id="btnNewCampaign"><i class="bi bi-plus-lg me-1"></i>Campaña</button>
          <button class="btn btn-primary" id="btnNewPiece"><i class="bi bi-plus-lg me-1"></i>Pieza</button>
          <button class="btn btn-primary" id="btnNewMetric"><i class="bi bi-plus-lg me-1"></i>Métrica</button>
          <button class="btn btn-primary" id="btnNewLead"><i class="bi bi-plus-lg me-1"></i>Lead</button>
        </div>
      </div>

      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCampaigns" type="button" role="tab">
            <i class="bi bi-calendar-range me-2"></i>Campañas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPieces" type="button" role="tab">
            <i class="bi bi-grid me-2"></i>Contenido (Piezas)
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMetrics" type="button" role="tab">
            <i class="bi bi-bar-chart me-2"></i>Métricas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLeads" type="button" role="tab">
            <i class="bi bi-people me-2"></i>Leads & CRM
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <div class="tab-pane fade show active" id="tabCampaigns" role="tabpanel">
          <div class="cardx">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-light bg-opacity-50">
              <span class="fw-bold small text-uppercase text-muted tracking-wide">Listado de Campañas</span>
              <button class="btn btn-sm btn-white border" id="btnReloadCampaigns"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblCampaigns">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Bimestre</th>
                    <th>Año</th>
                    <th>Nombre</th>
                    <th>Objetivo</th>
                    <th>Vigencia</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabPieces" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Bimestre</label>
                  <select class="form-select" id="fBim">
                    <option value="">Todos</option>
                    <option value="1">B1</option><option value="2">B2</option><option value="3">B3</option>
                    <option value="4">B4</option><option value="5">B5</option><option value="6">B6</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="fCamp"></select>
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Canal</label>
                  <select class="form-select" id="fChannel">
                    <option value="">Todos</option>
                    <option>Instagram</option><option>Facebook</option><option>YouTube</option><option>Spotify</option><option>Blog</option><option>WhatsApp</option>
                  </select>
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Estado</label>
                  <select class="form-select" id="fStatus">
                    <option value="">Todos</option>
                    <option>Borrador</option><option>Programado</option><option>Publicado</option><option>Pausado</option>
                  </select>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input class="form-control border-start-0 ps-0" id="fQ" placeholder="Buscar...">
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblPieces">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Campaña</th>
                    <th>Canal</th>
                    <th>Formato</th>
                    <th>Embudo</th>
                    <th>Estado</th>
                    <th>Hook</th>
                    <th>Fecha</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="p-2 border-top bg-light text-end">
                <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadPieces"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla</button>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabMetrics" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-5">
                  <label class="form-label mini fw-bold">Pieza de Contenido</label>
                  <select class="form-select" id="mPiece"></select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Desde</label>
                  <input type="date" class="form-control" id="mFrom">
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Hasta</label>
                  <input type="date" class="form-control" id="mTo">
                </div>
                 <div class="col-12 col-md-1 d-flex align-items-end">
                    <button class="btn btn-light w-100" id="btnReloadMetrics"><i class="bi bi-arrow-clockwise"></i></button>
                 </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblMetrics">
                <thead class="text-center">
                  <tr>
                    <th class="text-start">Pieza</th>
                    <th>Fecha</th>
                    <th>Impres.</th>
                    <th>Alcance</th>
                    <th>Plays</th>
                    <th>Leads</th>
                    <th>Citas</th>
                    <th>Showups</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabLeads" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="lCamp"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="lPiece"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <input class="form-control" id="lQ" placeholder="Nombre, teléfono...">
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblLeads">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Fecha</th>
                    <th>Origen</th>
                    <th>Contexto</th>
                    <th>Nombre</th>
                    <th>Teléfono</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
             <div class="p-2 border-top bg-light text-end">
                <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadLeads"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="forgotPassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Recuperar Acceso</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small">Ingresa tu correo y te enviaremos un enlace mágico.</p>
          <input type="email" class="form-control mb-3" id="fp_email" placeholder="tu@correo.com">
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" id="btnSendResetEmail">Enviar enlace</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="setNewPassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Nueva Contraseña</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
             <label class="form-label small fw-bold">Contraseña nueva</label>
             <input type="password" class="form-control" id="np1">
          </div>
          <div class="mb-4">
             <label class="form-label small fw-bold">Confirmar</label>
             <input type="password" class="form-control" id="np2">
          </div>
          <button class="btn btn-primary w-100" id="btnSetNewPass">Actualizar Password</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="campaignModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="campaignModalTitle">Campaña</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="c_id">
          <div class="row g-3">
            <div class="col-6">
              <label class="form-label small fw-bold">Bimestre</label>
              <select class="form-select" id="c_bim">
                <option value="1">B1</option><option value="2">B2</option><option value="3">B3</option>
                <option value="4">B4</option><option value="5">B5</option><option value="6">B6</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Año</label>
              <input class="form-control" id="c_year" value="2026">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Nombre de Campaña</label>
              <input class="form-control" id="c_name" placeholder="Ej: Diabetes Control">
            </div>
            <div class="col-12">
               <label class="form-label small fw-bold">Código (Opcional)</label>
               <input class="form-control font-monospace text-muted" id="c_code" placeholder="Generado automáticamente">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Objetivo</label>
              <input class="form-control" id="c_objective" placeholder="Ej: Generar 50 leads cualificados">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Inicio</label>
              <input type="date" class="form-control" id="c_start">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Fin</label>
              <input type="date" class="form-control" id="c_end">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveCampaign">Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="pieceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="pieceModalTitle">Pieza de Contenido</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="p_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Campaña Asociada</label>
              <select class="form-select" id="p_campaign"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Canal</label>
              <select class="form-select" id="p_channel">
                <option>Instagram</option><option>Facebook</option><option>YouTube</option><option>Spotify</option><option>Blog</option><option>WhatsApp</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small fw-bold">Formato</label>
              <input class="form-control" id="p_format" placeholder="Reel, Story...">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small fw-bold">Etapa Funnel</label>
              <input class="form-control" id="p_funnel" placeholder="Awareness...">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small fw-bold">Estado</label>
              <select class="form-select" id="p_status">
                <option>Borrador</option><option>Programado</option><option>Publicado</option><option>Pausado</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
               <label class="form-label small fw-bold">Código</label>
               <input class="form-control font-monospace" id="p_code" placeholder="Auto">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Hook (Gancho)</label>
              <input class="form-control fw-semibold" id="p_hook" placeholder="Título atractivo...">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Copy / Caption</label>
              <textarea class="form-control" id="p_copy" rows="4"></textarea>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small fw-bold">Programación</label>
              <input type="datetime-local" class="form-control" id="p_scheduled">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button class="btn btn-primary" id="btnSavePiece">Guardar Pieza</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="metricModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="metricModalTitle">Registro de Métricas</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="mx_id">
          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label small fw-bold">Pieza</label>
              <select class="form-select" id="mx_piece"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Fecha de Corte</label>
              <input type="date" class="form-control" id="mx_date">
            </div>
            
            <div class="col-12"><hr class="text-muted"></div>

            <div class="col-6 col-md-2 text-center">
                <label class="form-label small text-muted">Impresiones</label>
                <input class="form-control text-center fw-bold" id="mx_impressions" type="number" min="0">
            </div>
            <div class="col-6 col-md-2 text-center">
                <label class="form-label small text-muted">Alcance</label>
                <input class="form-control text-center fw-bold" id="mx_reach" type="number" min="0">
            </div>
             <div class="col-6 col-md-2 text-center">
                <label class="form-label small text-muted">Plays</label>
                <input class="form-control text-center fw-bold" id="mx_plays" type="number" min="0">
            </div>
             <div class="col-6 col-md-2 text-center">
                <label class="form-label small text-primary fw-bold">Leads</label>
                <input class="form-control text-center fw-bold border-primary" id="mx_leads" type="number" min="0">
            </div>
             <div class="col-6 col-md-2 text-center">
                <label class="form-label small text-muted">Citas</label>
                <input class="form-control text-center fw-bold" id="mx_appointments" type="number" min="0">
            </div>
             <div class="col-6 col-md-2 text-center">
                <label class="form-label small text-success fw-bold">Showups</label>
                <input class="form-control text-center fw-bold border-success" id="mx_showups" type="number" min="0">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveMetric">Guardar Métrica</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="leadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="leadModalTitle">Gestión de Lead</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="ld_id">
          <div class="row g-3">
            <div class="col-md-4">
               <label class="form-label small fw-bold">Origen</label>
               <input class="form-control" id="ld_source" placeholder="Ej: Instagram DM">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Campaña</label>
              <select class="form-select" id="ld_campaign"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Pieza (Opcional)</label>
              <select class="form-select" id="ld_piece"></select>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Nombre Completo</label>
              <input class="form-control" id="ld_name">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Teléfono / Contacto</label>
              <input class="form-control" id="ld_phone">
            </div>

            <div class="col-md-6">
               <label class="form-label small fw-bold">Interés Principal</label>
               <input class="form-control" id="ld_interest">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Estado del Lead</label>
              <select class="form-select" id="ld_status">
                <option>Nuevo</option><option>Contactado</option><option>En seguimiento</option><option>Cerrado</option><option>Descartado</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Notas</label>
              <textarea class="form-control" id="ld_notes" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveLead">Guardar Lead</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="box">
      <div class="spinner-border text-primary" role="status"></div>
      <div class="fw-bold">Procesando...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === CONFIG APP (GitHub Pages) ===
    const APP_URL = "https://amedelvalle.github.io/rrssccm/";

    // === CONFIG SUPABASE ===
    // Si este proyecto NO es el tuyo, reemplaza por tu URL real (Settings -> API -> Project URL)
    const SUPABASE_URL = "https://rofwgcrsfrovspiholbo.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_M7gyUpsbCPRopdrmDjEeLA_SHXlnP-C";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // MANTENIENDO TU LÓGICA DE MAPEO INTACTA
    const MAP = {
      campaigns: { table:'campaigns', id:'id', code:'code', bimester:'bimester', year:'year', name:'name', objective:'objective', start:'start_date', end:'end_date', created_at:'created_at' },
      pieces:    { table:'pieces', id:'id', code:'code', campaign_id:'campaign_id', channel:'channel', format:'format', funnel:'funnel_stage', status:'status', hook:'hook', copy:'copy_caption', scheduled:'scheduled_at', created_at:'created_at' },
      metrics:   { table:'piece_metrics', id:'id', piece_id:'piece_id', date:'cut_date', impressions:'impressions', reach:'reach', plays:'plays', leads:'leads', appointments:'appointments', showups:'showups' },
      leads:     { table:'leads', id:'id', code:'code', created_at:'created_at', source:'source_channel', campaign_id:'campaign_id', piece_id:'piece_id', name:'name', phone:'phone', interest:'interest', status:'status', notes:'note' }
    };

    const el = (id) => document.getElementById(id);
    const showLoading = (v) => el('loading').style.display = v ? 'flex' : 'none';
    const esc = (s) => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    const fmtDT = (v) => { if(!v) return ''; try{ const d=new Date(v); return d.toISOString().slice(0,16).replace('T',' '); }catch(_){ return String(v);} };

    function getStatusBadge(status) {
      const s = String(status || '').toLowerCase();
      let cls = 'st-draft';
      if(s.includes('publicado') || s.includes('contactado')) cls = 'st-published';
      if(s.includes('programado') || s.includes('seguimiento')) cls = 'st-scheduled';
      if(s.includes('pausado')) cls = 'st-paused';
      if(s.includes('cerrado') || s.includes('descartado')) cls = 'st-closed';
      return `<span class="badge-status ${cls}">${esc(status)}</span>`;
    }

    function getChannelIcon(channel) {
      const c = String(channel || '').toLowerCase();
      let icon = 'bi-globe', color = '#6b7280';
      if(c.includes('insta')) { icon='bi-instagram'; color='#e1306c'; }
      else if(c.includes('face')) { icon='bi-facebook'; color='#1877f2'; }
      else if(c.includes('youtu')) { icon='bi-youtube'; color='#ff0000'; }
      else if(c.includes('whats')) { icon='bi-whatsapp'; color='#25d366'; }
      else if(c.includes('spoti')) { icon='bi-spotify'; color='#1db954'; }
      return `<i class="bi ${icon} me-1" style="color:${color}"></i> ${esc(channel)}`;
    }

    function showAlert(type, title, message, ttlMs = 4500){
      const stack = el('alertStack');
      const card = document.createElement('div');
      card.className = `alert-card ${type || 'info'}`;
      const icon = type === 'success' ? 'bi-check-circle-fill text-success' :
                   type === 'warning' ? 'bi-exclamation-triangle-fill text-warning' :
                   type === 'danger'  ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary';
      
      card.innerHTML = `
        <i class="${icon} fs-5 mt-1"></i>
        <div class="flex-grow-1">
          <div class="fw-bold text-dark">${esc(title || 'Aviso')}</div>
          <div class="small text-secondary">${esc(message || '')}</div>
        </div>
        <button class="btn-close ms-2" aria-label="cerrar" style="font-size:0.7em"></button>
      `;
      stack.appendChild(card);
      const close = () => { card.style.opacity='0'; setTimeout(()=>card.remove(),300); };
      card.querySelector('.btn-close').addEventListener('click', close);
      if (ttlMs) setTimeout(() => { if(card.isConnected) close(); }, ttlMs);
    }

    function humanize(err){
      const raw = (err?.message || err?.error_description || String(err || ''));
      const low = raw.toLowerCase();
      if (low.includes('invalid login credentials')) return 'Correo o contraseña incorrectos.';
      if (low.includes('email not confirmed')) return 'Tu correo aún no está confirmado.';
      return raw;
    }

    function openSetNewPasswordModal(){
      // Asegura vista correcta
      el('loginView').classList.add('hidden');
      el('appView').classList.add('hidden');
      el('whoami').textContent = 'Recuperación';
      el('btnLogout').disabled = true;

      // Abre modal
      const m = new bootstrap.Modal(el('setNewPassModal'), { backdrop: 'static', keyboard: false });
      m.show();
      showAlert('info','Recuperación','Define tu nueva contraseña.');
    }

    const state = { user:null, profile:null, campaigns:[], pieces:[], metrics:[], leads:[] };

    function campaignLabel(c){
      const name = c[MAP.campaigns.name] ?? '';
      return name.trim();
    }
    function pieceLabel(p){
      const code = p[MAP.pieces.code] ?? '—';
      const hook = (p[MAP.pieces.hook] ?? '').slice(0,30);
      return `${code} · ${hook}`.trim();
    }

    async function handleSession(session){
      state.user = session?.user || null;
      if (!state.user){
        el('loginView').classList.remove('hidden');
        el('appView').classList.add('hidden');
        el('whoami').textContent = '...';
        el('btnLogout').disabled = true;
        return;
      }
      try{
        const { data: prof } = await supabase.from('profiles').select('*').eq('id', state.user.id).maybeSingle();
        state.profile = prof || null;
      }catch(_){ state.profile = null; }
      
      el('loginView').classList.add('hidden');
      el('appView').classList.remove('hidden');
      el('whoami').textContent = state.profile?.display_name || state.user.email || 'Usuario';
      el('btnLogout').disabled = false;
      
      if(state.campaigns.length === 0) await refreshAll();
    }

    async function init(){
      // Si vienes desde el correo de recovery (Supabase) muchas veces trae hash con type=recovery
      const hash = window.location.hash || '';
      if (hash.toLowerCase().includes('type=recovery')) {
        openSetNewPasswordModal();
      }

      const { data } = await supabase.auth.getSession();
      await handleSession(data.session);

      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'PASSWORD_RECOVERY') openSetNewPasswordModal();
        await handleSession(session);
      });

      bindFilters();
    }

    // Login
    el('btnSignIn').addEventListener('click', async ()=>{
      const email = el('loginEmail').value.trim();
      const password = el('loginPass').value;
      if (!email || !password) return showAlert('warning','Faltan datos','Ingresa tu correo y contraseña.');
      showLoading(true);
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        showAlert('success','Bienvenido','Iniciando sesión...');
      }catch(err){ showAlert('danger','Error', humanize(err)); }
      finally{ showLoading(false); }
    });

    el('btnLogout').addEventListener('click', async () => {
      showLoading(true);
      await supabase.auth.signOut();
      window.location.reload(); 
    });

    el('btnForgotPass').addEventListener('click', () => new bootstrap.Modal(el('forgotPassModal')).show());
    
    el('btnSendResetEmail').addEventListener('click', async ()=>{
      const email = el('fp_email').value.trim();
      if (!email) return showAlert('warning','Email requerido','Ingresa tu correo.');
      showLoading(true);
      try{
        // Forzar tu GitHub Pages (evita problemas si abres desde otro dominio o file://)
        const redirectTo = APP_URL;
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
        if(error) throw error;
        bootstrap.Modal.getInstance(el('forgotPassModal'))?.hide();
        showAlert('success','Enviado','Revisa tu bandeja de entrada.');
      }catch(err){ showAlert('danger','Error', humanize(err)); }
      finally{ showLoading(false); }
    });

    el('btnSetNewPass').addEventListener('click', async ()=>{
      const p1 = el('np1').value; const p2 = el('np2').value;
      if (!p1 || p1.length < 6) return showAlert('warning','Seguridad','Mínimo 6 caracteres.');
      if (p1 !== p2) return showAlert('warning','Error','Las contraseñas no coinciden.');
      showLoading(true);
      try{
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if (error) throw error;
        bootstrap.Modal.getInstance(el('setNewPassModal'))?.hide();
        showAlert('success','Listo','Contraseña actualizada. Puedes iniciar sesión.');
        // Limpia hash para evitar reabrir modal si refrescan
        if (window.location.hash) history.replaceState(null, '', window.location.pathname + window.location.search);
      }catch(err){ showAlert('danger','Error', humanize(err)); }
      finally{ showLoading(false); }
    });

    // --- DATA ---
    async function refreshAll(){
      showLoading(true);
      try{
        await Promise.all([loadCampaigns(), loadPieces(), loadMetrics(), loadLeads()]);
        applyPiecesFilters();
        applyLeadsFilters();
      }catch(err){
        console.error(err);
        showAlert('danger','Error de conexión','No se pudieron cargar los datos.');
      }finally{
        showLoading(false);
      }
    }

    // -- CAMPAIGNS --
    async function loadCampaigns(){
      const { data, error } = await supabase.from(MAP.campaigns.table).select('*').order(MAP.campaigns.created_at, { ascending:false });
      if(error){ showAlert('danger','Error', error.message); return; }
      state.campaigns = data || [];
      renderCampaigns(state.campaigns);
      updateSelects();
    }
    
    function renderCampaigns(rows){
      el('tblCampaigns').querySelector('tbody').innerHTML = rows.map(r => `
        <tr>
          <td><span class="mono">${esc(r[MAP.campaigns.code] ?? '—')}</span></td>
          <td><span class="badge bg-light text-dark border">B${esc(r[MAP.campaigns.bimester])}</span></td>
          <td>${esc(r[MAP.campaigns.year])}</td>
          <td class="fw-bold text-primary">${esc(r[MAP.campaigns.name])}</td>
          <td class="text-muted small text-truncate" style="max-width:150px;">${esc(r[MAP.campaigns.objective])}</td>
          <td class="small">${fmtDT(r[MAP.campaigns.start]).split(' ')[0]}</td>
          <td class="text-end">
             <button class="btn btn-sm btn-white border" onclick="editCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
             <button class="btn btn-sm btn-white border ms-1" onclick="delCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
          </td>
        </tr>
      `).join('');
    }

    window.editCamp = (id) => openCampaignModal(state.campaigns.find(x => String(x[MAP.campaigns.id]) === String(id)));
    window.delCamp = async (id) => {
      if(!confirm('¿Borrar campaña?')) return;
      const { error } = await supabase.from(MAP.campaigns.table).delete().eq(MAP.campaigns.id, id);
      if(error) return showAlert('danger','Error', error.message);
      await loadCampaigns();
      await loadPieces(); // por dependencias
      showAlert('success','Eliminado','Campaña eliminada.');
    };

    function openCampaignModal(row=null){
      el('c_id').value = row?.[MAP.campaigns.id] || '';
      el('c_bim').value = row?.[MAP.campaigns.bimester] || '1';
      el('c_year').value = row?.[MAP.campaigns.year] || '2026';
      el('c_name').value = row?.[MAP.campaigns.name] || '';
      el('c_code').value = row?.[MAP.campaigns.code] || '';
      el('c_objective').value = row?.[MAP.campaigns.objective] || '';
      el('c_start').value = row?.[MAP.campaigns.start] || '';
      el('c_end').value = row?.[MAP.campaigns.end] || '';
      new bootstrap.Modal(el('campaignModal')).show();
    }

    el('btnSaveCampaign').onclick = async () => {
       const payload = {};
       payload[MAP.campaigns.name] = el('c_name').value.trim();
       payload[MAP.campaigns.year] = Number(el('c_year').value) || 2026;
       payload[MAP.campaigns.bimester] = Number(el('c_bim').value) || 1;
       payload[MAP.campaigns.objective] = el('c_objective').value.trim() || null;
       payload[MAP.campaigns.start] = el('c_start').value || null;
       payload[MAP.campaigns.end] = el('c_end').value || null;
       if (el('c_code').value.trim()) payload[MAP.campaigns.code] = el('c_code').value.trim();
       
       const id = el('c_id').value;
       const q = id
         ? supabase.from(MAP.campaigns.table).update(payload).eq(MAP.campaigns.id, id)
         : supabase.from(MAP.campaigns.table).insert(payload);

       showLoading(true);
       const { error } = await q;
       showLoading(false);

       if(error) return showAlert('danger','Error', error.message);

       bootstrap.Modal.getInstance(el('campaignModal'))?.hide();
       await loadCampaigns();
       await loadPieces();
       showAlert('success','Guardado','Campaña guardada.');
    };

    el('btnSeed').onclick = async () => {
        if(!confirm('Esto creará campañas base para 2026. ¿Continuar?')) return;
        showLoading(true);
        for(let b=1; b<=6; b++){
            const { error } = await supabase.from(MAP.campaigns.table).insert({
                [MAP.campaigns.year]: 2026,
                [MAP.campaigns.bimester]: b,
                [MAP.campaigns.name]: `Campaña Base B${b}`
            });
            if(error) console.warn(error);
        }
        await loadCampaigns();
        showLoading(false);
        showAlert('success','Listo','Seed creado.');
    };

    // -- PIECES --
    async function loadPieces(){
      const { data, error } = await supabase.from(MAP.pieces.table).select('*').order(MAP.pieces.created_at, { ascending:false });
      if(error){ showAlert('danger','Error', error.message); return; }
      state.pieces = data || [];
      applyPiecesFilters();
      updateSelects();
    }

    function renderPieces(rows){
       el('tblPieces').querySelector('tbody').innerHTML = rows.map(r => {
         const camp = state.campaigns.find(c => String(c[MAP.campaigns.id]) === String(r[MAP.pieces.campaign_id]));
         return `
         <tr>
           <td><span class="mono">${esc(r[MAP.pieces.code] ?? '-')}</span></td>
           <td class="small text-muted">${esc(camp ? camp[MAP.campaigns.name] : 'Sin campaña')}</td>
           <td>${getChannelIcon(r[MAP.pieces.channel])}</td>
           <td><span class="badge bg-light text-dark border fw-normal">${esc(r[MAP.pieces.format])}</span></td>
           <td class="small">${esc(r[MAP.pieces.funnel])}</td>
           <td>${getStatusBadge(r[MAP.pieces.status])}</td>
           <td class="truncate-2 small fw-bold" style="max-width:200px" title="${esc(r[MAP.pieces.hook])}">${esc(r[MAP.pieces.hook])}</td>
           <td class="small text-muted">${r[MAP.pieces.scheduled] ? fmtDT(r[MAP.pieces.scheduled]) : '-'}</td>
           <td class="text-end">
             <button class="btn btn-sm btn-white border" onclick="editPiece('${r[MAP.pieces.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
             <button class="btn btn-sm btn-white border ms-1" onclick="delPiece('${r[MAP.pieces.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
           </td>
         </tr>
       `}).join('');
    }

    function resetPieceForm(){
      el('p_id').value = '';
      el('p_campaign').value = '';
      el('p_channel').value = 'Instagram';
      el('p_format').value = '';
      el('p_funnel').value = '';
      el('p_status').value = 'Borrador';
      el('p_hook').value = '';
      el('p_copy').value = '';
      el('p_code').value = '';
      el('p_scheduled').value = '';
    }

    window.editPiece = (id) => {
        const row = state.pieces.find(r => String(r[MAP.pieces.id]) === String(id));
        if(!row) return;
        el('p_id').value = row[MAP.pieces.id];
        el('p_campaign').value = row[MAP.pieces.campaign_id] ?? '';
        el('p_channel').value = row[MAP.pieces.channel] ?? 'Instagram';
        el('p_format').value = row[MAP.pieces.format] ?? '';
        el('p_funnel').value = row[MAP.pieces.funnel] ?? '';
        el('p_status').value = row[MAP.pieces.status] ?? 'Borrador';
        el('p_hook').value = row[MAP.pieces.hook] ?? '';
        el('p_copy').value = row[MAP.pieces.copy] ?? '';
        el('p_code').value = row[MAP.pieces.code] ?? '';
        el('p_scheduled').value = row[MAP.pieces.scheduled] ? new Date(row[MAP.pieces.scheduled]).toISOString().slice(0,16) : '';
        new bootstrap.Modal(el('pieceModal')).show();
    };

    window.delPiece = async (id) => {
      if(!confirm('¿Borrar pieza?')) return;
      const { error } = await supabase.from(MAP.pieces.table).delete().eq(MAP.pieces.id, id);
      if(error) return showAlert('danger','Error', error.message);
      await loadPieces();
      showAlert('success','Eliminado','Pieza eliminada.');
    };

    el('btnSavePiece').onclick = async () => {
        const payload = {};
        payload[MAP.pieces.campaign_id] = el('p_campaign').value || null;
        payload[MAP.pieces.channel] = el('p_channel').value;
        payload[MAP.pieces.format] = el('p_format').value || null;
        payload[MAP.pieces.funnel] = el('p_funnel').value || null;
        payload[MAP.pieces.status] = el('p_status').value;
        payload[MAP.pieces.hook] = el('p_hook').value || null;
        payload[MAP.pieces.copy] = el('p_copy').value || null;
        if(el('p_code').value.trim()) payload[MAP.pieces.code] = el('p_code').value.trim();
        payload[MAP.pieces.scheduled] = el('p_scheduled').value ? new Date(el('p_scheduled').value).toISOString() : null;

        const id = el('p_id').value;
        const q = id
          ? supabase.from(MAP.pieces.table).update(payload).eq(MAP.pieces.id, id)
          : supabase.from(MAP.pieces.table).insert(payload);

        showLoading(true);
        const { error } = await q;
        showLoading(false);

        if(error) return showAlert('danger','Error', error.message);

        bootstrap.Modal.getInstance(el('pieceModal'))?.hide();
        await loadPieces();
        showAlert('success','Guardado','Pieza guardada.');
    };

    // -- METRICS --
    async function loadMetrics(){
        const { data, error } = await supabase.from(MAP.metrics.table).select('*').order(MAP.metrics.date, {ascending:false});
        if(error){ showAlert('danger','Error', error.message); return; }
        state.metrics = data || [];
        renderMetrics(state.metrics);
        updateSelects();
    }
    
    function renderMetrics(rows){
        el('tblMetrics').querySelector('tbody').innerHTML = rows.map(r => {
            const p = state.pieces.find(x => String(x[MAP.pieces.id]) === String(r[MAP.metrics.piece_id]));
            return `
            <tr>
              <td class="text-start">
                  <div class="small fw-bold">${esc(p ? p[MAP.pieces.code] : '-')}</div>
                  <div class="mini text-muted truncate-2">${esc(p ? p[MAP.pieces.hook] : '')}</div>
              </td>
              <td class="mono small">${esc(r[MAP.metrics.date])}</td>
              <td>${esc(r[MAP.metrics.impressions] ?? 0)}</td>
              <td>${esc(r[MAP.metrics.reach] ?? 0)}</td>
              <td>${esc(r[MAP.metrics.plays] ?? 0)}</td>
              <td class="fw-bold text-primary bg-primary bg-opacity-10">${esc(r[MAP.metrics.leads] ?? 0)}</td>
              <td>${esc(r[MAP.metrics.appointments] ?? 0)}</td>
              <td class="fw-bold text-success">${esc(r[MAP.metrics.showups] ?? 0)}</td>
              <td class="text-end">
                 <button class="btn btn-sm btn-white border" onclick="editMetric('${r[MAP.metrics.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
              </td>
            </tr>
            `;
        }).join('');
    }

    function resetMetricForm(){
      el('mx_id').value = '';
      el('mx_piece').value = '';
      el('mx_date').value = '';
      el('mx_impressions').value = 0;
      el('mx_reach').value = 0;
      el('mx_plays').value = 0;
      el('mx_leads').value = 0;
      el('mx_appointments').value = 0;
      el('mx_showups').value = 0;
    }

    window.editMetric = (id) => {
        const r = state.metrics.find(x => String(x[MAP.metrics.id]) === String(id));
        if(!r) return;
        el('mx_id').value = r[MAP.metrics.id];
        el('mx_piece').value = r[MAP.metrics.piece_id];
        el('mx_date').value = r[MAP.metrics.date];
        el('mx_impressions').value = r[MAP.metrics.impressions] ?? 0;
        el('mx_reach').value = r[MAP.metrics.reach] ?? 0;
        el('mx_plays').value = r[MAP.metrics.plays] ?? 0;
        el('mx_leads').value = r[MAP.metrics.leads] ?? 0;
        el('mx_appointments').value = r[MAP.metrics.appointments] ?? 0;
        el('mx_showups').value = r[MAP.metrics.showups] ?? 0;
        new bootstrap.Modal(el('metricModal')).show();
    };

    el('btnSaveMetric').onclick = async () => {
        const payload = {};
        payload[MAP.metrics.piece_id] = el('mx_piece').value;
        payload[MAP.metrics.date] = el('mx_date').value;
        payload[MAP.metrics.impressions] = Number(el('mx_impressions').value || 0);
        payload[MAP.metrics.reach] = Number(el('mx_reach').value || 0);
        payload[MAP.metrics.plays] = Number(el('mx_plays').value || 0);
        payload[MAP.metrics.leads] = Number(el('mx_leads').value || 0);
        payload[MAP.metrics.appointments] = Number(el('mx_appointments').value || 0);
        payload[MAP.metrics.showups] = Number(el('mx_showups').value || 0);

        const id = el('mx_id').value;

        let q;
        if(id) {
          q = supabase.from(MAP.metrics.table).update(payload).eq(MAP.metrics.id, id);
        } else {
          q = supabase.from(MAP.metrics.table).upsert(payload, { onConflict: `${MAP.metrics.piece_id},${MAP.metrics.date}` });
        }

        showLoading(true);
        const { error } = await q;
        showLoading(false);

        if(error) return showAlert('danger','Error', error.message);

        bootstrap.Modal.getInstance(el('metricModal'))?.hide();
        await loadMetrics();
        showAlert('success','Guardado','Métrica guardada.');
    };

    // -- LEADS --
    async function loadLeads(){
        const { data, error } = await supabase.from(MAP.leads.table).select('*').order(MAP.leads.created_at, {ascending:false});
        if(error){ showAlert('danger','Error', error.message); return; }
        state.leads = data || [];
        applyLeadsFilters();
    }

    function renderLeads(rows){
        el('tblLeads').querySelector('tbody').innerHTML = rows.map(r => {
             const c = state.campaigns.find(x=> String(x[MAP.campaigns.id]) === String(r[MAP.leads.campaign_id]));
             const p = state.pieces.find(x=> String(x[MAP.pieces.id]) === String(r[MAP.leads.piece_id]));
             return `
             <tr>
                <td><span class="mono">${esc(r[MAP.leads.code] ?? '—')}</span></td>
                <td class="small text-muted">${fmtDT(r[MAP.leads.created_at])}</td>
                <td><span class="badge bg-light text-dark border">${esc(r[MAP.leads.source] ?? '')}</span></td>
                <td>
                    <div class="mini text-truncate" style="max-width:120px">${esc(c?.[MAP.campaigns.name] || '')}</div>
                    <div class="mini text-muted">${esc(p?.[MAP.pieces.code] || '')}</div>
                </td>
                <td class="fw-bold text-primary">${esc(r[MAP.leads.name] ?? '')}</td>
                <td>${esc(r[MAP.leads.phone] ?? '')}</td>
                <td>${getStatusBadge(r[MAP.leads.status] ?? '')}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-white border" onclick="editLead('${r[MAP.leads.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
                    <button class="btn btn-sm btn-white border ms-1" onclick="delLead('${r[MAP.leads.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
                </td>
             </tr>
             `;
        }).join('');
    }

    function resetLeadForm(){
      el('ld_id').value = '';
      el('ld_source').value = '';
      el('ld_campaign').value = '';
      el('ld_piece').value = '';
      el('ld_name').value = '';
      el('ld_phone').value = '';
      el('ld_interest').value = '';
      el('ld_status').value = 'Nuevo';
      el('ld_notes').value = '';
    }

    window.editLead = (id) => {
        const r = state.leads.find(x => String(x[MAP.leads.id]) === String(id));
        if(!r) return;
        el('ld_id').value = r[MAP.leads.id];
        el('ld_source').value = r[MAP.leads.source] ?? '';
        el('ld_campaign').value = r[MAP.leads.campaign_id] ?? '';
        el('ld_piece').value = r[MAP.leads.piece_id] ?? '';
        el('ld_name').value = r[MAP.leads.name] ?? '';
        el('ld_phone').value = r[MAP.leads.phone] ?? '';
        el('ld_interest').value = r[MAP.leads.interest] ?? '';
        el('ld_status').value = r[MAP.leads.status] ?? 'Nuevo';
        el('ld_notes').value = r[MAP.leads.notes] ?? '';
        new bootstrap.Modal(el('leadModal')).show();
    };

    window.delLead = async (id) => {
      if(!confirm('¿Borrar?')) return;
      const { error } = await supabase.from(MAP.leads.table).delete().eq(MAP.leads.id, id);
      if(error) return showAlert('danger','Error', error.message);
      await loadLeads();
      showAlert('success','Eliminado','Lead eliminado.');
    };

    el('btnSaveLead').onclick = async () => {
         const payload = {};
         payload[MAP.leads.source] = el('ld_source').value || null;
         payload[MAP.leads.campaign_id] = el('ld_campaign').value || null;
         payload[MAP.leads.piece_id] = el('ld_piece').value || null;
         payload[MAP.leads.name] = el('ld_name').value || null;
         payload[MAP.leads.phone] = el('ld_phone').value || null;
         payload[MAP.leads.interest] = el('ld_interest').value || null;
         payload[MAP.leads.status] = el('ld_status').value || 'Nuevo';
         payload[MAP.leads.notes] = el('ld_notes').value || null;

         const id = el('ld_id').value;
         const q = id
           ? supabase.from(MAP.leads.table).update(payload).eq(MAP.leads.id, id)
           : supabase.from(MAP.leads.table).insert(payload);

         showLoading(true);
         const { error } = await q;
         showLoading(false);

         if(error) return showAlert('danger','Error', error.message);

         bootstrap.Modal.getInstance(el('leadModal'))?.hide();
         await loadLeads();
         showAlert('success','Guardado','Lead guardado.');
    };

    // --- FILTERS / SELECTS ---
    function updateSelects(){
        const campOpts = '<option value="">(Seleccionar)</option>' + state.campaigns.map(c=>`<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`).join('');
        el('fCamp').innerHTML = '<option value="">Todas</option>' + state.campaigns.map(c=>`<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`).join('');
        el('p_campaign').innerHTML = campOpts;
        el('ld_campaign').innerHTML = campOpts;
        el('lCamp').innerHTML = el('fCamp').innerHTML;

        const pieceOpts = '<option value="">(Seleccionar)</option>' + state.pieces.map(p=>`<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`).join('');
        el('mPiece').innerHTML = pieceOpts;
        el('ld_piece').innerHTML = pieceOpts;
        el('mx_piece').innerHTML = pieceOpts;
        el('lPiece').innerHTML = pieceOpts;
    }

    function applyPiecesFilters(){
        const bim = el('fBim').value;           // NUEVO: se usa
        const camp = el('fCamp').value;
        const chan = el('fChannel').value;
        const stat = el('fStatus').value;
        const q = (el('fQ').value || '').toLowerCase();

        const filtered = state.pieces.filter(r => {
            const campaign = state.campaigns.find(c => String(c[MAP.campaigns.id]) === String(r[MAP.pieces.campaign_id]));
            if (bim && String(campaign?.[MAP.campaigns.bimester] ?? '') !== String(bim)) return false;
            if (camp && String(r[MAP.pieces.campaign_id] ?? '') !== String(camp)) return false;
            if (chan && String(r[MAP.pieces.channel] ?? '') !== String(chan)) return false;
            if (stat && String(r[MAP.pieces.status] ?? '') !== String(stat)) return false;
            if (q && !JSON.stringify(r).toLowerCase().includes(q)) return false;
            return true;
        });

        renderPieces(filtered);
        updateSelects();
    }

    function applyLeadsFilters(){
      const camp = el('lCamp').value;
      const piece = el('lPiece').value;
      const q = (el('lQ').value || '').toLowerCase();

      const filtered = state.leads.filter(r => {
        if (camp && String(r[MAP.leads.campaign_id] ?? '') !== String(camp)) return false;
        if (piece && String(r[MAP.leads.piece_id] ?? '') !== String(piece)) return false;
        if (q && !JSON.stringify(r).toLowerCase().includes(q)) return false;
        return true;
      });

      renderLeads(filtered);
    }

    function bindFilters(){
        el('btnNewCampaign').onclick = () => openCampaignModal();

        el('btnNewPiece').onclick = () => { resetPieceForm(); new bootstrap.Modal(el('pieceModal')).show(); };
        el('btnNewMetric').onclick = () => { resetMetricForm(); new bootstrap.Modal(el('metricModal')).show(); };
        el('btnNewLead').onclick = () => { resetLeadForm(); new bootstrap.Modal(el('leadModal')).show(); };
        
        ['fCamp','fChannel','fStatus','fBim'].forEach(id => el(id)?.addEventListener('change', applyPiecesFilters));
        el('fQ')?.addEventListener('keyup', applyPiecesFilters);

        ['lCamp','lPiece'].forEach(id => el(id)?.addEventListener('change', applyLeadsFilters));
        el('lQ')?.addEventListener('keyup', applyLeadsFilters);
        
        el('btnReloadCampaigns').onclick = loadCampaigns;
        el('btnReloadPieces').onclick = loadPieces;
        el('btnReloadMetrics').onclick = loadMetrics;
        el('btnReloadLeads').onclick = loadLeads;
    }

    // Start
    init();
  </script>
</body>
</html>

