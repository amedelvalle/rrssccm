<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grupo CCM | Plan Digital 2026</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary:#2563eb; --primary-hover:#1d4ed8;
      --bg-body:#f3f4f6; --bg-card:#fff;
      --text-main:#1f2937; --text-muted:#6b7280;
      --border:#e5e7eb;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);
      --shadow-md:0 8px 16px rgba(0,0,0,.08);
      --r:12px;
    }
    body{ background:var(--bg-body); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--text-main); }
    .app-shell{ max-width:1400px; }
    .cardx{ background:var(--bg-card); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow-sm); overflow:hidden; }
    .cardx:hover{ box-shadow:var(--shadow-md); }
    .navbar-ccm{ background:rgba(255,255,255,.9); backdrop-filter:blur(10px); border-bottom:1px solid var(--border); box-shadow:var(--shadow-sm); padding:.75rem 0; }
    .brand-icon{ width:32px; height:32px; background:#eff6ff; border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary); }
    .brand-title{ font-weight:800; letter-spacing:-.02em; }
    .brand-sub{ font-size:.75rem; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.06em; }
    .mini{ color:var(--text-muted); font-size:.875rem; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.85em; color:var(--primary); background:#eff6ff; padding:2px 6px; border-radius:6px; }
    .btn{ border-radius:10px; font-weight:600; }
    .btn-primary{ background:var(--primary); border-color:var(--primary); }
    .btn-primary:hover{ background:var(--primary-hover); border-color:var(--primary-hover); }
    .btn-light{ background:#fff; border-color:var(--border); color:#374151; }
    .btn-light:hover{ background:#f9fafb; }
    .nav-tabs{ border-bottom:1px solid var(--border); gap:1rem; }
    .nav-tabs .nav-link{ border:none; color:var(--text-muted); font-weight:700; padding:.75rem .25rem; }
    .nav-tabs .nav-link:hover{ color:var(--primary); }
    .nav-tabs .nav-link.active{ color:var(--primary); border-bottom:2px solid var(--primary); background:transparent; }
    .form-control,.form-select{ border-radius:10px; border-color:var(--border); padding:.6rem .75rem; }
    .form-control:focus,.form-select:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.12); }

    .table thead th{
      background:#f9fafb; color:#6b7280; font-size:.75rem;
      font-weight:800; text-transform:uppercase; letter-spacing:.06em;
      border-bottom:1px solid var(--border); padding:.75rem 1rem;
    }
    .table tbody td{ padding:.9rem 1rem; border-bottom:1px solid var(--border); vertical-align:middle; font-size:.9rem; }
    .table-hover tbody tr:hover{ background:#f9fafb; }

    .badge-status{ padding:4px 10px; border-radius:999px; font-size:.75rem; font-weight:800; display:inline-flex; align-items:center; gap:6px; }
    .badge-status::before{ content:''; width:6px; height:6px; border-radius:50%; background:currentColor; }
    .st-gray{ background:#f3f4f6; color:#4b5563; }
    .st-blue{ background:#eff6ff; color:#2563eb; }
    .st-green{ background:#ecfdf5; color:#059669; }
    .st-amber{ background:#fffbeb; color:#d97706; }
    .st-red{ background:#fef2f2; color:#dc2626; }

    .loading{ position:fixed; inset:0; background:rgba(255,255,255,.75); backdrop-filter:blur(2px); display:none; align-items:center; justify-content:center; z-index:3000; }
    .loading .box{ background:#fff; padding:18px 26px; border-radius:14px; border:1px solid var(--border); box-shadow:var(--shadow-md); display:flex; flex-direction:column; align-items:center; gap:10px; }

    .alert-stack{ position:fixed; top:84px; right:18px; z-index:2500; display:flex; flex-direction:column; gap:10px; width:min(420px, calc(100vw - 24px)); }
    .alert-card{ background:#fff; border:1px solid var(--border); border-left:4px solid var(--primary); border-radius:12px; box-shadow:var(--shadow-md); padding:12px 14px; display:flex; gap:12px; align-items:flex-start; animation:slideIn .18s ease; }
    .alert-card.success{ border-left-color:#059669; }
    .alert-card.warning{ border-left-color:#d97706; }
    .alert-card.danger{ border-left-color:#dc2626; }
    @keyframes slideIn{ from{ transform:translateX(12px); opacity:0; } to{ transform:translateX(0); opacity:1; } }

    .hidden{ display:none !important; }
    .truncate-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .icon-btn{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; }
  </style>
</head>

<body>
  <div class="alert-stack" id="alertStack" aria-live="polite" aria-atomic="true"></div>

  <nav class="navbar navbar-ccm sticky-top">
    <div class="container-fluid app-shell px-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-icon"><i class="bi bi-grid-fill"></i></div>
        <div class="min-w-0">
          <div class="brand-title">Grupo CCM</div>
          <div class="brand-sub">Plan Digital 2026</div>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge bg-light text-dark border fw-semibold py-2 px-3 rounded-pill" id="whoami">Cargando...</span>
        <button class="btn btn-light btn-sm" id="btnLogout" disabled title="Cerrar sesión">
          <i class="bi bi-box-arrow-right me-1"></i>Salir
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell my-5 px-4">

    <!-- LOGIN -->
    <div id="loginView" class="cardx p-5 mx-auto" style="max-width:480px;">
      <div class="text-center mb-4">
        <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3" style="width:48px;height:48px;">
          <i class="bi bi-shield-lock-fill fs-5"></i>
        </div>
        <h4 class="fw-bold mb-1">Iniciar sesión</h4>
        <p class="text-muted small mb-0">Accede al panel de Marketing</p>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold small">Correo electrónico</label>
        <input type="email" class="form-control" id="loginEmail" placeholder="admin@grupo-ccm.com" autocomplete="username" aria-label="Correo electrónico">
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold small">Contraseña</label>
        <input type="password" class="form-control" id="loginPass" placeholder="••••••••" autocomplete="current-password" aria-label="Contraseña">
      </div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-link px-0 small text-decoration-none" id="btnForgotPass" type="button">¿Olvidaste tu clave?</button>
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSignIn">Ingresar</button>
      <div class="text-center mt-3 small text-muted">Powered by Supabase</div>

      <div class="mt-3 small text-muted">
        <div class="fw-bold mb-1">Nota</div>
        <div>Si no puedes crear/editar campañas y piezas, probablemente tu usuario está en rol <span class="mono">staff</span>. Debe ser <span class="mono">admin</span> o <span class="mono">editor</span> según tus políticas RLS.</div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="hidden">
      <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
        <div>
          <h3 class="fw-bold mb-1">Panel de control</h3>
          <div class="mini">Campañas · Piezas · Métricas · Leads</div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-light bg-white" id="btnSeed" title="Crear campañas base si no existen">
            <i class="bi bi-database-add me-2 text-muted"></i>Seed (Bimestres)
          </button>
          <div class="vr mx-2 text-muted"></div>
          <button class="btn btn-primary" id="btnNewCampaign"><i class="bi bi-plus-lg me-1"></i>Campaña</button>
          <button class="btn btn-primary" id="btnNewPiece"><i class="bi bi-plus-lg me-1"></i>Pieza</button>
          <button class="btn btn-primary" id="btnNewMetric"><i class="bi bi-plus-lg me-1"></i>Métrica</button>
          <button class="btn btn-primary" id="btnNewLead"><i class="bi bi-plus-lg me-1"></i>Lead</button>
        </div>
      </div>

      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCampaigns" type="button" role="tab">
            <i class="bi bi-calendar-range me-2"></i>Campañas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPieces" type="button" role="tab">
            <i class="bi bi-grid me-2"></i>Piezas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMetrics" type="button" role="tab">
            <i class="bi bi-bar-chart me-2"></i>Métricas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLeads" type="button" role="tab">
            <i class="bi bi-people me-2"></i>Leads
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- CAMPAIGNS -->
        <div class="tab-pane fade show active" id="tabCampaigns" role="tabpanel">
          <div class="cardx">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-light bg-opacity-50">
              <span class="fw-bold small text-uppercase text-muted">Listado</span>
              <button class="btn btn-light icon-btn" id="btnReloadCampaigns" title="Actualizar campañas" aria-label="Actualizar campañas">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblCampaigns" role="grid">
                <thead>
                  <tr>
                    <th scope="col">Bimestre</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Objetivo</th>
                    <th scope="col">Inicio</th>
                    <th scope="col">Fin</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PIECES -->
        <div class="tab-pane fade" id="tabPieces" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="fCamp" aria-label="Filtrar por campaña"></select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Canal</label>
                  <select class="form-select" id="fChannel" aria-label="Filtrar por canal"></select>
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Estado</label>
                  <input class="form-control" id="fPieceStatus" placeholder="idea, borrador..." aria-label="Filtrar por estado">
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input class="form-control border-start-0 ps-0" id="fQ" placeholder="Nombre, hook, ad_id..." aria-label="Buscar piezas">
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblPieces" role="grid">
                <thead>
                  <tr>
                    <th scope="col">Nombre</th>
                    <th scope="col">Campaña</th>
                    <th scope="col">Canal</th>
                    <th scope="col">Formato</th>
                    <th scope="col">Status</th>
                    <th scope="col">Hook</th>
                    <th scope="col" class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadPieces" title="Actualizar piezas">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
              </button>
            </div>
          </div>
        </div>

        <!-- METRICS -->
        <div class="tab-pane fade" id="tabMetrics" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="mPiece" aria-label="Seleccionar pieza"></select>
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Desde</label>
                  <input type="date" class="form-control" id="mFrom" aria-label="Desde">
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Hasta</label>
                  <input type="date" class="form-control" id="mTo" aria-label="Hasta">
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end">
                  <button class="btn btn-light w-100" id="btnReloadMetrics" title="Actualizar métricas" aria-label="Actualizar métricas">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblMetrics" role="grid">
                <thead class="text-center">
                  <tr>
                    <th scope="col" class="text-start">Pieza</th>
                    <th scope="col">Fecha</th>
                    <th scope="col" id="thM1">Volumen</th>
                    <th scope="col" id="thM2">Interacciones</th>
                    <th scope="col">Gasto</th>
                    <th scope="col" class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- LEADS -->
        <div class="tab-pane fade" id="tabLeads" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="lCamp" aria-label="Filtrar leads por campaña"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="lPiece" aria-label="Filtrar leads por pieza"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <input class="form-control" id="lQ" placeholder="Nombre, teléfono, email..." aria-label="Buscar leads">
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblLeads" role="grid">
                <thead>
                  <tr>
                    <th scope="col">Fecha</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Teléfono</th>
                    <th scope="col">Email</th>
                    <th scope="col">Origen</th>
                    <th scope="col">Triage</th>
                    <th scope="col">Outcome</th>
                    <th scope="col" class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadLeads" title="Actualizar leads">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal fade" id="forgotPassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Recuperar acceso</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small">Ingresa tu correo y te enviaremos un enlace para restablecer tu contraseña.</p>
          <input type="email" class="form-control mb-3" id="fp_email" placeholder="tu@correo.com" aria-label="Correo para recuperación">
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" id="btnSendResetEmail">Enviar</button>
          </div>
          <div class="small text-muted mt-3">
            Importante: en Supabase Auth, configura la URL de redirección permitida para GitHub Pages si aplica.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="setNewPassModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Nueva contraseña</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label small fw-bold">Contraseña nueva</label>
            <input type="password" class="form-control" id="np1" aria-label="Contraseña nueva">
          </div>
          <div class="mb-4">
            <label class="form-label small fw-bold">Confirmar</label>
            <input type="password" class="form-control" id="np2" aria-label="Confirmar contraseña nueva">
          </div>
          <button class="btn btn-primary w-100" id="btnSetNewPass">Actualizar</button>
          <button class="btn btn-light w-100 mt-2" id="btnCancelRecovery">Salir de recuperación</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Campaign -->
  <div class="modal fade" id="campaignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="campaignModalTitle">Campaña</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="c_id">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label small fw-bold">Nombre</label>
              <input class="form-control" id="c_name" placeholder="Ej: Diabetes Control">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Bimestre (ENUM)</label>
              <input class="form-control" id="c_bim" placeholder="Ej: B1 (debe coincidir con tu ENUM)">
              <div class="small text-muted mt-1">Debe coincidir con tu enum <span class="mono">campaign_bimester</span>.</div>
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Status</label>
              <input class="form-control" id="c_status" placeholder="planificada, activa...">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Inicio</label>
              <input type="date" class="form-control" id="c_start">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Fin</label>
              <input type="date" class="form-control" id="c_end">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Objetivo</label>
              <textarea class="form-control" id="c_objective" rows="2" placeholder="Ej: Generar 50 leads cualificados"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Evento ancla</label>
              <input class="form-control" id="c_anchor_event" placeholder="Ej: Jornada de diabetes">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Lead magnet</label>
              <input class="form-control" id="c_lead_magnet" placeholder="Ej: Checklist, ebook, cupón...">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Presupuesto planificado</label>
              <input type="number" min="0" step="0.01" class="form-control" id="c_budget" placeholder="0.00">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveCampaign">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Piece -->
  <div class="modal fade" id="pieceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="pieceModalTitle">Pieza</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="p_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Campaña (opcional)</label>
              <select class="form-select" id="p_campaign"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Canal</label>
              <select class="form-select" id="p_channel"></select>
            </div>
            <div class="col-md-8">
              <label class="form-label small fw-bold">Nombre</label>
              <input class="form-control" id="p_name" placeholder="Ej: Reel - CTA WhatsApp">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Formato (ENUM)</label>
              <input class="form-control" id="p_format" placeholder="Ej: reel (según enum piece_format)">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Pillar</label>
              <input class="form-control" id="p_pillar" placeholder="Educación, Testimonio...">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Status</label>
              <input class="form-control" id="p_status" placeholder="idea, borrador, publicado...">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Hook / Copy</label>
              <textarea class="form-control" id="p_hook_copy" rows="2" placeholder="Gancho principal..."></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Estilo visual</label>
              <input class="form-control" id="p_visual" placeholder="Minimal, clínico, etc.">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">CTA destino</label>
              <input class="form-control" id="p_cta" placeholder="WhatsApp, landing, llamada...">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Ad ID</label>
              <input class="form-control" id="p_ad_id" placeholder="ID anuncio (si aplica)">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button class="btn btn-primary" id="btnSavePiece">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Metric -->
  <div class="modal fade" id="metricModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="metricModalTitle">Registro de métricas</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="mx_id">
          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label small fw-bold">Pieza</label>
              <select class="form-select" id="mx_piece"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Fecha</label>
              <input type="date" class="form-control" id="mx_date">
            </div>

            <div class="col-12"><hr class="text-muted"></div>

            <div class="col-6 col-md-4 text-center">
              <label class="form-label small text-muted" id="lblM1">Volumen</label>
              <input class="form-control text-center fw-bold" id="mx_volume" type="number" min="0">
            </div>
            <div class="col-6 col-md-4 text-center">
              <label class="form-label small text-muted" id="lblM2">Interacciones</label>
              <input class="form-control text-center fw-bold" id="mx_interactions" type="number" min="0">
            </div>
            <div class="col-12 col-md-4 text-center">
              <label class="form-label small text-muted">Gasto</label>
              <input class="form-control text-center fw-bold" id="mx_spend" type="number" min="0" step="0.01">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveMetric">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lead -->
  <div class="modal fade" id="leadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="leadModalTitle">Lead</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="ld_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Nombre completo *</label>
              <input class="form-control" id="ld_full_name" placeholder="Nombre y apellido">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Teléfono</label>
              <input class="form-control" id="ld_phone" placeholder="+503 ...">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Email</label>
              <input type="email" class="form-control" id="ld_email" placeholder="correo@dominio.com">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Origen (detalle)</label>
              <input class="form-control" id="ld_source_detail" placeholder="Ej: Instagram DM / Lobby / WhatsApp">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Campaña (opcional)</label>
              <select class="form-select" id="ld_campaign"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Pieza (opcional)</label>
              <select class="form-select" id="ld_piece"></select>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Triage status (ENUM)</label>
              <input class="form-control" id="ld_triage_status" placeholder="nuevo, contactado... (según enum triage_status)">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Outcome clínico (ENUM)</label>
              <input class="form-control" id="ld_clinical_outcome" placeholder="pendiente, cita... (según enum clinical_outcome)">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Notas triage</label>
              <textarea class="form-control" id="ld_triage_notes" rows="2"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Fecha/hora de cita (opcional)</label>
              <input type="datetime-local" class="form-control" id="ld_appointment_local">
              <div class="small text-muted mt-1">Se guardará como <span class="mono">timestamptz</span> (hora local convertida).</div>
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Ticket value</label>
              <input type="number" min="0" step="0.01" class="form-control" id="ld_ticket_value" placeholder="0.00">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="ld_is_retained">
                <label class="form-check-label small fw-bold" for="ld_is_retained">Retenido</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveLead">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="box">
      <div class="spinner-border text-primary" role="status" aria-label="Cargando"></div>
      <div class="fw-bold">Procesando…</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ✅ TU PROYECTO (URL confirmada por ti)
    const SUPABASE_URL = "https://rofwgcrsfrovspiholbo.supabase.co";
    // ✅ TU KEY (la que me diste)
    const SUPABASE_ANON_KEY = "sb_publishable_M7gyUpsbCPRopdrmDjEeLA_SHXlnP-C";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ✅ MAP 100% alineado a tu esquema real (según lo que pegaste)
    const MAP = {
      campaigns: {
        table: "campaigns",
        id: "id",
        name: "name",
        bimester: "bimester",
        start: "start_date",
        end: "end_date",
        objective: "objective",
        anchor_event: "anchor_event",
        lead_magnet: "lead_magnet",
        budget_planned: "budget_planned",
        status: "status",
        created_at: "created_at",
        updated_at: "updated_at"
      },
      channels: {
        table: "channels",
        id: "id",
        name: "name",
        metric1: "metric_label_1",
        metric2: "metric_label_2",
        created_at: "created_at"
      },
      pieces: {
        table: "pieces",
        id: "id",
        campaign_id: "campaign_id",
        channel_id: "channel_id",
        name: "name",
        format: "format",
        pillar: "pillar",
        hook_copy: "hook_copy",
        visual_style: "visual_style",
        cta_destination: "cta_destination",
        ad_id: "ad_id",
        status: "status",
        created_at: "created_at",
        updated_at: "updated_at"
      },
      metrics: {
        table: "piece_metrics",
        id: "id",
        piece_id: "piece_id",
        date: "date",
        volume: "volume",
        interactions: "interactions",
        spend: "spend",
        created_at: "created_at"
      },
      leads: {
        table: "leads",
        id: "id",
        created_at: "created_at",
        full_name: "full_name",
        phone: "phone",
        email: "email",
        source_detail: "source_detail",
        campaign_id: "campaign_id",
        piece_id: "piece_id",
        triage_status: "triage_status",
        triage_notes: "triage_notes",
        clinical_outcome: "clinical_outcome",
        appointment_date: "appointment_date",
        ticket_value: "ticket_value",
        is_retained: "is_retained",
        updated_at: "updated_at"
      }
    };

    const el = (id) => document.getElementById(id);
    const showLoading = (v) => el("loading").style.display = v ? "flex" : "none";
    const esc = (s) => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function showAlert(type, title, message, ttlMs = 4500){
      const stack = el("alertStack");
      const card = document.createElement("div");
      card.className = `alert-card ${type || "info"}`;
      const icon =
        type === "success" ? "bi-check-circle-fill text-success" :
        type === "warning" ? "bi-exclamation-triangle-fill text-warning" :
        type === "danger"  ? "bi-x-circle-fill text-danger" :
                             "bi-info-circle-fill text-primary";

      card.innerHTML = `
        <i class="bi ${icon} fs-5 mt-1"></i>
        <div class="flex-grow-1">
          <div class="fw-bold text-dark">${esc(title || "Aviso")}</div>
          <div class="small text-secondary">${esc(message || "")}</div>
        </div>
        <button class="btn-close ms-2" aria-label="Cerrar" style="font-size:.7em"></button>
      `;
      stack.appendChild(card);

      const close = () => { card.style.opacity="0"; setTimeout(()=>card.remove(),220); };
      card.querySelector(".btn-close").addEventListener("click", close);
      if (ttlMs) setTimeout(() => { if(card.isConnected) close(); }, ttlMs);
    }

    function humanize(err){
      const msg = (err?.message || err?.error_description || String(err || "")).trim();
      const low = msg.toLowerCase();
      const code = err?.code;

      // Auth
      if (low.includes("invalid login credentials")) return "Correo o contraseña incorrectos.";
      if (low.includes("email not confirmed")) return "Tu correo aún no está confirmado.";

      // Postgres codes (cuando supabase-js lo expone)
      if (code === "23505") return "Registro duplicado (clave única).";
      if (code === "23503") return "Referencia inválida (FK): revisa campaña/canal/pieza.";
      if (code === "22P02") return "Formato inválido (UUID/fecha/número).";
      if (code === "23502") return "Faltan campos obligatorios (NOT NULL).";

      // RLS / permisos
      if (low.includes("row level security") || low.includes("rls") || low.includes("permission denied")) {
        return "Permiso denegado por RLS. Tu usuario debe tener rol admin/editor según las políticas.";
      }

      // ENUM
      if (low.includes("invalid input value for enum")) {
        return "Valor inválido para ENUM. Debe coincidir con tus enums (bimester/format/triage/outcome).";
      }

      return msg || "Error desconocido.";
    }

    // Helpers fecha local ↔ timestamptz
    function localDateTimeToISO(value){ // value: "YYYY-MM-DDTHH:mm"
      if (!value) return null;
      const d = new Date(value);
      // Date(value) interpreta local; toISOString convierte a UTC para timestamptz: OK
      return d.toISOString();
    }
    function isoToLocalInput(iso){
      if(!iso) return "";
      const d = new Date(iso);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function statusBadge(s){
      const v = String(s || "").toLowerCase();
      let cls = "st-gray";
      if (v.includes("plan") || v.includes("idea")) cls = "st-gray";
      if (v.includes("act") || v.includes("prog")) cls = "st-blue";
      if (v.includes("pub") || v.includes("ok") || v.includes("reten")) cls = "st-green";
      if (v.includes("paus")) cls = "st-amber";
      if (v.includes("cerr") || v.includes("desc")) cls = "st-red";
      return `<span class="badge-status ${cls}">${esc(s || "-")}</span>`;
    }

    const state = {
      user: null,
      profile: null,
      campaigns: [],
      channels: [],
      pieces: [],
      metrics: [],
      leads: [],
      ready: { campaigns:false, channels:false, pieces:false, metrics:false, leads:false }
    };

    function campaignLabel(c){
      const b = c?.[MAP.campaigns.bimester] ?? "";
      const n = c?.[MAP.campaigns.name] ?? "";
      return `${b} · ${n}`.trim();
    }
    function pieceLabel(p){
      const n = p?.[MAP.pieces.name] ?? "";
      const h = p?.[MAP.pieces.hook_copy] ?? "";
      return (n ? n : h).slice(0, 60);
    }
    function channelLabel(ch){
      return ch?.[MAP.channels.name] ?? "-";
    }

    async function ensureReady(){
      // Orden: campaigns + channels + pieces (para selects), luego metrics/leads
      if(!state.ready.campaigns) await loadCampaigns();
      if(!state.ready.channels) await loadChannels();
      if(!state.ready.pieces) await loadPieces();
    }

    function setWhoami(){
      el("whoami").textContent = state.profile?.full_name || state.user?.email || "Usuario";
    }

    async function handleSession(session){
      state.user = session?.user || null;

      if(!state.user){
        el("loginView").classList.remove("hidden");
        el("appView").classList.add("hidden");
        el("btnLogout").disabled = true;
        el("whoami").textContent = "No autenticado";
        return;
      }

      try{
        const { data, error } = await supabase.from("profiles").select("*").eq("id", state.user.id).maybeSingle();
        if (error) throw error;
        state.profile = data || null;
      }catch(_){
        state.profile = null;
      }

      el("loginView").classList.add("hidden");
      el("appView").classList.remove("hidden");
      el("btnLogout").disabled = false;
      setWhoami();

      // Carga inicial
      await refreshAll();
    }

    function parseHashParams(){
      // Supabase recovery usa fragment (#) con access_token / type=recovery
      const hash = window.location.hash || "";
      const clean = hash.startsWith("#") ? hash.slice(1) : hash;
      return new URLSearchParams(clean);
    }
    function clearHash(){
      history.replaceState(null, document.title, window.location.pathname + window.location.search);
    }

    async function init(){
      // Si viene en modo recovery, supabase emitirá PASSWORD_RECOVERY en onAuthStateChange
      const { data } = await supabase.auth.getSession();
      await handleSession(data.session);

      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === "PASSWORD_RECOVERY") {
          // abre modal de nueva contraseña
          new bootstrap.Modal(el("setNewPassModal")).show();
        }
        await handleSession(session);
      });

      // fallback: si hash indica recovery, muestra modal
      const hp = parseHashParams();
      if (hp.get("type") === "recovery") {
        new bootstrap.Modal(el("setNewPassModal")).show();
      }
    }

    // ---------------- AUTH UI ----------------
    el("btnSignIn").addEventListener("click", async () => {
      const email = el("loginEmail").value.trim();
      const password = el("loginPass").value;
      if(!email || !password) return showAlert("warning","Faltan datos","Ingresa correo y contraseña.");
      showLoading(true);
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) throw error;
        showAlert("success","Bienvenido","Sesión iniciada.");
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    el("btnLogout").addEventListener("click", async () => {
      showLoading(true);
      try{
        const { error } = await supabase.auth.signOut();
        if(error) throw error;
        // UI se ajusta por handleSession al no haber sesión
        await handleSession(null);
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    el("btnForgotPass").addEventListener("click", () => new bootstrap.Modal(el("forgotPassModal")).show());

    el("btnSendResetEmail").addEventListener("click", async () => {
      const email = el("fp_email").value.trim();
      if(!email) return showAlert("warning","Email requerido","Ingresa tu correo.");
      showLoading(true);
      try{
        // En GitHub Pages, origin suele ser https://usuario.github.io
        const redirectTo = window.location.origin + window.location.pathname;
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
        if(error) throw error;
        bootstrap.Modal.getInstance(el("forgotPassModal"))?.hide();
        showAlert("success","Enviado","Revisa tu correo (incluye spam).");
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    el("btnSetNewPass").addEventListener("click", async () => {
      const p1 = el("np1").value;
      const p2 = el("np2").value;
      if(!p1 || p1.length < 6) return showAlert("warning","Seguridad","Mínimo 6 caracteres.");
      if(p1 !== p2) return showAlert("warning","Validación","Las contraseñas no coinciden.");

      showLoading(true);
      try{
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if(error) throw error;

        // Cierra modal y limpia hash para que no se quede “pegado”
        bootstrap.Modal.getInstance(el("setNewPassModal"))?.hide();
        clearHash();

        showAlert("success","Listo","Contraseña actualizada. Inicia sesión.");
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    el("btnCancelRecovery").addEventListener("click", async () => {
      clearHash();
      bootstrap.Modal.getInstance(el("setNewPassModal"))?.hide();
      showAlert("info","Listo","Saliste del flujo de recuperación.");
    });

    // ---------------- DATA LOAD ----------------
    async function refreshAll(){
      showLoading(true);
      try{
        state.ready = { campaigns:false, channels:false, pieces:false, metrics:false, leads:false };
        await loadCampaigns();
        await loadChannels();
        await loadPieces();
        await loadMetrics();
        await loadLeads();
        bindSelects();
        applyPiecesFilters();
        applyLeadsFilters();
        updateMetricLabelsFromSelectedPiece();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    }

    async function loadCampaigns(){
      try{
        const { data, error } = await supabase.from(MAP.campaigns.table).select("*").order(MAP.campaigns.start, { ascending:false });
        if(error) throw error;
        state.campaigns = data || [];
        state.ready.campaigns = true;
        renderCampaigns(state.campaigns);
      }catch(err){
        state.campaigns = [];
        renderCampaigns([]);
        throw err;
      }
    }

    async function loadChannels(){
      try{
        const { data, error } = await supabase.from(MAP.channels.table).select("*").order(MAP.channels.id, { ascending:true });
        if(error) throw error;
        state.channels = data || [];
        state.ready.channels = true;
      }catch(err){
        state.channels = [];
        state.ready.channels = true; // evita bucles; solo sin canales
        // no lanzamos error fatal: sin canales se puede navegar, pero piezas/métricas se limitan
      }
    }

    async function loadPieces(){
      try{
        const { data, error } = await supabase.from(MAP.pieces.table).select("*").order(MAP.pieces.created_at, { ascending:false });
        if(error) throw error;
        state.pieces = data || [];
        state.ready.pieces = true;
        renderPieces(state.pieces); // luego filtramos en UI
      }catch(err){
        state.pieces = [];
        renderPieces([]);
        throw err;
      }
    }

    async function loadMetrics(){
      try{
        // carga general (luego puedes filtrar por rango/pieza con btnReloadMetrics)
        const { data, error } = await supabase.from(MAP.metrics.table).select("*").order(MAP.metrics.date, { ascending:false }).limit(300);
        if(error) throw error;
        state.metrics = data || [];
        state.ready.metrics = true;
        renderMetrics(state.metrics);
      }catch(err){
        state.metrics = [];
        renderMetrics([]);
        throw err;
      }
    }

    async function loadLeads(){
      try{
        const { data, error } = await supabase.from(MAP.leads.table).select("*").order(MAP.leads.created_at, { ascending:false }).limit(500);
        if(error) throw error;
        state.leads = data || [];
        state.ready.leads = true;
        renderLeads(state.leads);
      }catch(err){
        state.leads = [];
        renderLeads([]);
        throw err;
      }
    }

    // ---------------- RENDER ----------------
    function renderCampaigns(rows){
      const tb = el("tblCampaigns").querySelector("tbody");
      tb.innerHTML = rows.map(r => `
        <tr>
          <td><span class="badge bg-light text-dark border fw-semibold">${esc(r[MAP.campaigns.bimester])}</span></td>
          <td class="fw-bold text-primary">${esc(r[MAP.campaigns.name])}</td>
          <td class="mini truncate-2" style="max-width:260px">${esc(r[MAP.campaigns.objective] || "")}</td>
          <td class="small">${esc(r[MAP.campaigns.start])}</td>
          <td class="small">${esc(r[MAP.campaigns.end])}</td>
          <td>${statusBadge(r[MAP.campaigns.status])}</td>
          <td class="text-end">
            <button class="btn btn-light icon-btn" title="Editar" aria-label="Editar campaña" onclick="editCamp('${r[MAP.campaigns.id]}')">
              <i class="bi bi-pencil-fill text-muted"></i>
            </button>
            <button class="btn btn-light icon-btn ms-1" title="Borrar" aria-label="Borrar campaña" onclick="delCamp('${r[MAP.campaigns.id]}')">
              <i class="bi bi-trash-fill text-danger opacity-75"></i>
            </button>
          </td>
        </tr>
      `).join("");
    }

    function renderPieces(rows){
      const tb = el("tblPieces").querySelector("tbody");
      tb.innerHTML = rows.map(r => {
        const camp = state.campaigns.find(c => c[MAP.campaigns.id] === r[MAP.pieces.campaign_id]);
        const ch = state.channels.find(x => String(x[MAP.channels.id]) === String(r[MAP.pieces.channel_id]));
        return `
          <tr>
            <td class="fw-bold">${esc(r[MAP.pieces.name])}</td>
            <td class="mini">${esc(camp ? camp[MAP.campaigns.name] : "—")}</td>
            <td><span class="badge bg-light text-dark border">${esc(ch ? ch[MAP.channels.name] : "—")}</span></td>
            <td><span class="badge bg-light text-dark border">${esc(r[MAP.pieces.format])}</span></td>
            <td>${statusBadge(r[MAP.pieces.status])}</td>
            <td class="truncate-2 small" style="max-width:300px" title="${esc(r[MAP.pieces.hook_copy] || "")}">${esc(r[MAP.pieces.hook_copy] || "")}</td>
            <td class="text-end">
              <button class="btn btn-light icon-btn" title="Editar" aria-label="Editar pieza" onclick="editPiece('${r[MAP.pieces.id]}')">
                <i class="bi bi-pencil-fill text-muted"></i>
              </button>
              <button class="btn btn-light icon-btn ms-1" title="Borrar" aria-label="Borrar pieza" onclick="delPiece('${r[MAP.pieces.id]}')">
                <i class="bi bi-trash-fill text-danger opacity-75"></i>
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function renderMetrics(rows){
      const tb = el("tblMetrics").querySelector("tbody");
      tb.innerHTML = rows.map(r => {
        const p = state.pieces.find(x => x[MAP.pieces.id] === r[MAP.metrics.piece_id]);
        const ch = p ? state.channels.find(x => String(x[MAP.channels.id]) === String(p[MAP.pieces.channel_id])) : null;
        const m1 = ch?.[MAP.channels.metric1] || "Volumen";
        const m2 = ch?.[MAP.channels.metric2] || "Interacciones";
        return `
          <tr>
            <td class="text-start">
              <div class="fw-bold small">${esc(p ? p[MAP.pieces.name] : "—")}</div>
              <div class="mini truncate-2">${esc(p ? (p[MAP.pieces.hook_copy] || "") : "")}</div>
            </td>
            <td class="mono">${esc(r[MAP.metrics.date])}</td>
            <td>${esc(r[MAP.metrics.volume] ?? 0)}</td>
            <td>${esc(r[MAP.metrics.interactions] ?? 0)}</td>
            <td>${esc(r[MAP.metrics.spend] ?? 0)}</td>
            <td class="text-end">
              <button class="btn btn-light icon-btn" title="Editar" aria-label="Editar métrica" onclick="editMetric('${r[MAP.metrics.id]}')">
                <i class="bi bi-pencil-fill text-muted"></i>
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function renderLeads(rows){
      const tb = el("tblLeads").querySelector("tbody");
      tb.innerHTML = rows.map(r => `
        <tr>
          <td class="small text-muted">${esc(r[MAP.leads.created_at] ? new Date(r[MAP.leads.created_at]).toLocaleString() : "")}</td>
          <td class="fw-bold text-primary">${esc(r[MAP.leads.full_name])}</td>
          <td>${esc(r[MAP.leads.phone] || "")}</td>
          <td class="small">${esc(r[MAP.leads.email] || "")}</td>
          <td class="small"><span class="badge bg-light text-dark border">${esc(r[MAP.leads.source_detail] || "—")}</span></td>
          <td>${statusBadge(r[MAP.leads.triage_status])}</td>
          <td>${statusBadge(r[MAP.leads.clinical_outcome])}</td>
          <td class="text-end">
            <button class="btn btn-light icon-btn" title="Editar" aria-label="Editar lead" onclick="editLead('${r[MAP.leads.id]}')">
              <i class="bi bi-pencil-fill text-muted"></i>
            </button>
            <button class="btn btn-light icon-btn ms-1" title="Borrar" aria-label="Borrar lead" onclick="delLead('${r[MAP.leads.id]}')">
              <i class="bi bi-trash-fill text-danger opacity-75"></i>
            </button>
          </td>
        </tr>
      `).join("");
    }

    // ---------------- SELECTS / FILTERS ----------------
    function bindSelects(){
      // Campaign selects
      const campAll = `<option value="">Todas</option>` + state.campaigns.map(c => `<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`).join("");
      const campPick = `<option value="">(Ninguna)</option>` + state.campaigns.map(c => `<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`).join("");

      el("fCamp").innerHTML = campAll;
      el("p_campaign").innerHTML = campPick;
      el("ld_campaign").innerHTML = campPick;
      el("lCamp").innerHTML = campAll;

      // Channels selects
      const chAll = `<option value="">Todos</option>` + state.channels.map(ch => `<option value="${ch[MAP.channels.id]}">${esc(channelLabel(ch))}</option>`).join("");
      const chPick = `<option value="">(Seleccionar)</option>` + state.channels.map(ch => `<option value="${ch[MAP.channels.id]}">${esc(channelLabel(ch))}</option>`).join("");
      el("fChannel").innerHTML = chAll;
      el("p_channel").innerHTML = chPick;

      // Pieces selects
      const piecePick = `<option value="">(Seleccionar)</option>` + state.pieces.map(p => `<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`).join("");
      const pieceAll = `<option value="">Todas</option>` + state.pieces.map(p => `<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`).join("");

      el("mPiece").innerHTML = piecePick;
      el("mx_piece").innerHTML = piecePick;
      el("ld_piece").innerHTML = piecePick;
      el("lPiece").innerHTML = pieceAll;
    }

    function applyPiecesFilters(){
      const camp = el("fCamp").value;
      const ch = el("fChannel").value;
      const st = (el("fPieceStatus").value || "").trim().toLowerCase();
      const q = (el("fQ").value || "").trim().toLowerCase();

      const filtered = state.pieces.filter(r => {
        if (camp && String(r[MAP.pieces.campaign_id] || "") !== String(camp)) return false;
        if (ch && String(r[MAP.pieces.channel_id] || "") !== String(ch)) return false;
        if (st && !String(r[MAP.pieces.status] || "").toLowerCase().includes(st)) return false;
        if (q) {
          const blob = JSON.stringify({
            name: r[MAP.pieces.name],
            hook: r[MAP.pieces.hook_copy],
            ad: r[MAP.pieces.ad_id],
            pillar: r[MAP.pieces.pillar]
          }).toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      });

      renderPieces(filtered);
    }

    function applyLeadsFilters(){
      const camp = el("lCamp").value;
      const piece = el("lPiece").value;
      const q = (el("lQ").value || "").trim().toLowerCase();

      const filtered = state.leads.filter(r => {
        if (camp && String(r[MAP.leads.campaign_id] || "") !== String(camp)) return false;
        if (piece && String(r[MAP.leads.piece_id] || "") !== String(piece)) return false;
        if (q) {
          const blob = JSON.stringify({
            name: r[MAP.leads.full_name],
            phone: r[MAP.leads.phone],
            email: r[MAP.leads.email],
            source: r[MAP.leads.source_detail]
          }).toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      });

      renderLeads(filtered);
    }

    function updateMetricLabelsFromSelectedPiece(){
      const pieceId = el("mPiece").value || el("mx_piece").value;
      const p = state.pieces.find(x => String(x[MAP.pieces.id]) === String(pieceId));
      const ch = p ? state.channels.find(x => String(x[MAP.channels.id]) === String(p[MAP.pieces.channel_id])) : null;
      const m1 = ch?.[MAP.channels.metric1] || "Volumen";
      const m2 = ch?.[MAP.channels.metric2] || "Interacciones";

      el("thM1").textContent = m1;
      el("thM2").textContent = m2;
      el("lblM1").textContent = m1;
      el("lblM2").textContent = m2;
    }

    // ---------------- CRUD: CAMPAIGNS ----------------
    window.editCamp = (id) => openCampaignModal(state.campaigns.find(x => String(x[MAP.campaigns.id]) === String(id)));
    window.delCamp = async (id) => {
      if(!confirm("¿Borrar campaña?")) return;
      showLoading(true);
      try{
        const { error } = await supabase.from(MAP.campaigns.table).delete().eq(MAP.campaigns.id, id);
        if(error) throw error;
        showAlert("success","Listo","Campaña eliminada.");
        await loadCampaigns();
        bindSelects();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    };

    function openCampaignModal(row=null){
      el("c_id").value = row?.[MAP.campaigns.id] || "";
      el("c_name").value = row?.[MAP.campaigns.name] || "";
      el("c_bim").value = row?.[MAP.campaigns.bimester] || "";
      el("c_status").value = row?.[MAP.campaigns.status] || "";
      el("c_start").value = row?.[MAP.campaigns.start] || "";
      el("c_end").value = row?.[MAP.campaigns.end] || "";
      el("c_objective").value = row?.[MAP.campaigns.objective] || "";
      el("c_anchor_event").value = row?.[MAP.campaigns.anchor_event] || "";
      el("c_lead_magnet").value = row?.[MAP.campaigns.lead_magnet] || "";
      el("c_budget").value = row?.[MAP.campaigns.budget_planned] ?? 0;
      new bootstrap.Modal(el("campaignModal")).show();
    }

    el("btnSaveCampaign").addEventListener("click", async () => {
      const name = (el("c_name").value || "").trim();
      const bim = (el("c_bim").value || "").trim();
      const start = el("c_start").value;
      const end = el("c_end").value;

      if(!name) return showAlert("warning","Validación","Nombre es requerido.");
      if(!bim) return showAlert("warning","Validación","Bimestre es requerido (ENUM).");
      if(!start || !end) return showAlert("warning","Validación","Inicio y fin son requeridos.");

      const payload = {
        [MAP.campaigns.name]: name,
        [MAP.campaigns.bimester]: bim,
        [MAP.campaigns.start]: start,
        [MAP.campaigns.end]: end,
        [MAP.campaigns.status]: (el("c_status").value || "").trim() || null,
        [MAP.campaigns.objective]: (el("c_objective").value || "").trim() || null,
        [MAP.campaigns.anchor_event]: (el("c_anchor_event").value || "").trim() || null,
        [MAP.campaigns.lead_magnet]: (el("c_lead_magnet").value || "").trim() || null,
        [MAP.campaigns.budget_planned]: Number(el("c_budget").value || 0)
      };

      const id = el("c_id").value;
      showLoading(true);
      try{
        const q = id
          ? supabase.from(MAP.campaigns.table).update(payload).eq(MAP.campaigns.id, id)
          : supabase.from(MAP.campaigns.table).insert(payload);

        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el("campaignModal"))?.hide();
        showAlert("success","Guardado","Campaña guardada.");
        await loadCampaigns();
        bindSelects();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    // Seed campañas base (NO duplica por combinación bimester+start_date+end_date+name)
    el("btnSeed").addEventListener("click", async () => {
      if(!confirm("Creará campañas base si no existen. ¿Continuar?")) return;

      // OJO: bimester es ENUM → el valor debe existir en tu enum.
      // Si tu enum NO es B1..B6, cambia estos valores a los reales.
      const BIM = ["B1","B2","B3","B4","B5","B6"];

      showLoading(true);
      try{
        // Crea 6 campañas genéricas (si ya existen por name+bimester+start/end iguales, no crea)
        // Como no tenemos constraint único para ON CONFLICT, hacemos verificación previa.
        for(const b of BIM){
          const name = `Campaña Base ${b}`;
          const { data: exist, error: e1 } = await supabase
            .from(MAP.campaigns.table)
            .select("id")
            .eq(MAP.campaigns.name, name)
            .eq(MAP.campaigns.bimester, b)
            .limit(1);

          if(e1) throw e1;
          if(exist && exist.length) continue;

          // Fechas placeholders (ajústalas luego)
          const { error: e2 } = await supabase.from(MAP.campaigns.table).insert({
            [MAP.campaigns.name]: name,
            [MAP.campaigns.bimester]: b,
            [MAP.campaigns.start]: "2026-01-01",
            [MAP.campaigns.end]: "2026-01-15",
            [MAP.campaigns.status]: "planificada"
          });
          if(e2) throw e2;
        }

        await loadCampaigns();
        bindSelects();
        showAlert("success","Listo","Seed aplicado (sin duplicar por nombre+bimestre).");
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    // ---------------- CRUD: PIECES ----------------
    window.editPiece = async (id) => {
      await ensureReady();
      const row = state.pieces.find(r => String(r[MAP.pieces.id]) === String(id));
      if(!row) return;

      el("p_id").value = row[MAP.pieces.id];
      el("p_campaign").value = row[MAP.pieces.campaign_id] || "";
      el("p_channel").value = row[MAP.pieces.channel_id] || "";
      el("p_name").value = row[MAP.pieces.name] || "";
      el("p_format").value = row[MAP.pieces.format] || "";
      el("p_pillar").value = row[MAP.pieces.pillar] || "";
      el("p_hook_copy").value = row[MAP.pieces.hook_copy] || "";
      el("p_visual").value = row[MAP.pieces.visual_style] || "";
      el("p_cta").value = row[MAP.pieces.cta_destination] || "";
      el("p_ad_id").value = row[MAP.pieces.ad_id] || "";
      el("p_status").value = row[MAP.pieces.status] || "";

      new bootstrap.Modal(el("pieceModal")).show();
    };

    window.delPiece = async (id) => {
      if(!confirm("¿Borrar pieza?")) return;
      showLoading(true);
      try{
        const { error } = await supabase.from(MAP.pieces.table).delete().eq(MAP.pieces.id, id);
        if(error) throw error;
        showAlert("success","Listo","Pieza eliminada.");
        await loadPieces();
        bindSelects();
        applyPiecesFilters();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    };

    el("btnSavePiece").addEventListener("click", async () => {
      const name = (el("p_name").value || "").trim();
      const channelId = el("p_channel").value;
      const format = (el("p_format").value || "").trim();

      if(!name) return showAlert("warning","Validación","Nombre es requerido.");
      if(!channelId) return showAlert("warning","Validación","Canal es requerido.");
      if(!format) return showAlert("warning","Validación","Formato (ENUM) es requerido.");

      const payload = {
        [MAP.pieces.campaign_id]: el("p_campaign").value || null,
        [MAP.pieces.channel_id]: Number(channelId),
        [MAP.pieces.name]: name,
        [MAP.pieces.format]: format,
        [MAP.pieces.pillar]: (el("p_pillar").value || "").trim() || null,
        [MAP.pieces.hook_copy]: (el("p_hook_copy").value || "").trim() || null,
        [MAP.pieces.visual_style]: (el("p_visual").value || "").trim() || null,
        [MAP.pieces.cta_destination]: (el("p_cta").value || "").trim() || null,
        [MAP.pieces.ad_id]: (el("p_ad_id").value || "").trim() || null,
        [MAP.pieces.status]: (el("p_status").value || "").trim() || null
      };

      const id = el("p_id").value;
      showLoading(true);
      try{
        const q = id
          ? supabase.from(MAP.pieces.table).update(payload).eq(MAP.pieces.id, id)
          : supabase.from(MAP.pieces.table).insert(payload);

        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el("pieceModal"))?.hide();
        showAlert("success","Guardado","Pieza guardada.");
        await loadPieces();
        bindSelects();
        applyPiecesFilters();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    // ---------------- CRUD: METRICS ----------------
    window.editMetric = async (id) => {
      await ensureReady();
      const r = state.metrics.find(x => String(x[MAP.metrics.id]) === String(id));
      if(!r) return;

      el("mx_id").value = r[MAP.metrics.id];
      el("mx_piece").value = r[MAP.metrics.piece_id];
      el("mx_date").value = r[MAP.metrics.date];
      el("mx_volume").value = r[MAP.metrics.volume] ?? 0;
      el("mx_interactions").value = r[MAP.metrics.interactions] ?? 0;
      el("mx_spend").value = r[MAP.metrics.spend] ?? 0;

      updateMetricLabelsFromSelectedPiece();
      new bootstrap.Modal(el("metricModal")).show();
    };

    el("btnSaveMetric").addEventListener("click", async () => {
      const pieceId = el("mx_piece").value;
      const date = el("mx_date").value;
      if(!pieceId) return showAlert("warning","Validación","Selecciona una pieza.");
      if(!date) return showAlert("warning","Validación","Fecha es requerida.");

      const payload = {
        [MAP.metrics.piece_id]: pieceId,
        [MAP.metrics.date]: date,
        [MAP.metrics.volume]: Number(el("mx_volume").value || 0),
        [MAP.metrics.interactions]: Number(el("mx_interactions").value || 0),
        [MAP.metrics.spend]: Number(el("mx_spend").value || 0)
      };

      const id = el("mx_id").value;
      showLoading(true);
      try{
        let q;
        if(id){
          q = supabase.from(MAP.metrics.table).update(payload).eq(MAP.metrics.id, id);
        }else{
          // UNIQUE (piece_id, date) existe → upsert es lo correcto
          q = supabase.from(MAP.metrics.table).upsert(payload, { onConflict: `${MAP.metrics.piece_id},${MAP.metrics.date}` });
        }
        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el("metricModal"))?.hide();
        showAlert("success","Guardado","Métrica guardada.");
        await loadMetrics();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    // Reload metrics con filtros
    el("btnReloadMetrics").addEventListener("click", async () => {
      showLoading(true);
      try{
        let q = supabase.from(MAP.metrics.table).select("*");

        const pieceId = el("mPiece").value;
        const from = el("mFrom").value;
        const to = el("mTo").value;

        if(pieceId) q = q.eq(MAP.metrics.piece_id, pieceId);
        if(from) q = q.gte(MAP.metrics.date, from);
        if(to) q = q.lte(MAP.metrics.date, to);

        const { data, error } = await q.order(MAP.metrics.date, { ascending:false }).limit(500);
        if(error) throw error;

        state.metrics = data || [];
        renderMetrics(state.metrics);
        updateMetricLabelsFromSelectedPiece();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    // ---------------- CRUD: LEADS ----------------
    window.editLead = async (id) => {
      await ensureReady();
      const r = state.leads.find(x => String(x[MAP.leads.id]) === String(id));
      if(!r) return;

      el("ld_id").value = r[MAP.leads.id];
      el("ld_full_name").value = r[MAP.leads.full_name] || "";
      el("ld_phone").value = r[MAP.leads.phone] || "";
      el("ld_email").value = r[MAP.leads.email] || "";
      el("ld_source_detail").value = r[MAP.leads.source_detail] || "";
      el("ld_campaign").value = r[MAP.leads.campaign_id] || "";
      el("ld_piece").value = r[MAP.leads.piece_id] || "";
      el("ld_triage_status").value = r[MAP.leads.triage_status] || "";
      el("ld_clinical_outcome").value = r[MAP.leads.clinical_outcome] || "";
      el("ld_triage_notes").value = r[MAP.leads.triage_notes] || "";
      el("ld_appointment_local").value = isoToLocalInput(r[MAP.leads.appointment_date]);
      el("ld_ticket_value").value = r[MAP.leads.ticket_value] ?? 0;
      el("ld_is_retained").checked = !!r[MAP.leads.is_retained];

      new bootstrap.Modal(el("leadModal")).show();
    };

    window.delLead = async (id) => {
      if(!confirm("¿Borrar lead?")) return;
      showLoading(true);
      try{
        const { error } = await supabase.from(MAP.leads.table).delete().eq(MAP.leads.id, id);
        if(error) throw error;
        showAlert("success","Listo","Lead eliminado.");
        await loadLeads();
        applyLeadsFilters();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    };

    function isValidEmail(email){
      if(!email) return true;
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email.trim());
    }

    el("btnSaveLead").addEventListener("click", async () => {
      const full = (el("ld_full_name").value || "").trim();
      const email = (el("ld_email").value || "").trim();
      const phone = (el("ld_phone").value || "").trim();
      const apLocal = el("ld_appointment_local").value;

      if(!full) return showAlert("warning","Validación","Nombre completo es requerido.");
      if(email && !isValidEmail(email)) return showAlert("warning","Validación","Email con formato inválido.");

      // Si se llena cita, exigir que sea futura
      if(apLocal){
        const dt = new Date(apLocal);
        if(Number.isNaN(dt.getTime())) return showAlert("warning","Validación","Fecha/hora de cita inválida.");
        if(dt.getTime() < Date.now() - 60*1000) return showAlert("warning","Validación","La cita debe ser futura.");
      }

      const payload = {
        [MAP.leads.full_name]: full,
        [MAP.leads.phone]: phone || null,
        [MAP.leads.email]: email || null,
        [MAP.leads.source_detail]: (el("ld_source_detail").value || "").trim() || null,
        [MAP.leads.campaign_id]: el("ld_campaign").value || null,
        [MAP.leads.piece_id]: el("ld_piece").value || null,
        [MAP.leads.triage_status]: (el("ld_triage_status").value || "").trim() || null,   // ENUM -> debe coincidir
        [MAP.leads.triage_notes]: (el("ld_triage_notes").value || "").trim() || null,
        [MAP.leads.clinical_outcome]: (el("ld_clinical_outcome").value || "").trim() || null, // ENUM -> debe coincidir
        [MAP.leads.appointment_date]: localDateTimeToISO(apLocal),
        [MAP.leads.ticket_value]: Number(el("ld_ticket_value").value || 0),
        [MAP.leads.is_retained]: !!el("ld_is_retained").checked
      };

      const id = el("ld_id").value;
      showLoading(true);
      try{
        const q = id
          ? supabase.from(MAP.leads.table).update(payload).eq(MAP.leads.id, id)
          : supabase.from(MAP.leads.table).insert(payload);

        const { error } = await q;
        if(error) throw error;

        bootstrap.Modal.getInstance(el("leadModal"))?.hide();
        showAlert("success","Guardado","Lead guardado.");
        await loadLeads();
        applyLeadsFilters();
      }catch(err){
        showAlert("danger","Error", humanize(err));
      }finally{
        showLoading(false);
      }
    });

    // ---------------- UI BINDINGS ----------------
    function bindUI(){
      el("btnNewCampaign").addEventListener("click", async () => {
        await ensureReady();
        // Limpia
        el("c_id").value = "";
        el("c_name").value = "";
        el("c_bim").value = "";
        el("c_status").value = "";
        el("c_start").value = "";
        el("c_end").value = "";
        el("c_objective").value = "";
        el("c_anchor_event").value = "";
        el("c_lead_magnet").value = "";
        el("c_budget").value = "0";
        new bootstrap.Modal(el("campaignModal")).show();
      });

      el("btnNewPiece").addEventListener("click", async () => {
        await ensureReady();
        el("p_id").value = "";
        el("p_campaign").value = "";
        el("p_channel").value = "";
        el("p_name").value = "";
        el("p_format").value = "";
        el("p_pillar").value = "";
        el("p_hook_copy").value = "";
        el("p_visual").value = "";
        el("p_cta").value = "";
        el("p_ad_id").value = "";
        el("p_status").value = "idea";
        new bootstrap.Modal(el("pieceModal")).show();
      });

      el("btnNewMetric").addEventListener("click", async () => {
        await ensureReady();
        el("mx_id").value = "";
        el("mx_piece").value = "";
        el("mx_date").value = "";
        el("mx_volume").value = 0;
        el("mx_interactions").value = 0;
        el("mx_spend").value = 0;
        updateMetricLabelsFromSelectedPiece();
        new bootstrap.Modal(el("metricModal")).show();
      });

      el("btnNewLead").addEventListener("click", async () => {
        await ensureReady();
        el("ld_id").value = "";
        el("ld_full_name").value = "";
        el("ld_phone").value = "";
        el("ld_email").value = "";
        el("ld_source_detail").value = "";
        el("ld_campaign").value = "";
        el("ld_piece").value = "";
        el("ld_triage_status").value = "nuevo";
        el("ld_clinical_outcome").value = "pendiente";
        el("ld_triage_notes").value = "";
        el("ld_appointment_local").value = "";
        el("ld_ticket_value").value = 0;
        el("ld_is_retained").checked = false;
        new bootstrap.Modal(el("leadModal")).show();
      });

      el("btnReloadCampaigns").addEventListener("click", async () => {
        showLoading(true);
        try{ await loadCampaigns(); bindSelects(); }
        catch(err){ showAlert("danger","Error", humanize(err)); }
        finally{ showLoading(false); }
      });

      el("btnReloadPieces").addEventListener("click", async () => {
        showLoading(true);
        try{ await loadPieces(); bindSelects(); applyPiecesFilters(); }
        catch(err){ showAlert("danger","Error", humanize(err)); }
        finally{ showLoading(false); }
      });

      el("btnReloadLeads").addEventListener("click", async () => {
        showLoading(true);
        try{ await loadLeads(); applyLeadsFilters(); }
        catch(err){ showAlert("danger","Error", humanize(err)); }
        finally{ showLoading(false); }
      });

      // Filters
      ["fCamp","fChannel","fPieceStatus"].forEach(id => el(id).addEventListener("change", applyPiecesFilters));
      el("fQ").addEventListener("input", applyPiecesFilters);

      ["lCamp","lPiece"].forEach(id => el(id).addEventListener("change", applyLeadsFilters));
      el("lQ").addEventListener("input", applyLeadsFilters);

      // Metric labels
      el("mPiece").addEventListener("change", () => {
        updateMetricLabelsFromSelectedPiece();
      });
      el("mx_piece").addEventListener("change", () => {
        updateMetricLabelsFromSelectedPiece();
      });

      // Close modals: avoid stuck UI
      ["campaignModal","pieceModal","metricModal","leadModal"].forEach(mid => {
        el(mid).addEventListener("hidden.bs.modal", () => {
          // noop — pero evita que queden overlays por errores raros
          document.body.classList.remove("modal-open");
          document.querySelectorAll(".modal-backdrop").forEach(x => x.remove());
        });
      });
    }

    // ---------------- BOOT ----------------
    bindUI();
    init();
  </script>
</body>
</html>
