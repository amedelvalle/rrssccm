<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación del Regente | Sistema</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- html2pdf (PDF export) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{ --card-radius: 14px; }
    body { background:#f6f7fb; }
    .app-shell { max-width: 1200px; }
    .card { border-radius: var(--card-radius); border: 1px solid rgba(0,0,0,.06); }
    .soft { color:#6c757d; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill { border-radius: 999px; }
    .question-card { background:#fff; border:1px solid rgba(0,0,0,.06); border-radius: 12px; padding: 14px; }
    .q-meta { font-size:.85rem; color:#6c757d; }
    .sticky-actions { position: sticky; bottom: 0; z-index: 20; }
    .kpi { background:#fff; border:1px solid rgba(0,0,0,.06); border-radius: 14px; padding: 14px; }
    .kpi .value { font-size: 1.6rem; font-weight: 700; }
    .kpi .label { font-size:.85rem; color:#6c757d; }
    .divider { height: 1px; background: rgba(0,0,0,.08); margin: 12px 0; }
    .btn { border-radius: 10px; }

    .score-pill { font-weight: 700; padding: .35rem .6rem; border-radius: 999px; font-size: .85rem; }
    .score-5 { background: rgba(25,135,84,.12); color:#198754; border:1px solid rgba(25,135,84,.22); }
    .score-4 { background: rgba(13,110,253,.10); color:#0d6efd; border:1px solid rgba(13,110,253,.22); }
    .score-3 { background: rgba(255,193,7,.14); color:#b07a00; border:1px solid rgba(255,193,7,.30); }
    .score-2 { background: rgba(253,126,20,.14); color:#b45500; border:1px solid rgba(253,126,20,.30); }
    .score-1 { background: rgba(220,53,69,.14); color:#dc3545; border:1px solid rgba(220,53,69,.28); }
    .score-ne { background: rgba(108,117,125,.14); color:#6c757d; border:1px solid rgba(108,117,125,.26); }

    .sig-box{
      border: 1px dashed rgba(0,0,0,.35);
      border-radius: 12px;
      padding: 12px;
      min-height: 80px;
      background: #fafafa;
    }

    /* Header fijo */
    .app-header-sticky{
      background:#f6f7fb;
      padding-top: 10px;
      padding-bottom: 10px;
      z-index: 50;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    /* Tabs */
    .nav-pills .nav-link{ border-radius: 999px; }
    .nav-pills .nav-link.active{ background:#0d6efd; }

    /* Spinner min */
    .mini-spin{ width: 1rem; height: 1rem; border-width: 2px; }

    /* =========================
       PDF Export Mode (A4)
       ========================= */
    body.is-exporting #pdfArea{
      display:block !important;
      position: fixed;
      left: -10000px;   /* fuera de pantalla */
      top: 0;
      width: auto;
      height: auto;
      overflow: visible;
    }

    body.is-exporting #pdfReport{
      width: 210mm;          /* A4 */
      max-width: 210mm;
      background: #fff;
      padding: 12mm;         /* margen interno consistente */
      border: none;
      border-radius: 0;
      box-shadow: none !important;
      font-size: 12px;
    }

    body.is-exporting #pdfReport .card{
      box-shadow: none !important;
    }

    body.is-exporting .kpi,
    body.is-exporting .sig-box,
    body.is-exporting #pdfObsList > div,
    body.is-exporting #pdfSectionBars > div,
    body.is-exporting .avoid-break{
      break-inside: avoid;
      page-break-inside: avoid;
    }

    body.is-exporting .progress{ height: 8px !important; }
    body.is-exporting .badge{ font-size: 11px; }

    @page{
      size: A4;
      margin: 10mm;
    }
  </style>
</head>

<body>
  <div class="app-header-sticky sticky-top">
    <div class="container app-shell">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div class="d-flex align-items-center gap-2">
          <div class="fw-bold">Evaluación del Regente</div>
          <span id="envBadge" class="badge text-bg-light pill">Cargando…</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span id="userBadge" class="badge text-bg-light pill">No autenticado</span>
          <button id="btnLogout" class="btn btn-sm btn-outline-secondary d-none"><i class="bi bi-box-arrow-right"></i> Salir</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container app-shell my-4">
    <!-- Login -->
    <div id="loginCard" class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Correo</label>
            <input id="loginEmail" class="form-control" type="email" placeholder="correo@dominio.com" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Contraseña</label>
            <input id="loginPass" class="form-control" type="password" placeholder="••••••••" />
          </div>
          <div class="col-md-4 d-grid">
            <button id="btnLogin" class="btn btn-primary">
              <span class="d-inline-flex align-items-center gap-2">
                <span>Ingresar</span>
                <span id="loginSpin" class="spinner-border mini-spin d-none" role="status" aria-hidden="true"></span>
              </span>
            </button>
          </div>
        </div>
        <div id="loginMsg" class="mt-3 small"></div>
      </div>
    </div>

    <!-- App -->
    <div id="appRoot" class="d-none">
      <div class="card shadow-sm">
        <div class="card-body">
          <ul class="nav nav-pills gap-2" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" data-tab="tabEval"><i class="bi bi-ui-checks"></i> Evaluación</button></li>
            <li class="nav-item"><button class="nav-link" data-tab="tabDash"><i class="bi bi-bar-chart"></i> Resumen</button></li>
            <li class="nav-item"><button class="nav-link" data-tab="tabHistory"><i class="bi bi-clock-history"></i> Historial</button></li>
          </ul>

          <div class="divider"></div>

          <!-- TAB: Evaluación -->
          <div id="tabEval" class="tab-pane">
            <div class="row g-3">
              <div class="col-lg-4">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <div class="fw-bold">Evaluación actual</div>
                        <div id="evalMeta" class="small soft">—</div>
                      </div>
                      <span id="statusBadge" class="badge text-bg-light pill">—</span>
                    </div>

                    <div class="divider"></div>

                    <div class="small soft">Objetivo</div>
                    <div class="fw-semibold">Evaluar desempeño y cumplimiento del Regente</div>

                    <div class="divider"></div>

                    <div class="d-grid gap-2">
                      <button id="btnSubmit" class="btn btn-success" disabled>
                        <i class="bi bi-check2-circle"></i> Finalizar (Enviar)
                      </button>
                      <button id="btnDraft" class="btn btn-outline-primary" disabled>
                        <i class="bi bi-save2"></i> Guardar borrador
                      </button>
                      <button id="btnPDFHere" class="btn btn-outline-secondary" disabled>
                        <i class="bi bi-filetype-pdf"></i> Descargar PDF (Finalizada)
                      </button>
                      <div id="pdfHint" class="small soft">
                        Para generar el PDF, la evaluación debe estar <b>Finalizada</b>.
                      </div>
                    </div>

                    <div class="divider"></div>
                    <div class="small soft">Mensaje</div>
                    <div id="workMsg" class="small">—</div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-body">
                    <div class="fw-bold">Filtros</div>
                    <div class="small soft">Secciones y búsqueda</div>
                    <div class="divider"></div>

                    <label class="form-label small">Sección</label>
                    <select id="filterSection" class="form-select">
                      <option value="">Todas</option>
                    </select>

                    <label class="form-label small mt-2">Buscar pregunta</label>
                    <input id="filterText" class="form-control" placeholder="Palabra clave…" />

                    <div class="d-grid mt-3">
                      <button id="btnApplyFilters" class="btn btn-outline-secondary">
                        <i class="bi bi-funnel"></i> Aplicar
                      </button>
                    </div>
                  </div>
                </div>

              </div>

              <div class="col-lg-8">
                <div id="questionList" class="d-grid gap-3">
                  <!-- preguntas -->
                </div>
              </div>
            </div>

            <div class="sticky-actions mt-3">
              <div class="card shadow-sm">
                <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-2">
                  <div class="small soft">
                    <i class="bi bi-info-circle"></i> Guarda borrador para continuar luego. Finaliza cuando todo esté completo.
                  </div>
                  <div class="d-flex gap-2">
                    <button id="btnDraft2" class="btn btn-outline-primary" disabled><i class="bi bi-save2"></i> Guardar borrador</button>
                    <button id="btnSubmit2" class="btn btn-success" disabled><i class="bi bi-check2-circle"></i> Finalizar</button>
                    <button id="btnPDF" class="btn btn-outline-secondary" disabled><i class="bi bi-filetype-pdf"></i> PDF</button>
                  </div>
                </div>
              </div>
            </div>

          </div><!-- /tabEval -->

          <!-- TAB: Dashboard -->
          <div id="tabDash" class="tab-pane d-none">
            <div class="row g-3">
              <div class="col-lg-8">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="kpi">
                      <div class="label">Nota ponderada (0–100)</div>
                      <div id="kpiScore" class="value">—</div>
                      <div id="kpiQual" class="small soft">—</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="kpi">
                      <div class="label">Preguntas respondidas</div>
                      <div id="kpiAnswered" class="value">—</div>
                      <div class="small soft">de <span id="kpiTotal">—</span></div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="kpi">
                      <div class="label">Críticas ≤ 2</div>
                      <div id="kpiCritical" class="value">—</div>
                      <div class="small soft">Requieren atención</div>
                    </div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-body">
                    <div class="fw-bold">Promedios por sección</div>
                    <div class="small soft">Peso aplicado por sección</div>
                    <div class="divider"></div>
                    <div id="sectionBars" class="d-grid gap-2"></div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-body">
                    <div class="fw-bold">Observaciones</div>
                    <div class="small soft">Preguntas críticas y evidencias registradas</div>
                    <div class="divider"></div>
                    <div id="obsList" class="d-grid gap-2"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card">
                  <div class="card-body">
                    <div class="fw-bold">Datos</div>
                    <div class="small soft">Evaluado / Fecha / Laboratorio</div>
                    <div class="divider"></div>
                    <div class="small"><b>Evaluado:</b> <span id="dashEvaluatee">—</span></div>
                    <div class="small"><b>Fecha:</b> <span id="dashDate">—</span></div>
                    <div class="small"><b>Laboratorio:</b> <span id="dashLab">—</span></div>
                    <div class="divider"></div>
                    <div class="small soft">Acciones</div>
                    <div class="d-grid gap-2 mt-2">
                      <button id="btnRefreshDash" class="btn btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
                      <button id="btnPDFDash" class="btn btn-outline-secondary" disabled><i class="bi bi-filetype-pdf"></i> PDF</button>
                    </div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-body">
                    <div class="fw-bold">Firma</div>
                    <div class="small soft">Evaluador</div>
                    <div class="divider"></div>
                    <div class="sig-box">
                      <div id="sigName" class="fw-semibold">—</div>
                      <div id="sigRole" class="small soft">—</div>
                      <div id="sigDate" class="small soft">—</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- /tabDash -->

          <!-- TAB: Historial -->
          <div id="tabHistory" class="tab-pane d-none">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
              <div>
                <div class="fw-bold">Historial</div>
                <div class="small soft">Evaluaciones finalizadas</div>
              </div>
              <button id="btnReloadHistory" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-clockwise"></i> Recargar</button>
            </div>
            <div id="historyList" class="d-grid gap-2"></div>
          </div><!-- /tabHistory -->

        </div>
      </div>
    </div>

    <!-- PDF (oculto) -->
    <div id="pdfArea" style="display:none;">
      <div id="pdfReport">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="h5 mb-1">Resumen de Evaluación del Regente</div>
            <div class="soft">Generado por el sistema (solo evaluaciones finalizadas)</div>
          </div>
          <div class="text-end small">
            <div><b>Fecha:</b> <span id="pdfDate">—</span></div>
            <div><b>Evaluado:</b> <span id="pdfEvaluatee">—</span></div>
            <div><b>Laboratorio:</b> <span id="pdfLab">—</span></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row g-2">
          <div class="col-4">
            <div class="kpi">
              <div class="label">Nota ponderada</div>
              <div id="pdfScore" class="value">—</div>
              <div id="pdfQual" class="small soft">—</div>
            </div>
          </div>
          <div class="col-4">
            <div class="kpi">
              <div class="label">Respondidas</div>
              <div id="pdfAnswered" class="value">—</div>
              <div class="small soft">de <span id="pdfTotal">—</span></div>
            </div>
          </div>
          <div class="col-4">
            <div class="kpi">
              <div class="label">Críticas ≤ 2</div>
              <div id="pdfCritical" class="value">—</div>
              <div class="small soft">Atención prioritaria</div>
            </div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <div class="fw-bold">Promedios por sección</div>
            <div class="small soft">Peso aplicado por sección</div>
            <div class="divider"></div>
            <div id="pdfSectionBars" class="d-grid gap-2"></div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <div class="fw-bold">Observaciones</div>
            <div class="small soft">Críticos y evidencias</div>
            <div class="divider"></div>
            <div id="pdfObsList" class="d-grid gap-2"></div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <div class="fw-bold">Firma</div>
            <div class="small soft">Evaluador</div>
            <div class="divider"></div>
            <div class="sig-box">
              <div id="pdfSigName" class="fw-semibold">—</div>
              <div id="pdfSigRole" class="small soft">—</div>
              <div id="pdfSigDate" class="small soft">—</div>
            </div>
          </div>
        </div>

        <div class="small soft mt-3">
          Este documento resume resultados. Para auditoría, conservar evidencias y bitácoras asociadas.
        </div>
      </div>
    </div>

  </div><!-- /container -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // =============================
    // CONFIG: Supabase
    // =============================
    const SUPABASE_URL = "https://YOURPROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

    let sb = null;

    function isSupabaseConfigured(){
      const urlOk =
        typeof SUPABASE_URL === 'string' &&
        SUPABASE_URL.startsWith('https://') &&
        SUPABASE_URL.includes('.supabase.co') &&
        !SUPABASE_URL.includes('YOURPROJECT');

      const keyOk =
        typeof SUPABASE_ANON_KEY === 'string' &&
        SUPABASE_ANON_KEY.length > 40 &&
        !SUPABASE_ANON_KEY.includes('YOUR_ANON_KEY');

      return urlOk && keyOk;
    }

    function initSupabase(){
      if (!isSupabaseConfigured()) return false;
      try {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        return true;
      } catch (e){
        console.error('Supabase init error:', e);
        sb = null;
        return false;
      }
    }

    // =============================
    // CONSTANTES (secciones/pesos)
    // =============================
    const SECTION_WEIGHTS = {
      "Gestión y administración": 20,
      "Regencia técnica": 25,
      "Bioseguridad y riesgos": 20,
      "Calidad y documentación": 20,
      "Gestión de equipo e infraestructura": 15
    };

    const SECTION_ORDER = Object.keys(SECTION_WEIGHTS);

    const QUAL_LABEL = (score100) => {
      if (score100 >= 90) return { label: "Excelente", msg: "Desempeño sobresaliente." };
      if (score100 >= 80) return { label: "Muy bueno", msg: "Cumple con alto estándar." };
      if (score100 >= 70) return { label: "Bueno", msg: "Cumple, con oportunidades de mejora." };
      if (score100 >= 60) return { label: "Regular", msg: "Requiere acciones correctivas." };
      return { label: "Deficiente", msg: "Riesgo alto: intervención inmediata." };
    };

    // =============================
    // ESTADO
    // =============================
    let currentUser = null;
    let currentEval = null;
    let questionBank = [];
    let answersMap = new Map(); // question_id -> {score,evidence}
    let lastDashboard = null;

    // =============================
    // Helpers de IDs (soporta id o evaluation_id)
    // =============================
    function getEvalId(){
      return currentEval?.id ?? currentEval?.evaluation_id ?? null;
    }

    function getEvalIdColumn(){
      // Preferimos 'id' si existe, si no usamos 'evaluation_id'
      if (currentEval && typeof currentEval.id !== 'undefined' && currentEval.id !== null) return 'id';
      return 'evaluation_id';
    }

    // =============================
    // UI Helpers
    // =============================
    function setLoginMsg(type, text){
      const el = document.getElementById('loginMsg');
      el.className = `mt-3 small text-${type}`;
      el.textContent = text || '';
    }

    function workMsg(type, text){
      const el = document.getElementById('workMsg');
      el.className = `small text-${type}`;
      el.textContent = text || '';
    }

    function setStatusBadge(status){
      const el = document.getElementById('statusBadge');
      if (!status){
        el.textContent = '—';
        el.className = 'badge text-bg-light pill';
        return;
      }
      let cls = 'text-bg-light';
      if (status === 'draft') cls = 'text-bg-warning';
      if (status === 'submitted') cls = 'text-bg-success';
      el.textContent = status === 'submitted' ? 'Finalizada' : (status === 'draft' ? 'Borrador' : status);
      el.className = `badge ${cls} pill`;
    }

    function setEnvBadge(){
      const el = document.getElementById('envBadge');
      const ok = isSupabaseConfigured();
      el.textContent = ok ? 'Producción' : 'Config pendiente';
      el.className = `badge ${ok ? 'text-bg-success' : 'text-bg-warning'} pill`;
    }

    function enableWorkButtons(enabled){
      document.getElementById('btnDraft').disabled = !enabled;
      document.getElementById('btnDraft2').disabled = !enabled;
      document.getElementById('btnSubmit').disabled = !enabled;
      document.getElementById('btnSubmit2').disabled = !enabled;

      const allowPDF = enabled && (currentEval?.status === 'submitted');
      document.getElementById('btnPDF').disabled = !allowPDF;
      document.getElementById('btnPDFHere').disabled = !allowPDF;
      document.getElementById('btnPDFDash').disabled = !allowPDF;
    }

    function switchTab(tabId){
      for (const btn of document.querySelectorAll('#mainTabs .nav-link')) {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      }
      for (const pane of document.querySelectorAll('.tab-pane')) {
        pane.classList.toggle('d-none', pane.id !== tabId);
      }
    }

    function switchToDashboardTab(){
      switchTab('tabDash');
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // =============================
    // AUTH
    // =============================
    async function login(email, password){
      if (!sb) { setLoginMsg('danger','Supabase no está configurado.'); return null; }

      setLoginMsg('secondary','Autenticando…');
      document.getElementById('loginSpin').classList.remove('d-none');
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      document.getElementById('loginSpin').classList.add('d-none');
      if (error) { setLoginMsg('danger', error.message); return null; }
      return data.user;
    }

    async function logout(){
      try { if (sb) await sb.auth.signOut(); } catch(e){}

      currentUser = null;
      currentEval = null;
      answersMap = new Map();
      lastDashboard = null;

      document.getElementById('appRoot').classList.add('d-none');
      document.getElementById('loginCard').classList.remove('d-none');
      document.getElementById('btnLogout').classList.add('d-none');
      document.getElementById('userBadge').textContent = 'No autenticado';
      setLoginMsg('secondary','Sesión cerrada.');
    }

    // =============================
    // DATA: Load question bank
    // =============================
    async function loadQuestionBank(){
      if (!sb) return;

      workMsg('secondary','Cargando banco de preguntas…');

      const { data, error } = await sb
        .from('evaluation_questions')
        .select('*')
        .order('section', { ascending: true })
        .order('display_order', { ascending: true });

      if (error) {
        workMsg('danger', 'Error cargando preguntas: ' + error.message);
        return;
      }
      questionBank = data || [];

      // llenar select de secciones
      const sel = document.getElementById('filterSection');
      sel.innerHTML = `<option value="">Todas</option>`;
      for (const sec of SECTION_ORDER) {
        const opt = document.createElement('option');
        opt.value = sec;
        opt.textContent = sec;
        sel.appendChild(opt);
      }

      workMsg('success','Banco de preguntas cargado.');
      await loadOrCreateEvaluation();
      await loadAnswers();
      renderQuestions();
      enableWorkButtons(true);
    }

    // =============================
    // DATA: Evaluation instance (draft)
    // =============================
    function todayISO(){
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    async function loadOrCreateEvaluation(){
      if (!sb) return;

      // Seleccionar evaluación más reciente del usuario (draft o submitted)
      const { data, error } = await sb
        .from('evaluations')
        .select('*')
        .eq('evaluator_user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(1);

      if (error) {
        workMsg('danger','Error cargando evaluación: ' + error.message);
        return;
      }

      const last = data?.[0];
      if (last && (last.status === 'draft' || last.status === 'submitted')) {
        currentEval = last;
      } else {
        // crear (incluye evaluator_user_id para RLS/NOT NULL)
        const payload = {
          evaluator_user_id: currentUser.id,
          evaluation_date: todayISO(),
          status: 'draft'
        };

        const { data: ins, error: e2 } = await sb
          .from('evaluations')
          .insert(payload)
          .select()
          .single();

        if (e2) {
          workMsg('danger','Error creando evaluación: ' + e2.message);
          return;
        }
        currentEval = ins;
      }

      updateEvalMeta();
      setStatusBadge(currentEval.status);
    }

    function updateEvalMeta(){
      const el = document.getElementById('evalMeta');
      const name = currentEval?.evaluatee_full_name || '—';
      const date = currentEval?.evaluation_date || '—';
      const lab  = currentEval?.lab_name || '—';
      el.innerHTML = `<b>${escapeHtml(name)}</b><br><span class="soft">Fecha:</span> ${escapeHtml(date)}<br><span class="soft">Lab:</span> ${escapeHtml(lab)}`;
    }

    // =============================
    // DATA: Answers
    // =============================
    async function loadAnswers(){
      if (!sb) return;

      const evalId = getEvalId();
      if (!evalId) return;

      const { data, error } = await sb
        .from('evaluation_answers')
        .select('*')
        .eq('evaluation_id', evalId);

      if (error) {
        workMsg('danger', 'Error cargando respuestas: ' + error.message);
        return;
      }

      answersMap = new Map();
      for (const r of (data || [])){
        answersMap.set(r.question_id, { score: r.score, evidence: r.evidence || '' });
      }

      workMsg('success', 'Respuestas cargadas.');
    }

    async function saveAnswer(question_id, score, evidence){
      if (!sb) return false;

      const evalId = getEvalId();
      if (!evalId) return false;

      const payload = {
        evaluation_id: evalId,
        question_id,
        score,
        evidence: evidence || null
      };

      const { error } = await sb
        .from('evaluation_answers')
        .upsert(payload, { onConflict: 'evaluation_id,question_id' });

      if (error) {
        workMsg('danger','No se pudo guardar respuesta: ' + error.message);
        return false;
      }
      answersMap.set(question_id, { score, evidence: evidence || '' });
      return true;
    }

    // =============================
    // RENDER: Questions
    // =============================
    function scoreClass(score){
      if (score === null || score === undefined) return 'score-ne';
      if (score === 5) return 'score-5';
      if (score === 4) return 'score-4';
      if (score === 3) return 'score-3';
      if (score === 2) return 'score-2';
      if (score === 1) return 'score-1';
      return 'score-ne';
    }

    function renderQuestions(){
      const list = document.getElementById('questionList');
      list.innerHTML = '';

      const secFilter = document.getElementById('filterSection').value;
      const textFilter = document.getElementById('filterText').value.trim().toLowerCase();

      let items = questionBank.slice();
      if (secFilter) items = items.filter(q => q.section === secFilter);
      if (textFilter) items = items.filter(q => (q.question_text || '').toLowerCase().includes(textFilter));

      if (!items.length){
        list.innerHTML = `<div class="soft">No hay preguntas con esos filtros.</div>`;
        return;
      }

      for (const q of items){
        const ans = answersMap.get(q.question_id) || { score: null, evidence: '' };
        const card = document.createElement('div');
        card.className = 'question-card';

        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-semibold">#${q.question_id}. ${escapeHtml(q.question_text || '')}</div>
              <div class="q-meta">${escapeHtml(q.section || '')} • Peso sección: <span class="mono">${SECTION_WEIGHTS[q.section] || 0}%</span></div>
            </div>
            <div class="score-pill ${scoreClass(ans.score)}">${ans.score ?? 'N/E'}</div>
          </div>

          <div class="divider"></div>

          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label small">Calificación (1–5)</label>
              <select class="form-select scoreSel">
                <option value="">No evaluado</option>
                <option value="5">5 - Excelente</option>
                <option value="4">4 - Muy bueno</option>
                <option value="3">3 - Bueno</option>
                <option value="2">2 - Regular</option>
                <option value="1">1 - Deficiente</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label small">Evidencia / Observación (opcional)</label>
              <input class="form-control evInput" placeholder="Describe evidencia, hallazgo o comentario…" />
            </div>
          </div>

          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-sm btn-outline-primary btnSave">
              <i class="bi bi-check2"></i> Guardar
            </button>
          </div>
        `;

        const sel = card.querySelector('.scoreSel');
        if (ans.score) sel.value = String(ans.score);
        const ev = card.querySelector('.evInput');
        ev.value = ans.evidence || '';

        card.querySelector('.btnSave').addEventListener('click', async () => {
          const val = sel.value ? Number(sel.value) : null;
          const evidence = ev.value || '';
          const ok = await saveAnswer(q.question_id, val, evidence);
          if (ok){
            workMsg('success', `Respuesta guardada (#${q.question_id}).`);
            renderQuestions();
            await renderDashboard();
          }
        });

        list.appendChild(card);
      }
    }

    // =============================
    // DASHBOARD
    // =============================
    function computeDashboard(){
      const total = questionBank.length;
      let answered = 0;

      const sectionSum = {};
      const sectionCnt = {};
      for (const sec of SECTION_ORDER){ sectionSum[sec]=0; sectionCnt[sec]=0; }

      const rows = [];
      for (const q of questionBank){
        const ans = answersMap.get(q.question_id) || { score: null, evidence: '' };
        const score = (ans.score === null || ans.score === undefined || ans.score === '') ? null : Number(ans.score);
        const evidence = (ans.evidence || '').trim();

        if (score !== null) {
          answered++;
          sectionSum[q.section] += score;
          sectionCnt[q.section] += 1;
        }

        rows.push({
          question_id: q.question_id,
          section: q.section,
          text: q.question_text,
          score,
          evidence
        });
      }

      const sectionAvg = {};
      for (const sec of SECTION_ORDER){
        sectionAvg[sec] = sectionCnt[sec] ? sectionSum[sec]/sectionCnt[sec] : null;
      }

      let weighted = 0;
      for (const sec of SECTION_ORDER){
        const w = SECTION_WEIGHTS[sec] || 0;
        const avg = sectionAvg[sec];
        const pct = (avg === null) ? 0 : (avg/5)*100;
        weighted += (pct * w/100);
      }
      const score100 = Math.round(weighted * 10) / 10;
      const qual = QUAL_LABEL(score100);

      const criticalLow = rows.filter(r => r.score !== null && r.score <= 2);
      const obsEvidence = rows.filter(r => (r.evidence || '').trim().length > 0);

      return { total, answered, score100, qual, sectionAvg, criticalLow, obsEvidence, rows };
    }

    async function renderDashboard(){
      if (!questionBank.length) return;
      const dash = computeDashboard();
      lastDashboard = { dash, rows: dash.rows };

      document.getElementById('kpiScore').textContent = dash.score100.toFixed(1);
      document.getElementById('kpiQual').textContent = `${dash.qual.label} — ${dash.qual.msg}`;
      document.getElementById('kpiAnswered').textContent = dash.answered;
      document.getElementById('kpiTotal').textContent = dash.total;
      document.getElementById('kpiCritical').textContent = dash.criticalLow.length;

      document.getElementById('dashEvaluatee').textContent = currentEval?.evaluatee_full_name || '—';
      document.getElementById('dashDate').textContent = currentEval?.evaluation_date || '—';
      document.getElementById('dashLab').textContent = currentEval?.lab_name || '—';

      // Firma
      document.getElementById('sigName').textContent = currentEval?.evaluator_full_name || (currentUser?.email || '—');
      document.getElementById('sigRole').textContent = currentEval?.evaluator_role || 'Evaluador';
      document.getElementById('sigDate').textContent = `Fecha: ${currentEval?.evaluation_date || todayISO()}`;

      // Secciones
      const bars = document.getElementById('sectionBars');
      bars.innerHTML = '';
      for (const sec of SECTION_ORDER){
        const avg = dash.sectionAvg[sec];
        const w = SECTION_WEIGHTS[sec];
        const pct = (avg === null) ? 0 : (avg/5)*100;
        const row = document.createElement('div');
        row.innerHTML = `
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">${escapeHtml(sec)} <span class="badge text-bg-light pill ms-1">${w}%</span></div>
            <div class="mono">${avg === null ? 'N/E' : avg.toFixed(2)}</div>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width:${pct}%;"></div>
          </div>
        `;
        bars.appendChild(row);
      }

      // Observaciones
      const obs = document.getElementById('obsList');
      obs.innerHTML = '';
      const items = [];
      for (const c of dash.criticalLow){
        items.push({ kind:'Crítica', ...c });
      }
      for (const e of dash.obsEvidence){
        items.push({ kind:'Evidencia', ...e });
      }

      if (!items.length){
        obs.innerHTML = `<div class="soft">Sin observaciones registradas.</div>`;
      } else {
        for (const it of items.slice(0,40)){
          const box = document.createElement('div');
          box.className = 'p-2 bg-white border rounded';
          box.innerHTML = `
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">#${it.question_id} (${escapeHtml(it.section)}) <span class="badge text-bg-light pill ms-1">${escapeHtml(it.kind)}</span></div>
              <div class="mono">${it.score ?? '—'}</div>
            </div>
            <div class="small">${escapeHtml(it.text)}</div>
            <div class="small soft mt-1"><b>Evidencia:</b> ${escapeHtml(it.evidence || '(vacía)')}</div>
          `;
          obs.appendChild(box);
        }
      }

      // habilitar PDF en dash si finalizada
      const allowPDF = (currentEval?.status === 'submitted');
      document.getElementById('btnPDFDash').disabled = !allowPDF;
    }

    // =============================
    // SUBMIT / DRAFT
    // =============================
    async function setEvaluationStatus(status){
      if (!sb) return false;

      const evalId = getEvalId();
      if (!evalId) return false;

      const idCol = getEvalIdColumn();
      const { data, error } = await sb
        .from('evaluations')
        .update({ status })
        .eq(idCol, evalId)
        .select()
        .single();

      if (error){
        workMsg('danger','No se pudo actualizar estado: ' + error.message);
        return false;
      }
      currentEval = data;
      setStatusBadge(currentEval.status);
      updateEvalMeta();
      enableWorkButtons(true);
      return true;
    }

    // =============================
    // HISTORY
    // =============================
    async function loadHistory(){
      if (!sb) return;

      const list = document.getElementById('historyList');
      list.innerHTML = '<div class="soft">Cargando…</div>';

      const { data, error } = await sb
        .from('evaluations')
        .select('*')
        .eq('evaluator_user_id', currentUser.id)
        .eq('status','submitted')
        .order('created_at', { ascending:false })
        .limit(50);

      if (error){
        list.innerHTML = `<div class="text-danger small">Error: ${escapeHtml(error.message)}</div>`;
        return;
      }

      if (!data?.length){
        list.innerHTML = `<div class="soft">Sin evaluaciones finalizadas.</div>`;
        return;
      }

      list.innerHTML = '';
      for (const e of data){
        const row = document.createElement('div');
        row.className = 'p-2 bg-white border rounded';
        row.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">${escapeHtml(e.evaluatee_full_name || '—')}</div>
              <div class="small soft">${escapeHtml(e.lab_name || '—')} • ${escapeHtml(e.evaluation_date || '—')}</div>
            </div>
            <span class="badge text-bg-success pill">Finalizada</span>
          </div>
        `;
        list.appendChild(row);
      }
    }

    // =============================
    // PDF
    // =============================
    async function downloadPDF() {
      const evalId = getEvalId();
      if (!evalId) return workMsg('danger','No hay evaluación abierta.');
      if (currentEval.status !== 'submitted') {
        workMsg('warning','Para generar el PDF, primero finaliza la evaluación.');
        return;
      }
      if (!lastDashboard) await renderDashboard();

      const { dash, rows } = lastDashboard;

      document.getElementById('pdfDate').textContent = currentEval.evaluation_date || '—';
      document.getElementById('pdfEvaluatee').textContent = currentEval.evaluatee_full_name || '—';
      document.getElementById('pdfLab').textContent = currentEval.lab_name || '—';

      // Evaluador (snapshot desde evaluations)
      const evName = currentEval.evaluator_full_name || (currentUser?.email || '—');
      const evRole = currentEval.evaluator_role || 'Evaluador';
      const evDate = currentEval.evaluation_date || todayISO();

      document.getElementById('pdfSigName').textContent = evName;
      document.getElementById('pdfSigRole').textContent = evRole;
      document.getElementById('pdfSigDate').textContent = `Fecha: ${evDate}`;

      // KPIs
      document.getElementById('pdfScore').textContent = dash.score100.toFixed(1);
      document.getElementById('pdfQual').textContent = dash.qual.label;
      document.getElementById('pdfAnswered').textContent = dash.answered;
      document.getElementById('pdfTotal').textContent = dash.total;
      document.getElementById('pdfCritical').textContent = dash.criticalLow.length;

      const pdfBars = document.getElementById('pdfSectionBars');
      pdfBars.innerHTML = '';
      for (const sec of SECTION_ORDER) {
        const avg = dash.sectionAvg[sec];
        const w = SECTION_WEIGHTS[sec];
        const pct = (avg === null) ? 0 : (avg / 5) * 100;
        const rowEl = document.createElement('div');
        rowEl.innerHTML = `
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">${escapeHtml(sec)} <span class="badge text-bg-light pill ms-1">${w}%</span></div>
            <div class="mono">${avg === null ? 'N/E' : avg.toFixed(2)}</div>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width:${pct}%;"></div>
          </div>
        `;
        pdfBars.appendChild(rowEl);
      }

      // Observaciones: críticos <=2 + evidencias no vacías
      const obs = document.getElementById('pdfObsList');
      obs.innerHTML = '';

      const byQ = new Map(rows.map(r => [r.question_id, r]));
      const obsItems = [];

      for (const c of dash.criticalLow) {
        obsItems.push({
          kind: 'Crítica',
          question_id: c.question_id,
          section: c.section,
          score: c.score,
          text: c.text,
          evidence: c.evidence
        });
      }
      for (const e of dash.obsEvidence) {
        const r = byQ.get(e.question_id);
        if (!r) continue;
        obsItems.push({
          kind: 'Evidencia',
          question_id: r.question_id,
          section: r.section,
          score: r.score ?? '—',
          text: r.text,
          evidence: r.evidence
        });
      }

      if (!obsItems.length) {
        obs.innerHTML = `<div class="soft">Sin observaciones registradas.</div>`;
      } else {
        for (const it of obsItems.slice(0, 40)) {
          const box = document.createElement('div');
          box.className = 'p-2 bg-white border rounded avoid-break';
          box.innerHTML = `
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">#${it.question_id} (${escapeHtml(it.section)}) <span class="badge text-bg-light pill ms-1">${escapeHtml(it.kind)}</span></div>
              <div class="mono">${escapeHtml(String(it.score))}</div>
            </div>
            <div class="small">${escapeHtml(it.text)}</div>
            <div class="small soft mt-1"><b>Evidencia:</b> ${escapeHtml(it.evidence || '(vacía)')}</div>
          `;
          obs.appendChild(box);
        }
      }

      const filename = `Evaluacion_Regente_${(currentEval.evaluatee_full_name || 'Regente').replaceAll(' ', '_')}_${currentEval.evaluation_date || todayISO()}.pdf`;

      const pdfEl = document.getElementById('pdfReport');

      workMsg('info', 'Generando PDF...');

      document.body.classList.add('is-exporting');
      window.scrollTo(0, 0);

      await new Promise(r => requestAnimationFrame(r));

      const opt = {
        margin: [10, 10, 10, 10], // mm
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        pagebreak: { mode: ['css', 'legacy'] },
        html2canvas: {
          scale: 2,
          useCORS: true,
          scrollY: 0,
          scrollX: 0,
          backgroundColor: '#ffffff'
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      try {
        await html2pdf().set(opt).from(pdfEl).save();
        workMsg('success', 'PDF descargado.');
      } catch(e){
        console.error(e);
        workMsg('danger', 'Error generando PDF: ' + (e?.message || e));
      } finally {
        document.body.classList.remove('is-exporting');
      }
    }

    // =============================
    // EVENTS
    // =============================
    document.getElementById('btnApplyFilters').addEventListener('click', () => renderQuestions());

    document.getElementById('btnRefreshDash').addEventListener('click', async () => {
      await renderDashboard();
      workMsg('success','Resumen actualizado.');
    });

    document.getElementById('btnReloadHistory').addEventListener('click', async () => {
      await loadHistory();
    });

    document.getElementById('btnDraft').addEventListener('click', async () => {
      const ok = await setEvaluationStatus('draft');
      if (ok) workMsg('success','Borrador guardado.');
    });

    document.getElementById('btnDraft2').addEventListener('click', async () => {
      const ok = await setEvaluationStatus('draft');
      if (ok) workMsg('success','Borrador guardado.');
    });

    document.getElementById('btnSubmit').addEventListener('click', async () => {
      const ok = await setEvaluationStatus('submitted');
      if (ok) workMsg('success','Evaluación finalizada.');
      await renderDashboard();
      enableWorkButtons(true);
    });

    document.getElementById('btnSubmit2').addEventListener('click', async () => {
      const ok = await setEvaluationStatus('submitted');
      if (ok) workMsg('success','Evaluación finalizada.');
      await renderDashboard();
      enableWorkButtons(true);
    });

    document.getElementById('btnPDFHere').addEventListener('click', async () => {
      await renderDashboard();
      await downloadPDF();
    });

    document.getElementById('btnPDF').addEventListener('click', async () => {
      await renderDashboard();
      switchToDashboardTab();
      await downloadPDF();
    });

    document.getElementById('btnPDFDash').addEventListener('click', async () => {
      await renderDashboard();
      await downloadPDF();
    });

    document.getElementById('btnLogout').addEventListener('click', logout);

    // Tabs
    for (const btn of document.querySelectorAll('#mainTabs .nav-link')){
      btn.addEventListener('click', async () => {
        switchTab(btn.dataset.tab);
        if (btn.dataset.tab === 'tabDash') await renderDashboard();
        if (btn.dataset.tab === 'tabHistory') await loadHistory();
      });
    }

    // Login
    document.getElementById('btnLogin').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      if (!email || !pass) return setLoginMsg('warning','Ingresa correo y contraseña.');

      const u = await login(email, pass);
      if (!u) return;

      currentUser = u;
      document.getElementById('userBadge').textContent = (u.email || 'Usuario');
      document.getElementById('btnLogout').classList.remove('d-none');
      document.getElementById('loginCard').classList.add('d-none');
      document.getElementById('appRoot').classList.remove('d-none');
      workMsg('success','Sesión iniciada.');

      await loadQuestionBank();
      await loadHistory();
      await renderDashboard();
    });

    // Init
    (async () => {
      try {
        setEnvBadge();
        setLoginMsg('secondary','Ingresa tus credenciales para continuar.');
        workMsg('secondary','Listo.');
        enableWorkButtons(false);

        const ok = initSupabase();
        if (!ok){
          document.getElementById('btnLogin').disabled = true;
          setLoginMsg('warning','Configura SUPABASE_URL y SUPABASE_ANON_KEY para habilitar login.');
          workMsg('warning','Supabase no configurado (evita que el sitio se caiga).');
          return;
        }

        // Sesión activa
        const { data, error } = await sb.auth.getUser();
        if (error) console.warn(error);

        if (data?.user){
          currentUser = data.user;
          document.getElementById('userBadge').textContent = (currentUser.email || 'Usuario');
          document.getElementById('btnLogout').classList.remove('d-none');
          document.getElementById('loginCard').classList.add('d-none');
          document.getElementById('appRoot').classList.remove('d-none');
          enableWorkButtons(true);
          setLoginMsg('success', 'Sesión activa: ' + (currentUser.email || 'ok'));
          await loadQuestionBank();
          await loadHistory();
          await renderDashboard();
        }
      } catch (e){
        console.error('Init crash:', e);
        setLoginMsg('danger', 'Error inicializando la app (ver consola).');
        workMsg('danger', e?.message || String(e));
      }
    })();
  </script>
</body>
</html>
