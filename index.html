<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCM Intelligence 2026 | Sistema de Gestión</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root {
            --ccm-blue: #0d6efd;
            --ccm-bg: #f8f9fa;
        }
        body { background-color: var(--ccm-bg); font-family: 'Segoe UI', system-ui, sans-serif; }
        
        /* Loader Overlay */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        
        /* Auth Container */
        .auth-container { max-width: 400px; margin: 80px auto; padding: 2rem; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        /* Dashboard Cards */
        .stat-card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        
        /* Leads Kanban/List Styles */
        .lead-card { border-left: 4px solid #ccc; background: white; margin-bottom: 10px; padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .lead-new { border-left-color: #0d6efd; } /* Azul */
        .lead-urgent { border-left-color: #dc3545; } /* Rojo SLA */
        .lead-done { border-left-color: #198754; } /* Verde */
        
        /* Navigation */
        .sidebar { min-height: 100vh; background: white; border-right: 1px solid #dee2e6; }
        .nav-link { color: #495057; font-weight: 500; }
        .nav-link.active { color: var(--ccm-blue); background: #e9ecef; border-radius: 5px; }
        
        /* Utilities */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted" id="loader-text">Conectando con CCM Intelligence...</p>
    </div>

    <div id="login-view" class="container hidden">
        <div class="auth-container">
            <div class="text-center mb-4">
                <h3 class="fw-bold">CCM Intelligence</h3>
                <p class="text-muted">Acceso al Plan Digital 2026</p>
            </div>
            <form id="login-form">
                <div class="mb-3">
                    <label class="form-label">Correo Electrónico</label>
                    <input type="email" id="email" class="form-control" placeholder="usuario@grupoccm.com" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Contraseña</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2">Iniciar Sesión</button>
                <div id="login-error" class="text-danger mt-3 text-center small"></div>
            </form>
        </div>
    </div>

    <div id="app-view" class="d-flex hidden">
        
        <div class="sidebar d-flex flex-column flex-shrink-0 p-3" style="width: 250px;">
            <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
                <span class="fs-5 fw-bold text-primary"><i class="bi bi-activity"></i> CCM 2026</span>
            </a>
            <hr>
            <div class="mb-3 px-2">
                <small class="text-muted">Usuario:</small>
                <div class="fw-bold" id="user-name-display">--</div>
                <span class="badge bg-secondary" id="user-role-display">Staff</span>
            </div>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="navigate('dashboard')"><i class="bi bi-speedometer2 me-2"></i> Tablero</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="navigate('campaigns')"><i class="bi bi-calendar-check me-2"></i> Campañas</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="navigate('pieces')"><i class="bi bi-collection-play me-2"></i> Piezas & Mix</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="navigate('leads')"><i class="bi bi-people me-2"></i> CRM & Triage</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="navigate('metrics')"><i class="bi bi-bar-chart-line me-2"></i> Cargar Métricas</a>
                </li>
            </ul>
            <hr>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Cerrar Sesión</button>
        </div>

        <div class="flex-grow-1 p-4" style="height: 100vh; overflow-y: auto;">
            
            <div id="view-dashboard" class="content-section">
                <h2 class="mb-4">Resumen Estratégico</h2>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card stat-card p-3">
                            <h6 class="text-muted">Leads Totales (Mes)</h6>
                            <h3 class="fw-bold" id="kpi-leads">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card p-3">
                            <h6 class="text-muted">Conversión (Citas)</h6>
                            <h3 class="fw-bold text-success" id="kpi-conversion">0%</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card p-3">
                            <h6 class="text-muted">Gasto Pauta (Est.)</h6>
                            <h3 class="fw-bold text-danger" id="kpi-spend">$0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card p-3">
                            <h6 class="text-muted">Campaña Activa</h6>
                            <h5 class="fw-bold text-primary" id="kpi-campaign">--</h5>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-campaigns" class="content-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Plan de Campañas 2026</h2>
                    <button class="btn btn-primary btn-sm" onclick="openModal('modal-campaign')" id="btn-add-campaign"><i class="bi bi-plus-lg"></i> Nueva Campaña</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover bg-white rounded shadow-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Bimestre</th>
                                <th>Campaña</th>
                                <th>Lead Magnet</th>
                                <th>Estado</th>
                                <th>Objetivo</th>
                            </tr>
                        </thead>
                        <tbody id="table-campaigns-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-pieces" class="content-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Piezas de Contenido</h2>
                    <button class="btn btn-primary btn-sm" onclick="openModal('modal-piece')"><i class="bi bi-plus-lg"></i> Nueva Pieza</button>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="filter-piece-campaign" onchange="loadPieces()">
                            <option value="">Todas las campañas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="filter-piece-format" onchange="loadPieces()">
                            <option value="">Todos los formatos</option>
                            <option value="reel">Reel/Short</option>
                            <option value="carousel">Carousel</option>
                            <option value="story">Story</option>
                            <option value="impreso">Impreso/Offline</option>
                        </select>
                    </div>
                </div>

                <div class="row" id="pieces-grid">
                    </div>
            </div>

            <div id="view-leads" class="content-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Gestión de Pacientes (CRM)</h2>
                    <button class="btn btn-success btn-sm" onclick="openModal('modal-lead')"><i class="bi bi-whatsapp"></i> Nuevo Lead Manual</button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="bg-light p-2 rounded">
                            <h6 class="fw-bold text-uppercase text-muted small">Por Contactar / Triage</h6>
                            <div id="leads-new-list"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light p-2 rounded">
                            <h6 class="fw-bold text-uppercase text-muted small">Agendados / Cotizando</h6>
                            <div id="leads-active-list"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light p-2 rounded">
                            <h6 class="fw-bold text-uppercase text-muted small">Resultados (Cierre)</h6>
                            <div id="leads-closed-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="view-metrics" class="content-section hidden">
                 <h2 class="mb-4">Carga de Resultados</h2>
                 <div class="card p-4 shadow-sm" style="max-width: 600px;">
                     <form id="form-metrics">
                         <div class="mb-3">
                             <label class="form-label">Pieza / Contenido</label>
                             <select class="form-select" id="metric-piece-select" required></select>
                         </div>
                         <div class="row">
                             <div class="col-md-6 mb-3">
                                 <label class="form-label">Fecha Corte</label>
                                 <input type="date" class="form-control" id="metric-date" required>
                             </div>
                             <div class="col-md-6 mb-3">
                                 <label class="form-label">Gasto ($ USD)</label>
                                 <input type="number" step="0.01" class="form-control" id="metric-spend" placeholder="0.00">
                             </div>
                         </div>
                         <div class="row">
                             <div class="col-md-6 mb-3">
                                 <label class="form-label">Alcance / Vistas</label>
                                 <input type="number" class="form-control" id="metric-volume">
                             </div>
                             <div class="col-md-6 mb-3">
                                 <label class="form-label">Interacciones / Clics</label>
                                 <input type="number" class="form-control" id="metric-interaction">
                             </div>
                         </div>
                         <button type="submit" class="btn btn-primary w-100">Guardar Métricas</button>
                     </form>
                 </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="modal-campaign" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Campaña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-campaign">
                        <div class="mb-2">
                            <label>Nombre Campaña</label>
                            <input type="text" class="form-control" id="camp-name" required>
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <label>Bimestre</label>
                                <select class="form-select" id="camp-bimester">
                                    <option value="B1">B1 (Ene-Feb)</option>
                                    <option value="B2">B2 (Mar-Abr)</option>
                                    <option value="B3">B3 (May-Jun)</option>
                                    <option value="B4">B4 (Jul-Ago)</option>
                                    <option value="B5">B5 (Sep-Oct)</option>
                                    <option value="B6">B6 (Nov-Dic)</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>Lead Magnet</label>
                                <input type="text" class="form-control" id="camp-magnet" placeholder="Ej: Quiz">
                            </div>
                        </div>
                        <div class="mb-2">
                            <label>Objetivo</label>
                            <textarea class="form-control" id="camp-obj" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-2">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-lead-edit" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestionar Paciente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-lead-id">
                    <h5 id="edit-lead-name" class="fw-bold"></h5>
                    <p class="text-muted small mb-3">Origen: <span id="edit-lead-source"></span></p>
                    
                    <label class="form-label fw-bold">Acción de Triaje</label>
                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="updateLeadStatus('contactado')">Marcar como Contactado</button>
                        <button class="btn btn-outline-success btn-sm" onclick="updateLeadStatus('agendado')">✅ Agendar Cita</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateLeadStatus('cotizacion')">Enviar Cotización</button>
                    </div>

                    <hr>
                    <label class="form-label fw-bold">Cierre (Resultado Final)</label>
                    <select class="form-select mb-2" id="edit-lead-outcome">
                        <option value="pendiente">Pendiente</option>
                        <option value="asistio">Asistió (Show)</option>
                        <option value="no_show">No Show</option>
                        <option value="servicio_completado">Servicio Completado ($)</option>
                    </select>
                    
                    <div id="ticket-field" class="hidden mb-3">
                        <label>Valor del Ticket ($)</label>
                        <input type="number" id="edit-lead-ticket" class="form-control" placeholder="0.00">
                    </div>

                    <button class="btn btn-primary w-100" onclick="saveLeadOutcome()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modal-piece" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Pieza de Contenido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-piece">
                        <div class="mb-2">
                            <label>Nombre Interno</label>
                            <input type="text" class="form-control" id="piece-name" required placeholder="Ej: Video Síntomas Diabetes">
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <label>Formato</label>
                                <select class="form-select" id="piece-format">
                                    <option value="reel">Reel/Short (Video)</option>
                                    <option value="carousel">Carousel (Imágenes)</option>
                                    <option value="story">Story</option>
                                    <option value="long_form">Video Largo/Blog</option>
                                    <option value="evento_fisico">Evento Offline</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>Campaña</label>
                                <select class="form-select" id="piece-campaign-select" required>
                                    </select>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label>Hook / Gancho (Copy)</label>
                            <input type="text" class="form-control" id="piece-hook" placeholder="Primeros 3 segs del video...">
                        </div>
                        <div class="mb-2">
                            <label>Estado</label>
                            <select class="form-select" id="piece-status">
                                <option value="idea">Idea / Borrador</option>
                                <option value="produccion">En Producción</option>
                                <option value="publicado">Publicado</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-2">Guardar Pieza</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modal-lead" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Lead Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-lead-new">
                        <div class="mb-2">
                            <label>Nombre Completo</label>
                            <input type="text" class="form-control" id="new-lead-name" required>
                        </div>
                        <div class="mb-2">
                            <label>Teléfono / Contacto</label>
                            <input type="text" class="form-control" id="new-lead-phone">
                        </div>
                        <div class="mb-2">
                            <label>Origen (Detalle)</label>
                            <input type="text" class="form-control" id="new-lead-source" placeholder="Ej: Llamada, Facebook, Lobby">
                        </div>
                        <button type="submit" class="btn btn-success w-100 mt-2">Registrar Lead</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==========================================
        // 1. CONFIGURACIÓN SUPABASE (¡EDITAR AQUÍ!)
        // ==========================================
        // Reemplaza con tus valores de Supabase (Project Settings -> API)
        const SUPABASE_URL = 'https://rofwgcrsfrovspiholbo.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_M7gyUpsbCPRopdrmDjEeLA_SHXlnP-C';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error("Error inicializando Supabase:", e);
            alert("Error configurando Supabase. Revisa tus llaves en el código.");
        }

        // Estado Global
        let currentUser = null;
        let currentRole = 'staff';

        // ==========================================
        // 2. AUTH & INICIALIZACIÓN (ROBUSTA)
        // ==========================================
        async function initApp() {
            console.log("Iniciando aplicación...");
            
            try {
                showLoader(true);
                
                // 1. Verificar si Supabase se cargó bien
                if (!supabase) throw new Error("Cliente Supabase no inicializado.");

                // 2. Verificar Sesión
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error("Error obteniendo sesión:", error);
                    throw error;
                }

                const session = data.session;
                console.log("Estado de sesión:", session ? "Activa" : "Inactiva");

                if (session) {
                    currentUser = session.user;
                    await fetchUserRole(currentUser.id);
                    showView('app-view');
                    try { await loadDashboardData(); } catch(e) { console.warn("Error cargando datos dashboard:", e); }
                } else {
                    showView('login-view');
                }

            } catch (err) {
                console.error("CRITICAL INIT ERROR:", err);
                alert("Error al conectar con el sistema: " + (err.message || err));
                showView('login-view'); // Fallback seguro
            } finally {
                // ESTO GARANTIZA QUE EL LOADER SE VAYA SIEMPRE
                showLoader(false);
            }
        }

        async function fetchUserRole(uid) {
            try {
                const { data, error } = await supabase.from('profiles').select('role, full_name').eq('id', uid).single();
                if (data) {
                    currentRole = data.role;
                    document.getElementById('user-name-display').innerText = data.full_name || currentUser.email;
                    document.getElementById('user-role-display').innerText = (data.role || 'staff').toUpperCase();
                    
                    // Ocultar botones según rol
                    if (currentRole === 'staff') {
                        const btnCamp = document.getElementById('btn-add-campaign');
                        if(btnCamp) btnCamp.classList.add('hidden');
                    }
                }
            } catch (e) {
                console.warn("No se pudo obtener el perfil extendido", e);
            }
        }

        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoader(true);
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            
            showLoader(false);
            if (error) {
                document.getElementById('login-error').innerText = error.message;
            } else {
                window.location.reload();
            }
        }

        async function logout() {
            showLoader(true);
            await supabase.auth.signOut();
            window.location.reload();
        }

        // ==========================================
        // 3. LOGICA DE NAVEGACIÓN
        // ==========================================
        function showView(viewId) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.add('hidden');
            
            const target = document.getElementById(viewId);
            if(target) target.classList.remove('hidden');
        }

        function navigate(tabName) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            const view = document.getElementById(`view-${tabName}`);
            if(view) view.classList.remove('hidden');
            
            // Highlight nav
            const navLink = document.querySelector(`[onclick="navigate('${tabName}')"]`);
            if(navLink) navLink.classList.add('active');

            // Cargar datos según tab
            if (tabName === 'campaigns') loadCampaigns();
            if (tabName === 'pieces') loadPieces();
            if (tabName === 'leads') loadLeads();
            if (tabName === 'metrics') loadMetricsForm();
        }

        function showLoader(show) {
            const l = document.getElementById('loader');
            if(l) l.style.display = show ? 'flex' : 'none';
        }

        function openModal(modalId) {
            const el = document.getElementById(modalId);
            if(el) new bootstrap.Modal(el).show();
            
            // Si abrimos modal de pieza, cargar campañas en el select
            if(modalId === 'modal-piece') loadCampaignSelect();
        }

        // ==========================================
        // 4. CAMPAÑAS
        // ==========================================
        async function loadCampaigns() {
            const { data, error } = await supabase.from('campaigns').select('*').order('bimester');
            const tbody = document.getElementById('table-campaigns-body');
            tbody.innerHTML = '';

            if(data) {
                data.forEach(camp => {
                    const row = `<tr>
                        <td><span class="badge bg-info text-dark">${camp.bimester}</span></td>
                        <td class="fw-bold">${camp.name}</td>
                        <td>${camp.lead_magnet || '-'}</td>
                        <td>${camp.status}</td>
                        <td><small>${camp.objective}</small></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
        }

        document.getElementById('form-campaign').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCamp = {
                name: document.getElementById('camp-name').value,
                bimester: document.getElementById('camp-bimester').value,
                lead_magnet: document.getElementById('camp-magnet').value,
                objective: document.getElementById('camp-obj').value,
                start_date: '2026-01-01', // Default
                end_date: '2026-02-28'
            };
            
            const { error } = await supabase.from('campaigns').insert([newCamp]);
            if(!error) {
                bootstrap.Modal.getInstance(document.getElementById('modal-campaign')).hide();
                loadCampaigns();
                alert("Campaña creada");
            } else {
                alert('Error: ' + error.message);
            }
        });

        // ==========================================
        // 5. PIEZAS
        // ==========================================
        async function loadPieces() {
            let query = supabase.from('pieces').select('*, campaigns(name), channels(name)');
            
            const campFilter = document.getElementById('filter-piece-campaign').value;
            const fmtFilter = document.getElementById('filter-piece-format').value;
            
            if(campFilter) query = query.eq('campaign_id', campFilter);
            if(fmtFilter) query = query.eq('format', fmtFilter);
            
            const { data } = await query;
            const grid = document.getElementById('pieces-grid');
            grid.innerHTML = '';

            // Llenar filtro de campañas si está vacío
            const filterSelect = document.getElementById('filter-piece-campaign');
            if(filterSelect.options.length <= 1) {
               const { data: camps } = await supabase.from('campaigns').select('id, name, bimester');
               if(camps) {
                   camps.forEach(c => {
                       filterSelect.innerHTML += `<option value="${c.id}">${c.bimester}: ${c.name}</option>`;
                   });
               }
            }

            if(data) {
                data.forEach(p => {
                    const statusColor = p.status === 'publicado' ? 'bg-success' : 'bg-warning';
                    const card = `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <span class="badge bg-secondary mb-2">${p.format}</span>
                                <h6 class="card-title fw-bold text-primary">${p.name}</h6>
                                <p class="card-text small text-muted fst-italic">"${p.hook_copy || 'Sin hook'}"</p>
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                                    <small class="text-truncate" style="max-width: 120px;">${p.campaigns?.name || 'Gral'}</small>
                                    <span class="badge ${statusColor}">${p.status}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    grid.innerHTML += card;
                });
            }
        }
        
        async function loadCampaignSelect() {
             const select = document.getElementById('piece-campaign-select');
             select.innerHTML = '';
             const { data } = await supabase.from('campaigns').select('id, name');
             if(data) {
                 data.forEach(c => {
                     select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                 });
             }
        }

        document.getElementById('form-piece').addEventListener('submit', async (e) => {
            e.preventDefault();
            const piece = {
                name: document.getElementById('piece-name').value,
                format: document.getElementById('piece-format').value,
                campaign_id: document.getElementById('piece-campaign-select').value,
                hook_copy: document.getElementById('piece-hook').value,
                status: document.getElementById('piece-status').value
            };
            const { error } = await supabase.from('pieces').insert([piece]);
            if(!error) {
                bootstrap.Modal.getInstance(document.getElementById('modal-piece')).hide();
                loadPieces();
            } else {
                alert("Error al guardar pieza: " + error.message);
            }
        });

        // ==========================================
        // 6. LEADS & CRM
        // ==========================================
        async function loadLeads() {
            const { data } = await supabase.from('leads').select('*').order('created_at', { ascending: false });
            
            const listNew = document.getElementById('leads-new-list');
            const listActive = document.getElementById('leads-active-list');
            const listClosed = document.getElementById('leads-closed-list');
            
            listNew.innerHTML = ''; listActive.innerHTML = ''; listClosed.innerHTML = '';

            if(data) {
                data.forEach(lead => {
                    const created = new Date(lead.created_at);
                    const now = new Date();
                    // SLA check: 15 mins
                    const isUrgent = (now - created)/60000 > 15 && lead.triage_status === 'nuevo';
                    
                    let borderClass = 'lead-new';
                    if (isUrgent) borderClass = 'lead-urgent';
                    if (lead.clinical_outcome !== 'pendiente') borderClass = 'lead-done';

                    const html = `
                    <div class="lead-card ${borderClass}" onclick="editLead('${lead.id}')" style="cursor:pointer">
                        <div class="d-flex justify-content-between">
                            <strong>${lead.full_name}</strong>
                            <small>${created.toLocaleDateString()}</small>
                        </div>
                        <div class="small text-muted">${lead.source_detail || 'Sin origen'}</div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="badge bg-light text-dark border">${lead.triage_status}</span>
                            ${isUrgent ? '<span class="badge bg-danger">SLA!</span>' : ''}
                        </div>
                    </div>`;

                    if (lead.clinical_outcome !== 'pendiente') {
                        listClosed.innerHTML += html;
                    } else if (['agendado', 'cotizacion', 'contactado'].includes(lead.triage_status)) {
                        listActive.innerHTML += html;
                    } else {
                        listNew.innerHTML += html;
                    }
                });
            }
        }
        
        // Crear nuevo lead
        document.getElementById('form-lead-new').addEventListener('submit', async (e) => {
            e.preventDefault();
            const lead = {
                full_name: document.getElementById('new-lead-name').value,
                phone: document.getElementById('new-lead-phone').value,
                source_detail: document.getElementById('new-lead-source').value,
                triage_status: 'nuevo'
            };
            const { error } = await supabase.from('leads').insert([lead]);
            if(!error) {
                bootstrap.Modal.getInstance(document.getElementById('modal-lead')).hide();
                loadLeads();
            } else {
                alert("Error: " + error.message);
            }
        });

        let currentLeadId = null;
        async function editLead(id) {
            currentLeadId = id;
            const { data } = await supabase.from('leads').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('edit-lead-name').innerText = data.full_name;
                document.getElementById('edit-lead-source').innerText = data.source_detail || 'N/A';
                document.getElementById('edit-lead-outcome').value = data.clinical_outcome;
                toggleTicketField();
                new bootstrap.Modal(document.getElementById('modal-lead-edit')).show();
            }
        }

        document.getElementById('edit-lead-outcome').addEventListener('change', toggleTicketField);

        function toggleTicketField() {
            const val = document.getElementById('edit-lead-outcome').value;
            const field = document.getElementById('ticket-field');
            if(val === 'servicio_completado') field.classList.remove('hidden');
            else field.classList.add('hidden');
        }

        async function updateLeadStatus(status) {
            if(!currentLeadId) return;
            await supabase.from('leads').update({ triage_status: status }).eq('id', currentLeadId);
            bootstrap.Modal.getInstance(document.getElementById('modal-lead-edit')).hide();
            loadLeads();
        }

        async function saveLeadOutcome() {
            if(!currentLeadId) return;
            const outcome = document.getElementById('edit-lead-outcome').value;
            const ticket = document.getElementById('edit-lead-ticket').value || 0;
            
            await supabase.from('leads').update({ 
                clinical_outcome: outcome,
                ticket_value: ticket
            }).eq('id', currentLeadId);
            
            bootstrap.Modal.getInstance(document.getElementById('modal-lead-edit')).hide();
            loadLeads();
        }

        // ==========================================
        // 7. MÉTRICAS
        // ==========================================
        async function loadMetricsForm() {
            // Llenar select de piezas
            const { data } = await supabase.from('pieces').select('id, name, format');
            const select = document.getElementById('metric-piece-select');
            select.innerHTML = '';
            if(data) {
                data.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">[${p.format}] ${p.name}</option>`;
                });
            }
            document.getElementById('metric-date').valueAsDate = new Date();
        }

        document.getElementById('form-metrics').addEventListener('submit', async (e) => {
            e.preventDefault();
            const metricData = {
                piece_id: document.getElementById('metric-piece-select').value,
                date: document.getElementById('metric-date').value,
                spend: document.getElementById('metric-spend').value || 0,
                volume: document.getElementById('metric-volume').value || 0,
                interactions: document.getElementById('metric-interaction').value || 0
            };
            
            const { error } = await supabase.from('piece_metrics').insert([metricData]);
            
            if(!error) {
                alert('Métricas guardadas correctamente');
                document.getElementById('form-metrics').reset();
            } else {
                alert('Error (probablemente ya existe métrica para esa fecha/pieza): ' + error.message);
            }
        });

        // ==========================================
        // 8. DASHBOARD KPI
        // ==========================================
        async function loadDashboardData() {
            // Simple counts
            const { count: leadsCount } = await supabase.from('leads').select('*', { count: 'exact', head: true });
            document.getElementById('kpi-leads').innerText = leadsCount || 0;
            
            // Conversión: Leads con outcome != pendiente
            const { count: converted } = await supabase.from('leads').select('*', { count: 'exact', head: true }).neq('clinical_outcome', 'pendiente');
            const rate = leadsCount > 0 ? Math.round((converted/leadsCount)*100) : 0;
            document.getElementById('kpi-conversion').innerText = rate + "%";
            
            // Campaña activa (la que tenga fecha actual en rango, o la ultima creada)
            const { data: activeCamp } = await supabase.from('campaigns').select('name').eq('status', 'activa').limit(1);
            if(activeCamp && activeCamp.length > 0) {
                document.getElementById('kpi-campaign').innerText = activeCamp[0].name;
            } else {
                document.getElementById('kpi-campaign').innerText = "Ninguna";
            }
        }

        // LISTENERS
        document.getElementById('login-form').addEventListener('submit', login);

        // START
        initApp();

    </script>
</body>
</html>

