<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grupo CCM | Plan Digital 2026</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --r: 12px;
    }

    body{
      background: var(--bg-body);
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .navbar-ccm {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      padding: 0.75rem 0;
    }
    .brand-title { font-weight: 700; font-size: 1rem; color: #111827; letter-spacing: -0.025em; }
    .brand-sub { font-size: 0.75rem; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .brand-icon { width: 32px; height: 32px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary); }

    .app-shell{ max-width: 1400px; }

    .cardx {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--r);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .cardx:hover { box-shadow: var(--shadow-md); }

    .section-title { font-weight: 700; color: #111827; letter-spacing: -0.025em; font-size: 1.25rem; }
    .mini { color: var(--text-muted); font-size: 0.875rem; }
    .mono { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.85em; color: var(--primary); background: #eff6ff; padding: 2px 6px; border-radius: 4px; }

    .btn { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem; border: 1px solid transparent; transition: all 0.2s; }
    .btn-primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); transform: translateY(-1px); }
    .btn-light { background: #fff; border-color: var(--border-color); color: #374151; }
    .btn-light:hover { background: #f9fafb; border-color: #d1d5db; color: #111827; }

    .nav-tabs { border-bottom: 1px solid var(--border-color); gap: 1rem; }
    .nav-tabs .nav-link { border: none; color: var(--text-muted); font-weight: 500; padding: 0.75rem 0.25rem; background: transparent; transition: color 0.2s; }
    .nav-tabs .nav-link:hover { color: var(--primary); }
    .nav-tabs .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); background: transparent; }

    .table thead th {
      background: #f9fafb;
      color: #6b7280;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      white-space: nowrap;
    }
    .table tbody td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.875rem; }
    .table-hover tbody tr:hover { background: #f9fafb; }

    .badge-status { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .badge-status::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .st-draft { background: #f3f4f6; color: #4b5563; }
    .st-scheduled { background: #eff6ff; color: #2563eb; }
    .st-published { background: #ecfdf5; color: #059669; }
    .st-paused { background: #fffbeb; color: #d97706; }
    .st-closed { background: #fef2f2; color: #dc2626; }

    .form-control, .form-select { border-radius: 8px; border-color: var(--border-color); padding: 0.6rem 0.75rem; font-size: 0.875rem; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

    .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .loading .box { background: white; padding: 20px 40px; border-radius: 12px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 10px; }

    .alert-stack { position: fixed; top: 80px; right: 20px; z-index: 2500; display: flex; flex-direction: column; gap: 10px; width: 380px; }
    .alert-card { background: white; border: 1px solid var(--border-color); border-left: 4px solid var(--primary); border-radius: 8px; box-shadow: var(--shadow-md); padding: 12px 16px; display: flex; gap: 12px; align-items: start; animation: slideIn 0.3s ease; }
    .alert-card.success { border-left-color: #059669; }
    .alert-card.danger { border-left-color: #dc2626; }

    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .hidden { display: none !important; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>

<body>
  <div class="alert-stack" id="alertStack"></div>

  <nav class="navbar navbar-ccm sticky-top">
    <div class="container-fluid app-shell px-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-icon"><i class="bi bi-grid-fill"></i></div>
        <div class="min-w-0">
          <div class="brand-title">Grupo CCM</div>
          <div class="brand-sub">Plan Digital 2026</div>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge bg-light text-dark border fw-normal py-2 px-3 rounded-pill" id="whoami">Cargando...</span>
        <button class="btn btn-light btn-sm" id="btnLogout" disabled><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell my-5 px-4">

    <div id="loginView" class="cardx p-5 mx-auto" style="max-width: 480px;">
      <div class="text-center mb-4">
        <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3" style="width: 48px; height: 48px;"><i class="bi bi-shield-lock-fill fs-5"></i></div>
        <h4 class="fw-bold">Iniciar Sesión</h4>
        <p class="text-muted small">Accede al panel de control de Marketing</p>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold small">Correo electrónico</label>
        <input type="email" class="form-control" id="loginEmail" placeholder="nombre@grupoccm.com" autocomplete="username">
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold small">Contraseña</label>
        <input type="password" class="form-control" id="loginPass" placeholder="••••••••" autocomplete="current-password">
      </div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-link px-0 small text-decoration-none" id="btnForgotPass" type="button">¿Olvidaste tu clave?</button>
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSignIn">Ingresar al Sistema</button>
      <div class="text-center mt-3 small text-muted">Powered by Supabase</div>
    </div>

    <div id="appView" class="hidden">
      <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
        <div>
          <h3 class="fw-bold mb-1">Panel de Control</h3>
          <div class="mini">Gestión de campañas, piezas, métricas y leads (esquema real Supabase).</div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-primary" id="btnNewCampaign"><i class="bi bi-plus-lg me-1"></i>Campaña</button>
          <button class="btn btn-primary" id="btnNewPiece"><i class="bi bi-plus-lg me-1"></i>Pieza</button>
          <button class="btn btn-primary" id="btnNewMetric"><i class="bi bi-plus-lg me-1"></i>Métrica</button>
          <button class="btn btn-primary" id="btnNewLead"><i class="bi bi-plus-lg me-1"></i>Lead</button>
        </div>
      </div>

      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCampaigns" type="button" role="tab">
            <i class="bi bi-calendar-range me-2"></i>Campañas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPieces" type="button" role="tab">
            <i class="bi bi-grid me-2"></i>Piezas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMetrics" type="button" role="tab">
            <i class="bi bi-bar-chart me-2"></i>Métricas (volume / interactions / spend)
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLeads" type="button" role="tab">
            <i class="bi bi-people me-2"></i>Leads
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- CAMPAIGNS -->
        <div class="tab-pane fade show active" id="tabCampaigns" role="tabpanel">
          <div class="cardx">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-light bg-opacity-50">
              <span class="fw-bold small text-uppercase text-muted">Listado de Campañas</span>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-white border" id="btnReloadCampaigns"><i class="bi bi-arrow-clockwise"></i></button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblCampaigns">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Bimestre</th>
                    <th>Nombre</th>
                    <th>Objetivo</th>
                    <th>Vigencia</th>
                    <th>Status</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PIECES -->
        <div class="tab-pane fade" id="tabPieces" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="fCamp"></select>
                </div>

                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Canal</label>
                  <select class="form-select" id="fChannel"></select>
                </div>

                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Status</label>
                  <select class="form-select" id="fStatus">
                    <option value="">Todos</option>
                    <option value="idea">idea</option>
                    <option value="borrador">borrador</option>
                    <option value="programado">programado</option>
                    <option value="publicado">publicado</option>
                    <option value="pausado">pausado</option>
                  </select>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input class="form-control border-start-0 ps-0" id="fQ" placeholder="nombre / hook / ad_id ...">
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblPieces">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Campaña</th>
                    <th>Canal</th>
                    <th>Nombre</th>
                    <th>Formato</th>
                    <th>Pilar</th>
                    <th>Status</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadPieces">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla
              </button>
            </div>
          </div>
        </div>

        <!-- METRICS -->
        <div class="tab-pane fade" id="tabMetrics" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="mPiece"></select>
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Desde</label>
                  <input type="date" class="form-control" id="mFrom">
                </div>
                <div class="col-6 col-md-2">
                  <label class="form-label mini fw-bold">Hasta</label>
                  <input type="date" class="form-control" id="mTo">
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end">
                  <button class="btn btn-light w-100" id="btnReloadMetrics"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblMetrics">
                <thead class="text-center">
                  <tr>
                    <th class="text-start">Pieza</th>
                    <th>Fecha</th>
                    <th>Volume</th>
                    <th>Interactions</th>
                    <th>Spend</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- LEADS -->
        <div class="tab-pane fade" id="tabLeads" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="lCamp"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="lPiece"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <input class="form-control" id="lQ" placeholder="nombre, teléfono, email...">
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblLeads">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Origen</th>
                    <th>Nombre</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Triage</th>
                    <th>Outcome</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadLeads">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Forgot Pass -->
  <div class="modal fade" id="forgotPassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Recuperar Acceso</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small">Ingresa tu correo y te enviaremos un enlace de recuperación.</p>
          <input type="email" class="form-control mb-3" id="fp_email" placeholder="tu@correo.com">
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" id="btnSendResetEmail">Enviar enlace</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Set New Pass -->
  <div class="modal fade" id="setNewPassModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Nueva Contraseña</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
             <label class="form-label small fw-bold">Contraseña nueva</label>
             <input type="password" class="form-control" id="np1">
          </div>
          <div class="mb-4">
             <label class="form-label small fw-bold">Confirmar</label>
             <input type="password" class="form-control" id="np2">
          </div>
          <button class="btn btn-primary w-100" id="btnSetNewPass">Actualizar Password</button>
          <div class="small text-muted mt-2">Al finalizar te regresará al login automáticamente.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Campaign Modal -->
  <div class="modal fade" id="campaignModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="campaignModalTitle">Campaña</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="c_id">
          <div class="row g-3">
            <div class="col-6">
              <label class="form-label small fw-bold">Bimestre (NOT NULL)</label>
              <select class="form-select" id="c_bim">
                <option value="">Seleccionar...</option>
                <option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option>
                <option value="B4">B4</option><option value="B5">B5</option><option value="B6">B6</option>
              </select>
              <div class="mini mt-1">Tu tipo es <span class="mono">campaign_bimester</span>; esto asume valores B1..B6.</div>
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Status</label>
              <input class="form-control" id="c_status" placeholder="planificada / activa / ...">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Nombre (NOT NULL)</label>
              <input class="form-control" id="c_name" placeholder="Ej: Diabetes Control">
            </div>
            <div class="col-12">
              <label class="form-label small fw-bold">Objetivo</label>
              <input class="form-control" id="c_objective" placeholder="Ej: Generar 50 leads cualificados">
            </div>

            <div class="col-6">
              <label class="form-label small fw-bold">Inicio (NOT NULL)</label>
              <input type="date" class="form-control" id="c_start">
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Fin (NOT NULL)</label>
              <input type="date" class="form-control" id="c_end">
            </div>

            <div class="col-6">
              <label class="form-label small fw-bold">Budget Planned</label>
              <input type="number" class="form-control" id="c_budget" min="0" step="0.01">
            </div>

            <div class="col-6">
              <label class="form-label small fw-bold">Anchor Event</label>
              <input class="form-control" id="c_anchor">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Lead Magnet</label>
              <input class="form-control" id="c_magnet">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveCampaign">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Piece Modal -->
  <div class="modal fade" id="pieceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="pieceModalTitle">Pieza</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="p_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Campaña</label>
              <select class="form-select" id="p_campaign"></select>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Canal (channel_id)</label>
              <select class="form-select" id="p_channel_id"></select>
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Nombre (NOT NULL)</label>
              <input class="form-control" id="p_name" placeholder="Ej: Reel - Beneficios control glucosa">
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Formato (NOT NULL)</label>
              <input class="form-control" id="p_format" placeholder="(enum piece_format)">
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Pillar</label>
              <input class="form-control" id="p_pillar" placeholder="educación / conversión / ...">
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Status</label>
              <input class="form-control" id="p_status" placeholder="idea / publicado / ...">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Hook Copy (hook_copy)</label>
              <textarea class="form-control" id="p_hook_copy" rows="2"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Visual Style</label>
              <input class="form-control" id="p_visual_style">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">CTA Destination</label>
              <input class="form-control" id="p_cta_destination">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Ad ID</label>
              <input class="form-control" id="p_ad_id" placeholder="ID anuncio (Meta/Google)">
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button class="btn btn-primary" id="btnSavePiece">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Metric Modal -->
  <div class="modal fade" id="metricModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="metricModalTitle">Registro de Métricas</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="mx_id">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Pieza</label>
              <select class="form-select" id="mx_piece"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Fecha (date)</label>
              <input type="date" class="form-control" id="mx_date">
            </div>

            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-light w-100" id="btnPrefillMetricToday" type="button">
                <i class="bi bi-calendar2-check me-1"></i>Hoy
              </button>
            </div>

            <div class="col-12"><hr class="text-muted"></div>

            <div class="col-4 text-center">
              <label class="form-label small text-muted">Volume</label>
              <input class="form-control text-center fw-bold" id="mx_volume" type="number" min="0">
            </div>
            <div class="col-4 text-center">
              <label class="form-label small text-muted">Interactions</label>
              <input class="form-control text-center fw-bold" id="mx_interactions" type="number" min="0">
            </div>
            <div class="col-4 text-center">
              <label class="form-label small text-primary fw-bold">Spend</label>
              <input class="form-control text-center fw-bold border-primary" id="mx_spend" type="number" min="0" step="0.01">
            </div>

            <div class="col-12">
              <div class="mini">En tu tabla <span class="mono">piece_metrics</span> la UNIQUE es <span class="mono">(piece_id, date)</span>; al guardar se hace <span class="mono">upsert</span> por esa combinación.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveMetric">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lead Modal -->
  <div class="modal fade" id="leadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="leadModalTitle">Gestión de Lead</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="ld_id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Nombre (full_name) (NOT NULL)</label>
              <input class="form-control" id="ld_full_name">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Teléfono</label>
              <input class="form-control" id="ld_phone">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Email</label>
              <input class="form-control" id="ld_email">
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Origen (source_detail)</label>
              <input class="form-control" id="ld_source_detail" placeholder="Ej: Instagram DM / Form / WhatsApp">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Campaña</label>
              <select class="form-select" id="ld_campaign"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Pieza (Opcional)</label>
              <select class="form-select" id="ld_piece"></select>
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Triage Status</label>
              <input class="form-control" id="ld_triage_status" placeholder="nuevo / contactado / ... (enum)">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Clinical Outcome</label>
              <input class="form-control" id="ld_clinical_outcome" placeholder="pendiente / ... (enum)">
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Appointment Date</label>
              <input type="datetime-local" class="form-control" id="ld_appointment_date">
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Ticket Value</label>
              <input type="number" class="form-control" id="ld_ticket_value" min="0" step="0.01">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="ld_is_retained">
                <label class="form-check-label small fw-bold" for="ld_is_retained">Retained</label>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Triage Notes</label>
              <textarea class="form-control" id="ld_triage_notes" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveLead">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="box">
      <div class="spinner-border text-primary" role="status"></div>
      <div class="fw-bold">Procesando...</div>
      <div class="small text-muted" id="loadingMsg">...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === TU PROYECTO REAL ===
    const SUPABASE_URL = "https://rofwgcrsfrovspiholbo.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_M7gyUpsbCPRopdrmDjEeLA_SHXlnP-C";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === MAPEOS 100% A TU ESQUEMA (según los JSON que pegaste) ===
    const MAP = {
      campaigns: {
        table:'campaigns',
        id:'id',
        name:'name',
        bimester:'bimester',
        start:'start_date',
        end:'end_date',
        objective:'objective',
        anchor:'anchor_event',
        magnet:'lead_magnet',
        budget:'budget_planned',
        status:'status',
        created_at:'created_at',
        updated_at:'updated_at'
      },
      pieces: {
        table:'pieces',
        id:'id',
        campaign_id:'campaign_id',
        channel_id:'channel_id',
        name:'name',
        format:'format',
        pillar:'pillar',
        hook_copy:'hook_copy',
        visual_style:'visual_style',
        cta:'cta_destination',
        ad_id:'ad_id',
        status:'status',
        created_at:'created_at',
        updated_at:'updated_at'
      },
      metrics: {
        table:'piece_metrics',
        id:'id',
        piece_id:'piece_id',
        date:'date',
        volume:'volume',
        interactions:'interactions',
        spend:'spend',
        created_at:'created_at'
      },
      leads: {
        table:'leads',
        id:'id',
        created_at:'created_at',
        full_name:'full_name',
        phone:'phone',
        email:'email',
        source_detail:'source_detail',
        campaign_id:'campaign_id',
        piece_id:'piece_id',
        triage_status:'triage_status',
        triage_notes:'triage_notes',
        clinical_outcome:'clinical_outcome',
        appointment_date:'appointment_date',
        ticket_value:'ticket_value',
        is_retained:'is_retained',
        updated_at:'updated_at'
      }
    };

    const el = (id) => document.getElementById(id);

    const showLoading = (v, msg='') => {
      el('loading').style.display = v ? 'flex' : 'none';
      el('loadingMsg').textContent = msg || '';
    };

    const esc = (s) => String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");

    const shortId = (uuid) => {
      const s = String(uuid ?? '');
      return s.length > 8 ? s.slice(0,8) : s;
    };

    const fmtDate = (v) => v ? String(v).slice(0,10) : '';
    const fmtMoney = (v) => {
      const n = Number(v ?? 0);
      if (!Number.isFinite(n)) return '0';
      return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    function showAlert(type, title, message, ttlMs = 4500){
      const stack = el('alertStack');
      const card = document.createElement('div');
      card.className = `alert-card ${type || 'info'}`;
      const icon = type === 'success' ? 'bi-check-circle-fill text-success' :
                   type === 'warning' ? 'bi-exclamation-triangle-fill text-warning' :
                   type === 'danger'  ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary';
      card.innerHTML = `
        <i class="${icon} fs-5 mt-1"></i>
        <div class="flex-grow-1">
          <div class="fw-bold text-dark">${esc(title || 'Aviso')}</div>
          <div class="small text-secondary">${esc(message || '')}</div>
        </div>
        <button class="btn-close ms-2" aria-label="cerrar" style="font-size:0.7em"></button>
      `;
      stack.appendChild(card);
      const close = () => { card.style.opacity='0'; setTimeout(()=>card.remove(),300); };
      card.querySelector('.btn-close').addEventListener('click', close);
      if (ttlMs) setTimeout(() => { if(card.isConnected) close(); }, ttlMs);
    }

    function humanize(err){
      const raw = (err?.message || err?.error_description || String(err || ''));
      const low = raw.toLowerCase();
      if (low.includes('invalid login credentials')) return 'Correo o contraseña incorrectos.';
      if (low.includes('email not confirmed')) return 'Tu correo aún no está confirmado.';
      if (low.includes('permission denied')) return 'Permisos insuficientes (RLS).';
      return raw;
    }

    function getStatusBadge(status) {
      const s = String(status || '').toLowerCase();
      let cls = 'st-draft';
      if(s.includes('public')) cls = 'st-published';
      if(s.includes('program') || s.includes('activo')) cls = 'st-scheduled';
      if(s.includes('paus')) cls = 'st-paused';
      if(s.includes('cerr') || s.includes('desc')) cls = 'st-closed';
      return `<span class="badge-status ${cls}">${esc(status || '-')}</span>`;
    }

    const state = {
      user:null,
      profile:null,
      channels:[],
      campaigns:[],
      pieces:[],
      metrics:[],
      leads:[]
    };

    // ========= AUTH / SESSION =========
    function openSetNewPasswordModal(){
      const m = new bootstrap.Modal(el('setNewPassModal'));
      m.show();
    }

    async function handleSession(session){
      state.user = session?.user || null;

      if (!state.user){
        el('loginView').classList.remove('hidden');
        el('appView').classList.add('hidden');
        el('whoami').textContent = '...';
        el('btnLogout').disabled = true;
        return;
      }

      try{
        const { data: prof } = await supabase.from('profiles').select('*').eq('id', state.user.id).maybeSingle();
        state.profile = prof || null;
      }catch(_){ state.profile = null; }

      el('loginView').classList.add('hidden');
      el('appView').classList.remove('hidden');
      el('whoami').textContent = state.profile?.full_name || state.user.email || 'Usuario';
      el('btnLogout').disabled = false;

      await refreshAll();
    }

    async function init(){
      const { data } = await supabase.auth.getSession();
      await handleSession(data.session);

      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'PASSWORD_RECOVERY') openSetNewPasswordModal();
        await handleSession(session);
      });
    }

    el('btnSignIn').addEventListener('click', async ()=>{
      const email = el('loginEmail').value.trim();
      const password = el('loginPass').value;
      if (!email || !password) return showAlert('warning','Faltan datos','Ingresa tu correo y contraseña.');
      showLoading(true, 'Iniciando sesión...');
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        showAlert('success','Bienvenido','Sesión iniciada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    });

    el('btnLogout').addEventListener('click', async () => {
      showLoading(true, 'Cerrando sesión...');
      try{
        await supabase.auth.signOut();
        window.location.href = window.location.origin + window.location.pathname; // limpia hash
      }finally{
        showLoading(false);
      }
    });

    el('btnForgotPass').addEventListener('click', () => new bootstrap.Modal(el('forgotPassModal')).show());

    el('btnSendResetEmail').addEventListener('click', async ()=>{
      const email = el('fp_email').value.trim();
      if (!email) return showAlert('warning','Email requerido','Ingresa tu correo.');
      showLoading(true, 'Enviando enlace...');
      try{
        const redirectTo = window.location.origin + window.location.pathname;
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
        if(error) throw error;
        bootstrap.Modal.getInstance(el('forgotPassModal'))?.hide();
        showAlert('success','Enviado','Revisa tu bandeja de entrada.');
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    });

    el('btnSetNewPass').addEventListener('click', async ()=>{
      const p1 = el('np1').value;
      const p2 = el('np2').value;
      if (!p1 || p1.length < 6) return showAlert('warning','Seguridad','Mínimo 6 caracteres.');
      if (p1 !== p2) return showAlert('warning','Error','Las contraseñas no coinciden.');

      showLoading(true, 'Actualizando password...');
      try{
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if (error) throw error;

        bootstrap.Modal.getInstance(el('setNewPassModal'))?.hide();
        showAlert('success','Listo','Contraseña actualizada. Volviendo al login...');

        // Importante: limpiar URL/hash del recovery para no quedar "pegado"
        setTimeout(() => {
          window.location.href = window.location.origin + window.location.pathname;
        }, 700);

      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    });

    // ========= DATA LOAD =========
    async function refreshAll(){
      showLoading(true, 'Cargando datos...');
      try{
        await loadChannels();
        await Promise.all([loadCampaigns(), loadPieces(), loadMetrics(), loadLeads()]);
        bindFilters();
        applyPiecesFilters();
        applyLeadsFilters();
        applyMetricsFilters();
      }catch(err){
        console.error(err);
        showAlert('danger','Error de conexión', humanize(err));
      }finally{
        showLoading(false);
      }
    }

    // CHANNELS (por FK en pieces.channel_id)
    async function loadChannels(){
      // Intento estándar: channels(id,name). Si no existe name, igual renderiza id.
      const { data, error } = await supabase.from('channels').select('*').order('id', { ascending:true });
      if (error){
        state.channels = [];
        // No bloquea la app: solo deja selects “sin catálogo”.
        console.warn('channels load error:', error.message);
        return;
      }
      state.channels = data || [];
      updateChannelSelects();
    }

    function channelLabel(ch){
      return ch?.name ?? ch?.title ?? ch?.channel ?? ch?.label ?? String(ch?.id ?? '');
    }

    function updateChannelSelects(){
      const all = ['<option value="">Todos</option>']
        .concat(state.channels.map(ch => `<option value="${esc(ch.id)}">${esc(channelLabel(ch))}</option>`));
      el('fChannel').innerHTML = all.join('');

      const pick = ['<option value="">(Sin canal)</option>']
        .concat(state.channels.map(ch => `<option value="${esc(ch.id)}">${esc(channelLabel(ch))}</option>`));
      el('p_channel_id').innerHTML = pick.join('');
    }

    // CAMPAIGNS
    async function loadCampaigns(){
      const { data, error } = await supabase.from(MAP.campaigns.table).select('*').order(MAP.campaigns.created_at, { ascending:false });
      if (error) throw error;
      state.campaigns = data || [];
      renderCampaigns(state.campaigns);
      updateCampaignSelects();
    }

    function renderCampaigns(rows){
      el('tblCampaigns').querySelector('tbody').innerHTML = rows.map(r => `
        <tr>
          <td><span class="mono">${esc(shortId(r[MAP.campaigns.id]))}</span></td>
          <td><span class="badge bg-light text-dark border"> ${esc(r[MAP.campaigns.bimester] ?? '-')} </span></td>
          <td class="fw-bold text-primary">${esc(r[MAP.campaigns.name])}</td>
          <td class="text-muted small text-truncate" style="max-width:220px;">${esc(r[MAP.campaigns.objective] ?? '')}</td>
          <td class="small">${esc(fmtDate(r[MAP.campaigns.start]))} → ${esc(fmtDate(r[MAP.campaigns.end]))}</td>
          <td>${getStatusBadge(r[MAP.campaigns.status])}</td>
          <td class="text-end">
             <button class="btn btn-sm btn-white border" onclick="editCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
             <button class="btn btn-sm btn-white border ms-1" onclick="delCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
          </td>
        </tr>
      `).join('');
    }

    window.editCamp = (id) => openCampaignModal(state.campaigns.find(x => String(x[MAP.campaigns.id]) === String(id)));
    window.delCamp = async (id) => {
      if(!confirm('¿Borrar campaña? (Esto borrará piezas si tu FK es ON DELETE CASCADE)')) return;
      showLoading(true, 'Borrando campaña...');
      try{
        const { error } = await supabase.from(MAP.campaigns.table).delete().eq(MAP.campaigns.id, id);
        if (error) throw error;
        showAlert('success','Eliminado','Campaña eliminada.');
        await loadCampaigns();
        await loadPieces();
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    };

    function openCampaignModal(row=null){
      el('c_id').value = row?.[MAP.campaigns.id] || '';
      el('c_name').value = row?.[MAP.campaigns.name] || '';
      el('c_bim').value = row?.[MAP.campaigns.bimester] || '';
      el('c_start').value = row?.[MAP.campaigns.start] ? fmtDate(row[MAP.campaigns.start]) : '';
      el('c_end').value = row?.[MAP.campaigns.end] ? fmtDate(row[MAP.campaigns.end]) : '';
      el('c_objective').value = row?.[MAP.campaigns.objective] || '';
      el('c_anchor').value = row?.[MAP.campaigns.anchor] || '';
      el('c_magnet').value = row?.[MAP.campaigns.magnet] || '';
      el('c_budget').value = row?.[MAP.campaigns.budget] ?? 0;
      el('c_status').value = row?.[MAP.campaigns.status] || '';

      new bootstrap.Modal(el('campaignModal')).show();
    }

    el('btnSaveCampaign').onclick = async () => {
      const name = el('c_name').value.trim();
      const bim = el('c_bim').value.trim();
      const start = el('c_start').value;
      const end = el('c_end').value;

      // NOT NULL en tu tabla
      if(!name) return showAlert('warning','Validación','Nombre requerido.');
      if(!bim) return showAlert('warning','Validación','Bimestre requerido.');
      if(!start) return showAlert('warning','Validación','Fecha inicio requerida.');
      if(!end) return showAlert('warning','Validación','Fecha fin requerida.');

      const payload = {
        [MAP.campaigns.name]: name,
        [MAP.campaigns.bimester]: bim,
        [MAP.campaigns.start]: start,
        [MAP.campaigns.end]: end,
        [MAP.campaigns.objective]: el('c_objective').value || null,
        [MAP.campaigns.anchor]: el('c_anchor').value || null,
        [MAP.campaigns.magnet]: el('c_magnet').value || null,
        [MAP.campaigns.budget]: Number(el('c_budget').value || 0),
        [MAP.campaigns.status]: el('c_status').value || null
      };

      const id = el('c_id').value;
      showLoading(true, 'Guardando campaña...');
      try{
        const q = id
          ? supabase.from(MAP.campaigns.table).update(payload).eq(MAP.campaigns.id, id)
          : supabase.from(MAP.campaigns.table).insert(payload);
        const { error } = await q;
        if (error) throw error;

        bootstrap.Modal.getInstance(el('campaignModal'))?.hide();
        showAlert('success','Guardado','Campaña guardada.');
        await loadCampaigns();
        await loadPieces(); // por filtros/labels
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    };

    // PIECES
    async function loadPieces(){
      const { data, error } = await supabase.from(MAP.pieces.table).select('*').order(MAP.pieces.created_at, { ascending:false });
      if (error) throw error;
      state.pieces = data || [];
      renderPieces(state.pieces);
      updatePieceSelects();
    }

    function campaignNameById(id){
      const c = state.campaigns.find(x => String(x[MAP.campaigns.id]) === String(id));
      return c ? c[MAP.campaigns.name] : 'Sin campaña';
    }
    function channelNameById(id){
      const c = state.channels.find(x => String(x.id) === String(id));
      return c ? channelLabel(c) : (id ? `#${id}` : 'Sin canal');
    }

    function renderPieces(rows){
      el('tblPieces').querySelector('tbody').innerHTML = rows.map(r => `
        <tr>
          <td><span class="mono">${esc(shortId(r[MAP.pieces.id]))}</span></td>
          <td class="small text-muted">${esc(campaignNameById(r[MAP.pieces.campaign_id]))}</td>
          <td class="small">${esc(channelNameById(r[MAP.pieces.channel_id]))}</td>
          <td class="fw-bold text-primary">${esc(r[MAP.pieces.name])}</td>
          <td><span class="badge bg-light text-dark border fw-normal">${esc(r[MAP.pieces.format] ?? '')}</span></td>
          <td class="small text-muted">${esc(r[MAP.pieces.pillar] ?? '')}</td>
          <td>${getStatusBadge(r[MAP.pieces.status])}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-white border" onclick="editPiece('${r[MAP.pieces.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
            <button class="btn btn-sm btn-white border ms-1" onclick="delPiece('${r[MAP.pieces.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
          </td>
        </tr>
      `).join('');
    }

    window.editPiece = (id) => {
      const row = state.pieces.find(r => String(r[MAP.pieces.id]) === String(id));
      if(!row) return;

      el('p_id').value = row[MAP.pieces.id] || '';
      el('p_campaign').value = row[MAP.pieces.campaign_id] || '';
      el('p_channel_id').value = row[MAP.pieces.channel_id] || '';
      el('p_name').value = row[MAP.pieces.name] || '';
      el('p_format').value = row[MAP.pieces.format] || '';
      el('p_pillar').value = row[MAP.pieces.pillar] || '';
      el('p_hook_copy').value = row[MAP.pieces.hook_copy] || '';
      el('p_visual_style').value = row[MAP.pieces.visual_style] || '';
      el('p_cta_destination').value = row[MAP.pieces.cta] || '';
      el('p_ad_id').value = row[MAP.pieces.ad_id] || '';
      el('p_status').value = row[MAP.pieces.status] || '';

      new bootstrap.Modal(el('pieceModal')).show();
    };

    window.delPiece = async (id) => {
      if(!confirm('¿Borrar pieza?')) return;
      showLoading(true, 'Borrando pieza...');
      try{
        const { error } = await supabase.from(MAP.pieces.table).delete().eq(MAP.pieces.id, id);
        if (error) throw error;
        showAlert('success','Eliminado','Pieza eliminada.');
        await loadPieces();
        await loadMetrics(); // por FK cascade en metrics
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    };

    el('btnSavePiece').onclick = async () => {
      const name = el('p_name').value.trim();
      const format = el('p_format').value.trim();

      if(!name) return showAlert('warning','Validación','Nombre requerido (pieces.name).');
      if(!format) return showAlert('warning','Validación','Formato requerido (pieces.format).');

      const payload = {
        [MAP.pieces.campaign_id]: el('p_campaign').value || null,
        [MAP.pieces.channel_id]: el('p_channel_id').value ? Number(el('p_channel_id').value) : null,
        [MAP.pieces.name]: name,
        [MAP.pieces.format]: format,
        [MAP.pieces.pillar]: el('p_pillar').value || null,
        [MAP.pieces.hook_copy]: el('p_hook_copy').value || null,
        [MAP.pieces.visual_style]: el('p_visual_style').value || null,
        [MAP.pieces.cta]: el('p_cta_destination').value || null,
        [MAP.pieces.ad_id]: el('p_ad_id').value || null,
        [MAP.pieces.status]: el('p_status').value || null
      };

      const id = el('p_id').value;
      showLoading(true, 'Guardando pieza...');
      try{
        const q = id
          ? supabase.from(MAP.pieces.table).update(payload).eq(MAP.pieces.id, id)
          : supabase.from(MAP.pieces.table).insert(payload);

        const { error } = await q;
        if (error) throw error;

        bootstrap.Modal.getInstance(el('pieceModal'))?.hide();
        showAlert('success','Guardado','Pieza guardada.');
        await loadPieces();
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    };

    // METRICS
    async function loadMetrics(){
      const { data, error } = await supabase.from(MAP.metrics.table).select('*').order(MAP.metrics.date, { ascending:false });
      if (error) throw error;
      state.metrics = data || [];
      renderMetrics(state.metrics);
    }

    function pieceLabelById(id){
      const p = state.pieces.find(x => String(x[MAP.pieces.id]) === String(id));
      if(!p) return '-';
      return `${p[MAP.pieces.name]}`.trim();
    }

    function renderMetrics(rows){
      el('tblMetrics').querySelector('tbody').innerHTML = rows.map(r => `
        <tr>
          <td class="text-start">
            <div class="small fw-bold">${esc(pieceLabelById(r[MAP.metrics.piece_id]))}</div>
            <div class="mini text-muted">${esc(shortId(r[MAP.metrics.piece_id]))}</div>
          </td>
          <td class="mono small">${esc(fmtDate(r[MAP.metrics.date]))}</td>
          <td>${esc(r[MAP.metrics.volume] ?? 0)}</td>
          <td>${esc(r[MAP.metrics.interactions] ?? 0)}</td>
          <td class="fw-bold text-primary">${esc(fmtMoney(r[MAP.metrics.spend] ?? 0))}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-white border" onclick="editMetric('${r[MAP.metrics.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
          </td>
        </tr>
      `).join('');
    }

    window.editMetric = (id) => {
      const r = state.metrics.find(x => String(x[MAP.metrics.id]) === String(id));
      if(!r) return;

      el('mx_id').value = r[MAP.metrics.id] || '';
      el('mx_piece').value = r[MAP.metrics.piece_id] || '';
      el('mx_date').value = fmtDate(r[MAP.metrics.date]) || '';
      el('mx_volume').value = r[MAP.metrics.volume] ?? 0;
      el('mx_interactions').value = r[MAP.metrics.interactions] ?? 0;
      el('mx_spend').value = r[MAP.metrics.spend] ?? 0;

      new bootstrap.Modal(el('metricModal')).show();
    };

    el('btnPrefillMetricToday').onclick = () => {
      el('mx_date').value = new Date().toISOString().slice(0,10);
    };

    el('btnSaveMetric').onclick = async () => {
      const pieceId = el('mx_piece').value;
      const date = el('mx_date').value;

      if(!pieceId) return showAlert('warning','Validación','Selecciona una pieza.');
      if(!date) return showAlert('warning','Validación','Fecha requerida.');

      const payload = {
        [MAP.metrics.piece_id]: pieceId,
        [MAP.metrics.date]: date,
        [MAP.metrics.volume]: Number(el('mx_volume').value || 0),
        [MAP.metrics.interactions]: Number(el('mx_interactions').value || 0),
        [MAP.metrics.spend]: Number(el('mx_spend').value || 0)
      };

      const id = el('mx_id').value;
      showLoading(true, 'Guardando métrica...');
      try{
        let q;
        if(id){
          q = supabase.from(MAP.metrics.table).update(payload).eq(MAP.metrics.id, id);
        }else{
          // UNIQUE (piece_id, date)
          q = supabase.from(MAP.metrics.table).upsert(payload, { onConflict: `${MAP.metrics.piece_id},${MAP.metrics.date}` });
        }

        const { error } = await q;
        if (error) throw error;

        bootstrap.Modal.getInstance(el('metricModal'))?.hide();
        showAlert('success','Guardado','Métrica guardada.');
        await loadMetrics();
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    };

    // LEADS
    async function loadLeads(){
      const { data, error } = await supabase.from(MAP.leads.table).select('*').order(MAP.leads.created_at, { ascending:false });
      if (error) throw error;
      state.leads = data || [];
      renderLeads(state.leads);
    }

    function renderLeads(rows){
      el('tblLeads').querySelector('tbody').innerHTML = rows.map(r => `
        <tr>
          <td class="small text-muted">${esc(String(r[MAP.leads.created_at] ?? '').slice(0,19).replace('T',' '))}</td>
          <td><span class="badge bg-light text-dark border">${esc(r[MAP.leads.source_detail] ?? '')}</span></td>
          <td class="fw-bold text-primary">${esc(r[MAP.leads.full_name] ?? '')}</td>
          <td>${esc(r[MAP.leads.phone] ?? '')}</td>
          <td class="small">${esc(r[MAP.leads.email] ?? '')}</td>
          <td>${getStatusBadge(r[MAP.leads.triage_status])}</td>
          <td class="small text-muted">${esc(r[MAP.leads.clinical_outcome] ?? '')}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-white border" onclick="editLead('${r[MAP.leads.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
            <button class="btn btn-sm btn-white border ms-1" onclick="delLead('${r[MAP.leads.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
          </td>
        </tr>
      `).join('');
    }

    window.editLead = (id) => {
      const r = state.leads.find(x => String(x[MAP.leads.id]) === String(id));
      if(!r) return;

      el('ld_id').value = r[MAP.leads.id] || '';
      el('ld_full_name').value = r[MAP.leads.full_name] || '';
      el('ld_phone').value = r[MAP.leads.phone] || '';
      el('ld_email').value = r[MAP.leads.email] || '';
      el('ld_source_detail').value = r[MAP.leads.source_detail] || '';
      el('ld_campaign').value = r[MAP.leads.campaign_id] || '';
      el('ld_piece').value = r[MAP.leads.piece_id] || '';
      el('ld_triage_status').value = r[MAP.leads.triage_status] || '';
      el('ld_triage_notes').value = r[MAP.leads.triage_notes] || '';
      el('ld_clinical_outcome').value = r[MAP.leads.clinical_outcome] || '';
      el('ld_ticket_value').value = r[MAP.leads.ticket_value] ?? 0;
      el('ld_is_retained').checked = Boolean(r[MAP.leads.is_retained]);

      const ad = r[MAP.leads.appointment_date];
      el('ld_appointment_date').value = ad ? new Date(ad).toISOString().slice(0,16) : '';

      new bootstrap.Modal(el('leadModal')).show();
    };

    window.delLead = async (id) => {
      if(!confirm('¿Borrar lead?')) return;
      showLoading(true, 'Borrando lead...');
      try{
        const { error } = await supabase.from(MAP.leads.table).delete().eq(MAP.leads.id, id);
        if (error) throw error;
        showAlert('success','Eliminado','Lead eliminado.');
        await loadLeads();
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    };

    el('btnSaveLead').onclick = async () => {
      const fullName = el('ld_full_name').value.trim();
      if(!fullName) return showAlert('warning','Validación','Nombre requerido (leads.full_name).');

      const payload = {
        [MAP.leads.full_name]: fullName,
        [MAP.leads.phone]: el('ld_phone').value || null,
        [MAP.leads.email]: el('ld_email').value || null,
        [MAP.leads.source_detail]: el('ld_source_detail').value || null,
        [MAP.leads.campaign_id]: el('ld_campaign').value || null,
        [MAP.leads.piece_id]: el('ld_piece').value || null,
        [MAP.leads.triage_status]: el('ld_triage_status').value || null,
        [MAP.leads.triage_notes]: el('ld_triage_notes').value || null,
        [MAP.leads.clinical_outcome]: el('ld_clinical_outcome').value || null,
        [MAP.leads.ticket_value]: Number(el('ld_ticket_value').value || 0),
        [MAP.leads.is_retained]: Boolean(el('ld_is_retained').checked)
      };

      const appt = el('ld_appointment_date').value;
      payload[MAP.leads.appointment_date] = appt ? new Date(appt).toISOString() : null;

      const id = el('ld_id').value;
      showLoading(true, 'Guardando lead...');
      try{
        const q = id
          ? supabase.from(MAP.leads.table).update(payload).eq(MAP.leads.id, id)
          : supabase.from(MAP.leads.table).insert(payload);

        const { error } = await q;
        if (error) throw error;

        bootstrap.Modal.getInstance(el('leadModal'))?.hide();
        showAlert('success','Guardado','Lead guardado.');
        await loadLeads();
      }catch(err){
        showAlert('danger','Error', humanize(err));
      }finally{
        showLoading(false);
      }
    };

    // ========= SELECTS / FILTERS =========
    function updateCampaignSelects(){
      const campOpts = ['<option value="">(Sin campaña)</option>']
        .concat(state.campaigns.map(c => `<option value="${esc(c[MAP.campaigns.id])}">${esc(c[MAP.campaigns.name])}</option>`));
      el('p_campaign').innerHTML = campOpts.join('');
      el('ld_campaign').innerHTML = campOpts.join('');

      const filterCamp = ['<option value="">Todas</option>']
        .concat(state.campaigns.map(c => `<option value="${esc(c[MAP.campaigns.id])}">${esc(c[MAP.campaigns.name])}</option>`));
      el('fCamp').innerHTML = filterCamp.join('');
      el('lCamp').innerHTML = filterCamp.join('');
    }

    function updatePieceSelects(){
      const pieceOpts = ['<option value="">(Sin pieza)</option>']
        .concat(state.pieces.map(p => `<option value="${esc(p[MAP.pieces.id])}">${esc(p[MAP.pieces.name])}</option>`));
      el('mPiece').innerHTML = ['<option value="">(Todas)</option>'].concat(state.pieces.map(p => `<option value="${esc(p[MAP.pieces.id])}">${esc(p[MAP.pieces.name])}</option>`)).join('');
      el('mx_piece').innerHTML = pieceOpts.join('');
      el('ld_piece').innerHTML = pieceOpts.join('');
      el('lPiece').innerHTML = ['<option value="">Todas</option>'].concat(state.pieces.map(p => `<option value="${esc(p[MAP.pieces.id])}">${esc(p[MAP.pieces.name])}</option>`)).join('');
    }

    function applyPiecesFilters(){
      const camp = el('fCamp').value;
      const chan = el('fChannel').value;
      const stat = el('fStatus').value;
      const q = el('fQ').value.toLowerCase();

      const filtered = state.pieces.filter(r => {
        if(camp && String(r[MAP.pieces.campaign_id] ?? '') !== String(camp)) return false;
        if(chan && String(r[MAP.pieces.channel_id] ?? '') !== String(chan)) return false;
        if(stat && String(r[MAP.pieces.status] ?? '') !== String(stat)) return false;
        if(q){
          const blob = JSON.stringify(r).toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      renderPieces(filtered);
    }

    function applyLeadsFilters(){
      const camp = el('lCamp').value;
      const piece = el('lPiece').value;
      const q = el('lQ').value.toLowerCase();

      const filtered = state.leads.filter(r => {
        if(camp && String(r[MAP.leads.campaign_id] ?? '') !== String(camp)) return false;
        if(piece && String(r[MAP.leads.piece_id] ?? '') !== String(piece)) return false;

        if(q){
          const blob = JSON.stringify(r).toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      renderLeads(filtered);
    }

    function applyMetricsFilters(){
      const pieceId = el('mPiece').value;
      const from = el('mFrom').value;
      const to = el('mTo').value;

      const filtered = state.metrics.filter(r => {
        if(pieceId && String(r[MAP.metrics.piece_id]) !== String(pieceId)) return false;
        const d = fmtDate(r[MAP.metrics.date]);
        if(from && d < from) return false;
        if(to && d > to) return false;
        return true;
      });

      renderMetrics(filtered);
    }

    function bindFilters(){
      el('btnNewCampaign').onclick = () => openCampaignModal();
      el('btnNewPiece').onclick = () => { el('p_id').value=''; new bootstrap.Modal(el('pieceModal')).show(); };
      el('btnNewMetric').onclick = () => { el('mx_id').value=''; new bootstrap.Modal(el('metricModal')).show(); };
      el('btnNewLead').onclick = () => { el('ld_id').value=''; new bootstrap.Modal(el('leadModal')).show(); };

      el('btnReloadCampaigns').onclick = loadCampaigns;
      el('btnReloadPieces').onclick = loadPieces;
      el('btnReloadMetrics').onclick = async () => { await loadMetrics(); applyMetricsFilters(); };
      el('btnReloadLeads').onclick = async () => { await loadLeads(); applyLeadsFilters(); };

      ['fCamp','fChannel','fStatus'].forEach(id => el(id)?.addEventListener('change', applyPiecesFilters));
      el('fQ')?.addEventListener('keyup', applyPiecesFilters);

      ['lCamp','lPiece'].forEach(id => el(id)?.addEventListener('change', applyLeadsFilters));
      el('lQ')?.addEventListener('keyup', applyLeadsFilters);

      ['mPiece','mFrom','mTo'].forEach(id => el(id)?.addEventListener('change', applyMetricsFilters));
    }

    // Boot
    init();
  </script>
</body>
</html>
