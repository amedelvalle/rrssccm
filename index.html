<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grupo CCM | Plan Digital 2026</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --r: 12px;
    }

    body{
      background: var(--bg-body);
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .navbar-ccm {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      padding: 0.75rem 0;
    }
    .brand-title { font-weight: 700; font-size: 1rem; color: #111827; letter-spacing: -0.025em; }
    .brand-sub { font-size: 0.75rem; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .brand-icon { width: 32px; height: 32px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary); }

    .app-shell{ max-width: 1400px; }
    .cardx {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--r);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .cardx:hover { box-shadow: var(--shadow-md); }

    .section-title { font-weight: 700; color: #111827; letter-spacing: -0.025em; font-size: 1.25rem; }
    .mini { color: var(--text-muted); font-size: 0.875rem; }
    .mono { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.85em; color: var(--primary); background: #eff6ff; padding: 2px 6px; border-radius: 4px; }

    .btn { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem; border: 1px solid transparent; transition: all 0.2s; }
    .btn-primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); transform: translateY(-1px); }
    .btn-light { background: #fff; border-color: var(--border-color); color: #374151; }
    .btn-light:hover { background: #f9fafb; border-color: #d1d5db; color: #111827; }

    .nav-tabs { border-bottom: 1px solid var(--border-color); gap: 1rem; }
    .nav-tabs .nav-link { border: none; color: var(--text-muted); font-weight: 500; padding: 0.75rem 0.25rem; background: transparent; transition: color 0.2s; }
    .nav-tabs .nav-link:hover { color: var(--primary); }
    .nav-tabs .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); background: transparent; }

    .table thead th {
      background: #f9fafb;
      color: #6b7280;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      white-space: nowrap;
    }
    .table tbody td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.875rem; }
    .table-hover tbody tr:hover { background: #f9fafb; }

    .badge-status { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .badge-status::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .st-draft { background: #f3f4f6; color: #4b5563; }
    .st-scheduled { background: #eff6ff; color: #2563eb; }
    .st-published { background: #ecfdf5; color: #059669; }
    .st-paused { background: #fffbeb; color: #d97706; }
    .st-closed { background: #fef2f2; color: #dc2626; }

    .form-control, .form-select { border-radius: 8px; border-color: var(--border-color); padding: 0.6rem 0.75rem; font-size: 0.875rem; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

    .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .loading .box { background: white; padding: 20px 40px; border-radius: 12px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 10px; }

    .alert-stack { position: fixed; top: 80px; right: 20px; z-index: 2500; display: flex; flex-direction: column; gap: 10px; width: 380px; }
    .alert-card { background: white; border: 1px solid var(--border-color); border-left: 4px solid var(--primary); border-radius: 8px; box-shadow: var(--shadow-md); padding: 12px 16px; display: flex; gap: 12px; align-items: start; animation: slideIn 0.3s ease; }
    .alert-card.success { border-left-color: #059669; }
    .alert-card.danger { border-left-color: #dc2626; }
    .alert-card.warning { border-left-color: #d97706; }

    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .hidden { display: none !important; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>

<body>
  <div class="alert-stack" id="alertStack"></div>

  <nav class="navbar navbar-ccm sticky-top">
    <div class="container-fluid app-shell px-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-icon"><i class="bi bi-grid-fill"></i></div>
        <div class="min-w-0">
          <div class="brand-title">Grupo CCM</div>
          <div class="brand-sub">Plan Digital 2026</div>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge bg-light text-dark border fw-normal py-2 px-3 rounded-pill" id="whoami">Cargando...</span>
        <button class="btn btn-light btn-sm" id="btnLogout" disabled><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell my-5 px-4">

    <!-- LOGIN -->
    <div id="loginView" class="cardx p-5 mx-auto" style="max-width: 480px;">
      <div class="text-center mb-4">
        <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3" style="width: 48px; height: 48px;"><i class="bi bi-shield-lock-fill fs-5"></i></div>
        <h4 class="fw-bold">Iniciar Sesión</h4>
        <p class="text-muted small">Accede al panel de Marketing</p>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold small">Correo electrónico</label>
        <input type="email" class="form-control" id="loginEmail" placeholder="nombre@grupoccm.com" autocomplete="username">
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold small">Contraseña</label>
        <input type="password" class="form-control" id="loginPass" placeholder="••••••••" autocomplete="current-password">
      </div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-link px-0 small text-decoration-none" id="btnForgotPass" type="button">¿Olvidaste tu clave?</button>
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSignIn">Ingresar</button>
      <div class="text-center mt-3 small text-muted">Powered by Supabase</div>
    </div>

    <!-- APP -->
    <div id="appView" class="hidden">
      <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-4">
        <div>
          <h3 class="fw-bold mb-1">Panel de Control</h3>
          <div class="mini">Campañas, piezas, métricas y leads.</div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-primary" id="btnNewCampaign"><i class="bi bi-plus-lg me-1"></i>Campaña</button>
          <button class="btn btn-primary" id="btnNewPiece"><i class="bi bi-plus-lg me-1"></i>Pieza</button>
          <button class="btn btn-primary" id="btnNewMetric"><i class="bi bi-plus-lg me-1"></i>Métrica</button>
          <button class="btn btn-primary" id="btnNewLead"><i class="bi bi-plus-lg me-1"></i>Lead</button>
        </div>
      </div>

      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCampaigns" type="button" role="tab">
            <i class="bi bi-calendar-range me-2"></i>Campañas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPieces" type="button" role="tab">
            <i class="bi bi-grid me-2"></i>Piezas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMetrics" type="button" role="tab">
            <i class="bi bi-bar-chart me-2"></i>Métricas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLeads" type="button" role="tab">
            <i class="bi bi-people me-2"></i>Leads
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- CAMPAIGNS -->
        <div class="tab-pane fade show active" id="tabCampaigns" role="tabpanel">
          <div class="cardx">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-light bg-opacity-50">
              <span class="fw-bold small text-uppercase text-muted">Listado de Campañas</span>
              <button class="btn btn-sm btn-white border" id="btnReloadCampaigns"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblCampaigns">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Bimestre</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PIECES -->
        <div class="tab-pane fade" id="tabPieces" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="fCamp"></select>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label mini fw-bold">Estado</label>
                  <input class="form-control" id="fPieceStatus" placeholder="idea, borrador, publicado...">
                </div>

                <div class="col-12 col-md-5">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input class="form-control border-start-0 ps-0" id="fQ" placeholder="Nombre, hook, ad_id...">
                  </div>
                </div>

                <div class="col-12">
                  <div class="small text-muted">
                    Nota: <b>format</b> y <b>bimester</b> son enums en Supabase; si tu valor no coincide con el enum, Supabase rechazará el insert/update.
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblPieces">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Campaña</th>
                    <th>Canal</th>
                    <th>Formato</th>
                    <th>Estado</th>
                    <th>Hook</th>
                    <th>CTA</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadPieces">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla
              </button>
            </div>
          </div>
        </div>

        <!-- METRICS -->
        <div class="tab-pane fade" id="tabMetrics" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="mPiece"></select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Desde</label>
                  <input type="date" class="form-control" id="mFrom">
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mini fw-bold">Hasta</label>
                  <input type="date" class="form-control" id="mTo">
                </div>
              </div>
              <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-light" id="btnReloadMetrics"><i class="bi bi-arrow-clockwise me-1"></i>Filtrar</button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblMetrics">
                <thead class="text-center">
                  <tr>
                    <th class="text-start">Pieza</th>
                    <th>Fecha</th>
                    <th>Volumen</th>
                    <th>Interacciones</th>
                    <th>Gasto</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- LEADS -->
        <div class="tab-pane fade" id="tabLeads" role="tabpanel">
          <div class="cardx">
            <div class="p-4 border-bottom">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Campaña</label>
                  <select class="form-select" id="lCamp"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Pieza</label>
                  <select class="form-select" id="lPiece"></select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label mini fw-bold">Buscar</label>
                  <input class="form-control" id="lQ" placeholder="Nombre, teléfono, email...">
                </div>
              </div>
              <div class="small text-muted mt-3">
                Nota: <b>triage_status</b> y <b>clinical_outcome</b> son enums.
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle" id="tblLeads">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Origen</th>
                    <th>Triage</th>
                    <th>Cita</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top bg-light text-end">
              <button class="btn btn-sm btn-link text-decoration-none text-muted" id="btnReloadLeads"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar tabla</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Forgot Password -->
  <div class="modal fade" id="forgotPassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Recuperar Acceso</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small">Ingresa tu correo y te enviaremos un enlace.</p>
          <input type="email" class="form-control mb-3" id="fp_email" placeholder="tu@correo.com">
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" id="btnSendResetEmail">Enviar enlace</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Set New Password -->
  <div class="modal fade" id="setNewPassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Nueva Contraseña</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
             <label class="form-label small fw-bold">Contraseña nueva</label>
             <input type="password" class="form-control" id="np1">
          </div>
          <div class="mb-4">
             <label class="form-label small fw-bold">Confirmar</label>
             <input type="password" class="form-control" id="np2">
          </div>
          <button class="btn btn-primary w-100" id="btnSetNewPass">Actualizar Password</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Campaign Modal -->
  <div class="modal fade" id="campaignModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="campaignModalTitle">Campaña</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="c_id">

          <div class="row g-3">
            <div class="col-12">
              <label class="form-label small fw-bold">Nombre *</label>
              <input class="form-control" id="c_name" placeholder="Ej: Diabetes Control" required>
            </div>

            <div class="col-6">
              <label class="form-label small fw-bold">Bimestre * (campaign_bimester)</label>
              <select class="form-select" id="c_bim">
                <option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option>
                <option value="B4">B4</option><option value="B5">B5</option><option value="B6">B6</option>
              </select>
            </div>

            <div class="col-6">
              <label class="form-label small fw-bold">Estado</label>
              <input class="form-control" id="c_status" placeholder="planificada, activa...">
            </div>

            <div class="col-6">
              <label class="form-label small fw-bold">Inicio *</label>
              <input type="date" class="form-control" id="c_start" required>
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold">Fin *</label>
              <input type="date" class="form-control" id="c_end" required>
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Objetivo</label>
              <input class="form-control" id="c_objective" placeholder="Ej: Generar leads cualificados">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Evento ancla</label>
              <input class="form-control" id="c_anchor_event" placeholder="(Opcional)">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Lead Magnet</label>
              <input class="form-control" id="c_lead_magnet" placeholder="(Opcional)">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Presupuesto planificado</label>
              <input class="form-control" id="c_budget" type="number" step="0.01" min="0">
            </div>
          </div>

          <div class="small text-muted mt-3">
            Campos con * son requeridos (en tu tabla <b>start_date/end_date</b> son NOT NULL).
          </div>

        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveCampaign">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Piece Modal -->
  <div class="modal fade" id="pieceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="pieceModalTitle">Pieza</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="p_id">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Campaña</label>
              <select class="form-select" id="p_campaign"></select>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Canal (channel_id)</label>
              <select class="form-select" id="p_channel_id"></select>
              <div class="mini mt-1">Si no carga canales, quedará en “Sin canal” (NULL).</div>
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Nombre *</label>
              <input class="form-control" id="p_name" placeholder="Ej: Reel educación paciente" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Formato * (piece_format)</label>
              <input class="form-control" id="p_format" list="dl_piece_format" placeholder="Debe coincidir con enum (ej: reel)">
              <datalist id="dl_piece_format">
                <option value="reel"></option>
                <option value="post"></option>
                <option value="story"></option>
                <option value="video"></option>
                <option value="blog"></option>
                <option value="email"></option>
                <option value="whatsapp"></option>
                <option value="banner"></option>
              </datalist>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Estado</label>
              <input class="form-control" id="p_status" placeholder="idea, borrador, publicado...">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Pilar</label>
              <input class="form-control" id="p_pillar" placeholder="(Opcional)">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Estilo visual</label>
              <input class="form-control" id="p_visual_style" placeholder="(Opcional)">
            </div>

            <div class="col-12">
              <label class="form-label small fw-bold">Hook / Copy (hook_copy)</label>
              <textarea class="form-control" id="p_hook_copy" rows="2"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">CTA destino</label>
              <input class="form-control" id="p_cta" placeholder="(URL / WhatsApp / Landing)">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Ad ID</label>
              <input class="form-control" id="p_ad_id" placeholder="(Opcional)">
            </div>
          </div>

          <div class="small text-muted mt-3">
            Nota: <b>format</b> es NOT NULL y es enum. Si no coincide, Supabase rechazará.
          </div>

        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button class="btn btn-primary" id="btnSavePiece">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Metric Modal -->
  <div class="modal fade" id="metricModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="metricModalTitle">Registro de Métricas</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="mx_id">
          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label small fw-bold">Pieza</label>
              <select class="form-select" id="mx_piece"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label small fw-bold">Fecha (date)</label>
              <input type="date" class="form-control" id="mx_date">
            </div>

            <div class="col-12"><hr class="text-muted"></div>

            <div class="col-12 col-md-4 text-center">
              <label class="form-label small text-muted">Volumen</label>
              <input class="form-control text-center fw-bold" id="mx_volume" type="number" min="0">
            </div>
            <div class="col-12 col-md-4 text-center">
              <label class="form-label small text-muted">Interacciones</label>
              <input class="form-control text-center fw-bold" id="mx_interactions" type="number" min="0">
            </div>
            <div class="col-12 col-md-4 text-center">
              <label class="form-label small text-muted">Gasto</label>
              <input class="form-control text-center fw-bold" id="mx_spend" type="number" step="0.01" min="0">
            </div>
          </div>

          <div class="small text-muted mt-3">
            Tu tabla <b>piece_metrics</b> es por pieza + fecha (UNIQUE <span class="mono">piece_id,date</span>).
          </div>

        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveMetric">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lead Modal -->
  <div class="modal fade" id="leadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content cardx">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="leadModalTitle">Gestión de Lead</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="ld_id">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Nombre completo *</label>
              <input class="form-control" id="ld_full_name" required>
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Teléfono</label>
              <input class="form-control" id="ld_phone">
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Email</label>
              <input class="form-control" id="ld_email" type="email">
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Origen (source_detail)</label>
              <input class="form-control" id="ld_source_detail" placeholder="Ej: Instagram DM / Landing / Referido">
            </div>

            <div class="col-md-3">
              <label class="form-label small fw-bold">Campaña</label>
              <select class="form-select" id="ld_campaign"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Pieza</label>
              <select class="form-select" id="ld_piece"></select>
            </div>

            <div class="col-md-3">
              <label class="form-label small fw-bold">Triage (triage_status)</label>
              <input class="form-control" id="ld_triage_status" list="dl_triage_status" placeholder="nuevo">
              <datalist id="dl_triage_status">
                <option value="nuevo"></option>
                <option value="contactado"></option>
                <option value="en_seguimiento"></option>
                <option value="cerrado"></option>
                <option value="descartado"></option>
              </datalist>
            </div>

            <div class="col-md-3">
              <label class="form-label small fw-bold">Resultado (clinical_outcome)</label>
              <input class="form-control" id="ld_clinical_outcome" list="dl_clinical_outcome" placeholder="pendiente">
              <datalist id="dl_clinical_outcome">
                <option value="pendiente"></option>
                <option value="cita_agendada"></option>
                <option value="atendido"></option>
                <option value="no_contesta"></option>
                <option value="no_interes"></option>
              </datalist>
            </div>

            <div class="col-md-6">
              <label class="form-label small fw-bold">Notas (triage_notes)</label>
              <textarea class="form-control" id="ld_triage_notes" rows="2"></textarea>
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Fecha/hora cita (appointment_date)</label>
              <input class="form-control" id="ld_appointment_date" type="datetime-local">
            </div>

            <div class="col-md-4">
              <label class="form-label small fw-bold">Ticket (ticket_value)</label>
              <input class="form-control" id="ld_ticket_value" type="number" step="0.01" min="0">
            </div>

            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="ld_is_retained">
                <label class="form-check-label small fw-bold" for="ld_is_retained">Retenido (is_retained)</label>
              </div>
            </div>

          </div>

        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveLead">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="box">
      <div class="spinner-border text-primary" role="status"></div>
      <div class="fw-bold">Procesando...</div>
      <div class="small text-muted">Si tarda demasiado, revisa red/RLS.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === SUPABASE (tu proyecto) ===
    const SUPABASE_URL = "https://rofwgcrsfrovspiholbo.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_M7gyUpsbCPRopdrmDjEeLA_SHXlnP-C";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === MAP REAL (alineado a tu BD) ===
    const MAP = {
      campaigns: { table:'campaigns', id:'id', name:'name', bimester:'bimester', start:'start_date', end:'end_date', objective:'objective', status:'status', anchor_event:'anchor_event', lead_magnet:'lead_magnet', budget_planned:'budget_planned', created_at:'created_at' },
      pieces:    { table:'pieces', id:'id', campaign_id:'campaign_id', channel_id:'channel_id', name:'name', format:'format', pillar:'pillar', hook_copy:'hook_copy', visual_style:'visual_style', cta_destination:'cta_destination', ad_id:'ad_id', status:'status', created_at:'created_at' },
      metrics:   { table:'piece_metrics', id:'id', piece_id:'piece_id', date:'date', volume:'volume', interactions:'interactions', spend:'spend', created_at:'created_at' },
      leads:     { table:'leads', id:'id', created_at:'created_at', full_name:'full_name', phone:'phone', email:'email', source_detail:'source_detail', campaign_id:'campaign_id', piece_id:'piece_id', triage_status:'triage_status', triage_notes:'triage_notes', clinical_outcome:'clinical_outcome', appointment_date:'appointment_date', ticket_value:'ticket_value', is_retained:'is_retained', updated_at:'updated_at' },
      profiles:  { table:'profiles', id:'id', full_name:'full_name', role:'role' },
      channels:  { table:'channels', id:'id', name:'name' } // asumimos columns id + name (si no, hacemos fallback)
    };

    const el = (id) => document.getElementById(id);
    const showLoading = (v) => el('loading').style.display = v ? 'flex' : 'none';
    const esc = (s) => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    const asNumber = (v) => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
    const fmtDate = (v) => v ? String(v).slice(0,10) : '';
    const fmtDTLocal = (v) => {
      if (!v) return '';
      try {
        const d = new Date(v);
        // datetime-local expects: YYYY-MM-DDTHH:mm
        const pad = (x)=> String(x).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch(_) { return ''; }
    };
    const fmtMoney = (v) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return '0.00';
      return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // hard stop to avoid "pegado"
    const withTimeout = (p, ms = 15000) =>
      Promise.race([
        p,
        new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout de red (15s). Reintenta.')), ms))
      ]);

    async function runWithLoading(fn){
      showLoading(true);
      try { return await fn(); }
      finally { showLoading(false); }
    }

    function showAlert(type, title, message, ttlMs = 4500){
      const stack = el('alertStack');
      const card = document.createElement('div');
      card.className = `alert-card ${type || 'info'}`;
      const icon = type === 'success' ? 'bi-check-circle-fill text-success' :
                   type === 'warning' ? 'bi-exclamation-triangle-fill text-warning' :
                   type === 'danger'  ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary';

      card.innerHTML = `
        <i class="${icon} fs-5 mt-1"></i>
        <div class="flex-grow-1">
          <div class="fw-bold text-dark">${esc(title || 'Aviso')}</div>
          <div class="small text-secondary">${esc(message || '')}</div>
        </div>
        <button class="btn-close ms-2" aria-label="cerrar" style="font-size:0.7em"></button>
      `;
      stack.appendChild(card);
      const close = () => { card.style.opacity='0'; setTimeout(()=>card.remove(),300); };
      card.querySelector('.btn-close').addEventListener('click', close);
      if (ttlMs) setTimeout(() => { if(card.isConnected) close(); }, ttlMs);
    }

    function humanize(err){
      const raw = (err?.message || err?.error_description || String(err || ''));
      const low = raw.toLowerCase();
      if (low.includes('invalid login credentials')) return 'Correo o contraseña incorrectos.';
      if (low.includes('email not confirmed')) return 'Tu correo aún no está confirmado.';
      if (low.includes('permission denied') || low.includes('row level security') || low.includes('rls')) return 'Permiso denegado (RLS). Revisa policies o rol del usuario.';
      return raw;
    }

    // Status badge is "cosmetic"
    function getStatusBadge(status) {
      const s = String(status || '').toLowerCase();
      let cls = 'st-draft';
      if (s.includes('public') || s.includes('activo')) cls = 'st-published';
      if (s.includes('plan') || s.includes('prog')) cls = 'st-scheduled';
      if (s.includes('paus')) cls = 'st-paused';
      if (s.includes('cerr') || s.includes('desc')) cls = 'st-closed';
      return `<span class="badge-status ${cls}">${esc(status || '—')}</span>`;
    }

    // --- STATE ---
    const state = {
      user: null,
      profile: null,
      campaigns: [],
      pieces: [],
      metrics: [],
      leads: [],
      channels: [],
      bound: false
    };

    // --- RECOVERY FLOW (PKCE ?code=) ---
    async function bootstrapRecoverySessionIfNeeded(){
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      if(!code) return;

      await runWithLoading(async () => {
        try{
          const { error } = await supabase.auth.exchangeCodeForSession(code);
          if(error) throw error;

          url.searchParams.delete('code');
          history.replaceState(null, '', url.toString());

          showAlert('success','Recovery listo','Ahora puedes cambiar tu contraseña.');
          new bootstrap.Modal(el('setNewPassModal')).show();
        }catch(err){
          showAlert('danger','Error recovery', humanize(err));
        }
      });
    }

    async function handleSession(session){
      state.user = session?.user || null;

      if (!state.user){
        el('loginView').classList.remove('hidden');
        el('appView').classList.add('hidden');
        el('whoami').textContent = '...';
        el('btnLogout').disabled = true;
        return;
      }

      // profile (full_name)
      try{
        const { data: prof, error } = await withTimeout(
          supabase.from(MAP.profiles.table).select('*').eq(MAP.profiles.id, state.user.id).maybeSingle(),
          15000
        );
        if (error) throw error;
        state.profile = prof || null;
      }catch(_){
        state.profile = null;
      }

      el('loginView').classList.add('hidden');
      el('appView').classList.remove('hidden');
      el('whoami').textContent = state.profile?.[MAP.profiles.full_name] || state.user.email || 'Usuario';
      el('btnLogout').disabled = false;

      if(!state.bound) bindUIOnce();

      // load initial
      if(state.campaigns.length === 0) await refreshAll();
    }

    // --- LOGIN ---
    async function init(){
      await bootstrapRecoverySessionIfNeeded();

      const { data } = await supabase.auth.getSession();
      await handleSession(data.session);

      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'PASSWORD_RECOVERY') new bootstrap.Modal(el('setNewPassModal')).show();
        await handleSession(session);
      });

      // Escape: close loading overlay in dev
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') showLoading(false); });
    }

    el('btnSignIn').addEventListener('click', async ()=>{
      const email = el('loginEmail').value.trim();
      const password = el('loginPass').value;
      if (!email || !password) return showAlert('warning','Faltan datos','Ingresa tu correo y contraseña.');

      await runWithLoading(async () => {
        try{
          const { error } = await withTimeout(supabase.auth.signInWithPassword({ email, password }), 15000);
          if (error) throw error;
          showAlert('success','Bienvenido','Iniciando sesión...');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    });

    el('btnLogout').addEventListener('click', async () => {
      await runWithLoading(async () => {
        await supabase.auth.signOut();
      });
      window.location.reload();
    });

    el('btnForgotPass').addEventListener('click', () => new bootstrap.Modal(el('forgotPassModal')).show());

    el('btnSendResetEmail').addEventListener('click', async ()=>{
      const email = el('fp_email').value.trim();
      if (!email) return showAlert('warning','Email requerido','Ingresa tu correo.');

      await runWithLoading(async () => {
        try{
          // GitHub Pages: redirect to same page
          const redirectTo = window.location.origin + window.location.pathname;
          const { error } = await withTimeout(supabase.auth.resetPasswordForEmail(email, { redirectTo }), 15000);
          if(error) throw error;
          bootstrap.Modal.getInstance(el('forgotPassModal'))?.hide();
          showAlert('success','Enviado','Revisa tu bandeja de entrada.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    });

    el('btnSetNewPass').addEventListener('click', async ()=>{
      const p1 = el('np1').value;
      const p2 = el('np2').value;
      if (!p1 || p1.length < 6) return showAlert('warning','Seguridad','Mínimo 6 caracteres.');
      if (p1 !== p2) return showAlert('warning','Error','Las contraseñas no coinciden.');

      await runWithLoading(async () => {
        try{
          const { error } = await withTimeout(supabase.auth.updateUser({ password: p1 }), 15000);
          if (error) throw error;
          bootstrap.Modal.getInstance(el('setNewPassModal'))?.hide();
          showAlert('success','Listo','Contraseña actualizada.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    });

    // --- LOADERS ---
    async function refreshAll(){
      await runWithLoading(async () => {
        try{
          await Promise.all([loadCampaigns(), loadChannels()]);
          await Promise.all([loadPieces(), loadMetrics(), loadLeads()]);
          updateSelects();
          applyPiecesFilters();
          applyLeadsFilters();
          showAlert('success','OK','Datos cargados.');
        }catch(err){
          console.error(err);
          showAlert('danger','Error de conexión', humanize(err));
        }
      });
    }

    // --- CAMPAIGNS ---
    async function loadCampaigns(){
      const { data, error } = await withTimeout(
        supabase.from(MAP.campaigns.table).select('*').order(MAP.campaigns.created_at, { ascending:false }),
        15000
      );
      if(error) throw error;
      state.campaigns = data || [];
      renderCampaigns(state.campaigns);
    }

    function renderCampaigns(rows){
      el('tblCampaigns').querySelector('tbody').innerHTML = rows.map(r => `
        <tr>
          <td class="fw-bold text-primary">${esc(r[MAP.campaigns.name])}</td>
          <td><span class="badge bg-light text-dark border"> ${esc(r[MAP.campaigns.bimester])}</span></td>
          <td class="small">${esc(fmtDate(r[MAP.campaigns.start]))}</td>
          <td class="small">${esc(fmtDate(r[MAP.campaigns.end]))}</td>
          <td>${getStatusBadge(r[MAP.campaigns.status])}</td>
          <td class="text-end">
             <button class="btn btn-sm btn-white border" onclick="editCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
             <button class="btn btn-sm btn-white border ms-1" onclick="delCamp('${r[MAP.campaigns.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
          </td>
        </tr>
      `).join('');
    }

    window.editCamp = (id) => openCampaignModal(state.campaigns.find(x => String(x[MAP.campaigns.id]) === String(id)));
    window.delCamp = async (id) => {
      if(!confirm('¿Borrar campaña? (Esto borrará piezas por ON DELETE CASCADE)')) return;
      await runWithLoading(async () => {
        try{
          const { error } = await withTimeout(
            supabase.from(MAP.campaigns.table).delete().eq(MAP.campaigns.id, id),
            15000
          );
          if(error) throw error;
          await loadCampaigns();
          await loadPieces();
          updateSelects();
          showAlert('success','Eliminado','Campaña borrada.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    };

    function openCampaignModal(row=null){
      el('c_id').value = row?.[MAP.campaigns.id] || '';
      el('c_name').value = row?.[MAP.campaigns.name] || '';
      el('c_bim').value = row?.[MAP.campaigns.bimester] || 'B1';
      el('c_status').value = row?.[MAP.campaigns.status] || '';
      el('c_start').value = fmtDate(row?.[MAP.campaigns.start]) || '';
      el('c_end').value = fmtDate(row?.[MAP.campaigns.end]) || '';
      el('c_objective').value = row?.[MAP.campaigns.objective] || '';
      el('c_anchor_event').value = row?.[MAP.campaigns.anchor_event] || '';
      el('c_lead_magnet').value = row?.[MAP.campaigns.lead_magnet] || '';
      el('c_budget').value = row?.[MAP.campaigns.budget_planned] ?? 0;
      new bootstrap.Modal(el('campaignModal')).show();
    }

    el('btnSaveCampaign').onclick = async () => {
      const name = el('c_name').value.trim();
      const start = el('c_start').value;
      const end = el('c_end').value;
      if(!name) return showAlert('warning','Validación','Nombre es obligatorio.');
      if(!start || !end) return showAlert('warning','Validación','Inicio y fin son obligatorios.');

      await runWithLoading(async () => {
        try{
          const payload = {};
          payload[MAP.campaigns.name] = name;
          payload[MAP.campaigns.bimester] = el('c_bim').value;
          payload[MAP.campaigns.start] = start;
          payload[MAP.campaigns.end] = end;
          payload[MAP.campaigns.objective] = el('c_objective').value.trim() || null;
          payload[MAP.campaigns.status] = el('c_status').value.trim() || null;
          payload[MAP.campaigns.anchor_event] = el('c_anchor_event').value.trim() || null;
          payload[MAP.campaigns.lead_magnet] = el('c_lead_magnet').value.trim() || null;
          payload[MAP.campaigns.budget_planned] = asNumber(el('c_budget').value);

          const id = el('c_id').value;
          const q = id
            ? supabase.from(MAP.campaigns.table).update(payload).eq(MAP.campaigns.id, id)
            : supabase.from(MAP.campaigns.table).insert(payload);

          const { error } = await withTimeout(q, 15000);
          if(error) throw error;

          bootstrap.Modal.getInstance(el('campaignModal'))?.hide();
          await loadCampaigns();
          updateSelects();
          showAlert('success','Guardado','Campaña actualizada.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    };

    // --- CHANNELS (best-effort) ---
    async function loadChannels(){
      // If your channels table isn't compatible with select('id,name'), we'll fallback.
      try{
        const { data, error } = await withTimeout(
          supabase.from(MAP.channels.table).select(`${MAP.channels.id},${MAP.channels.name}`).order(MAP.channels.id, { ascending:true }),
          15000
        );
        if(error) throw error;
        state.channels = data || [];
      }catch(_){
        state.channels = []; // fallback
      }
    }

    function channelNameById(id){
      if(!id) return '—';
      const row = state.channels.find(c => String(c[MAP.channels.id]) === String(id));
      return row ? (row[MAP.channels.name] ?? String(id)) : String(id);
    }

    // --- PIECES ---
    async function loadPieces(){
      const { data, error } = await withTimeout(
        supabase.from(MAP.pieces.table).select('*').order(MAP.pieces.created_at, { ascending:false }),
        15000
      );
      if(error) throw error;
      state.pieces = data || [];
      renderPieces(state.pieces);
    }

    function renderPieces(rows){
      el('tblPieces').querySelector('tbody').innerHTML = rows.map(r => {
        const camp = state.campaigns.find(c => c[MAP.campaigns.id] == r[MAP.pieces.campaign_id]);
        return `
          <tr>
            <td class="fw-bold">${esc(r[MAP.pieces.name])}</td>
            <td class="small text-muted">${esc(camp ? camp[MAP.campaigns.name] : 'Sin campaña')}</td>
            <td class="small">${esc(channelNameById(r[MAP.pieces.channel_id]))}</td>
            <td><span class="badge bg-light text-dark border fw-normal">${esc(r[MAP.pieces.format])}</span></td>
            <td>${getStatusBadge(r[MAP.pieces.status])}</td>
            <td class="truncate-2 small" style="max-width:220px" title="${esc(r[MAP.pieces.hook_copy])}">${esc(r[MAP.pieces.hook_copy])}</td>
            <td class="truncate-2 small" style="max-width:180px" title="${esc(r[MAP.pieces.cta_destination])}">${esc(r[MAP.pieces.cta_destination])}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-white border" onclick="editPiece('${r[MAP.pieces.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
              <button class="btn btn-sm btn-white border ms-1" onclick="delPiece('${r[MAP.pieces.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editPiece = (id) => {
      const row = state.pieces.find(r => String(r[MAP.pieces.id]) === String(id));
      el('p_id').value = row?.[MAP.pieces.id] || '';
      el('p_campaign').value = row?.[MAP.pieces.campaign_id] || '';
      el('p_channel_id').value = row?.[MAP.pieces.channel_id] ?? '';
      el('p_name').value = row?.[MAP.pieces.name] || '';
      el('p_format').value = row?.[MAP.pieces.format] || '';
      el('p_status').value = row?.[MAP.pieces.status] || '';
      el('p_pillar').value = row?.[MAP.pieces.pillar] || '';
      el('p_visual_style').value = row?.[MAP.pieces.visual_style] || '';
      el('p_hook_copy').value = row?.[MAP.pieces.hook_copy] || '';
      el('p_cta').value = row?.[MAP.pieces.cta_destination] || '';
      el('p_ad_id').value = row?.[MAP.pieces.ad_id] || '';
      new bootstrap.Modal(el('pieceModal')).show();
    };

    window.delPiece = async (id) => {
      if(!confirm('¿Borrar pieza? (Esto borrará métricas por ON DELETE CASCADE)')) return;
      await runWithLoading(async () => {
        try{
          const { error } = await withTimeout(
            supabase.from(MAP.pieces.table).delete().eq(MAP.pieces.id, id),
            15000
          );
          if(error) throw error;
          await loadPieces();
          await loadMetrics();
          updateSelects();
          showAlert('success','Eliminado','Pieza borrada.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    };

    el('btnSavePiece').onclick = async () => {
      const name = el('p_name').value.trim();
      const format = el('p_format').value.trim();
      if(!name) return showAlert('warning','Validación','Nombre es obligatorio.');
      if(!format) return showAlert('warning','Validación','Formato es obligatorio (enum piece_format).');

      await runWithLoading(async () => {
        try{
          const payload = {};
          payload[MAP.pieces.campaign_id] = el('p_campaign').value || null;
          payload[MAP.pieces.channel_id] = el('p_channel_id').value ? Number(el('p_channel_id').value) : null;
          payload[MAP.pieces.name] = name;
          payload[MAP.pieces.format] = format;
          payload[MAP.pieces.status] = el('p_status').value.trim() || null;
          payload[MAP.pieces.pillar] = el('p_pillar').value.trim() || null;
          payload[MAP.pieces.visual_style] = el('p_visual_style').value.trim() || null;
          payload[MAP.pieces.hook_copy] = el('p_hook_copy').value.trim() || null;
          payload[MAP.pieces.cta_destination] = el('p_cta').value.trim() || null;
          payload[MAP.pieces.ad_id] = el('p_ad_id').value.trim() || null;

          const id = el('p_id').value;
          const q = id
            ? supabase.from(MAP.pieces.table).update(payload).eq(MAP.pieces.id, id)
            : supabase.from(MAP.pieces.table).insert(payload);

          const { error } = await withTimeout(q, 15000);
          if(error) throw error;

          bootstrap.Modal.getInstance(el('pieceModal'))?.hide();
          await loadPieces();
          updateSelects();
          showAlert('success','Guardado','Pieza guardada.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    };

    function applyPiecesFilters(){
      const camp = el('fCamp').value;
      const status = el('fPieceStatus').value.trim().toLowerCase();
      const q = el('fQ').value.trim().toLowerCase();

      const filtered = state.pieces.filter(r => {
        if(camp && String(r[MAP.pieces.campaign_id] || '') !== String(camp)) return false;
        if(status && String(r[MAP.pieces.status] || '').toLowerCase() !== status) return false;
        if(q){
          const blob = JSON.stringify({
            name: r[MAP.pieces.name],
            hook: r[MAP.pieces.hook_copy],
            ad_id: r[MAP.pieces.ad_id],
            cta: r[MAP.pieces.cta_destination],
            pillar: r[MAP.pieces.pillar]
          }).toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      renderPieces(filtered);
      updateSelects();
    }

    // --- METRICS ---
    async function loadMetrics(){
      // filters
      const pieceId = el('mPiece').value || null;
      const from = el('mFrom').value || null;
      const to = el('mTo').value || null;

      let q = supabase.from(MAP.metrics.table).select('*').order(MAP.metrics.date, { ascending:false });

      if(pieceId) q = q.eq(MAP.metrics.piece_id, pieceId);
      if(from) q = q.gte(MAP.metrics.date, from);
      if(to) q = q.lte(MAP.metrics.date, to);

      const { data, error } = await withTimeout(q, 15000);
      if(error) throw error;
      state.metrics = data || [];
      renderMetrics(state.metrics);
    }

    function renderMetrics(rows){
      el('tblMetrics').querySelector('tbody').innerHTML = rows.map(r => {
        const p = state.pieces.find(x => x[MAP.pieces.id] == r[MAP.metrics.piece_id]);
        return `
          <tr>
            <td class="text-start">
              <div class="small fw-bold">${esc(p ? p[MAP.pieces.name] : '—')}</div>
              <div class="mini text-muted truncate-2">${esc(p ? p[MAP.pieces.hook_copy] : '')}</div>
            </td>
            <td class="mono small">${esc(r[MAP.metrics.date])}</td>
            <td>${esc(r[MAP.metrics.volume] ?? 0)}</td>
            <td>${esc(r[MAP.metrics.interactions] ?? 0)}</td>
            <td>${esc(fmtMoney(r[MAP.metrics.spend] ?? 0))}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-white border" onclick="editMetric('${r[MAP.metrics.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editMetric = (id) => {
      const r = state.metrics.find(x => String(x[MAP.metrics.id]) === String(id));
      el('mx_id').value = r?.[MAP.metrics.id] || '';
      el('mx_piece').value = r?.[MAP.metrics.piece_id] || '';
      el('mx_date').value = r?.[MAP.metrics.date] || '';
      el('mx_volume').value = r?.[MAP.metrics.volume] ?? 0;
      el('mx_interactions').value = r?.[MAP.metrics.interactions] ?? 0;
      el('mx_spend').value = r?.[MAP.metrics.spend] ?? 0;
      new bootstrap.Modal(el('metricModal')).show();
    };

    el('btnSaveMetric').onclick = async () => {
      const pieceId = el('mx_piece').value;
      const date = el('mx_date').value;
      if(!pieceId) return showAlert('warning','Validación','Selecciona una pieza.');
      if(!date) return showAlert('warning','Validación','Fecha es obligatoria.');

      await runWithLoading(async () => {
        try{
          const payload = {};
          payload[MAP.metrics.piece_id] = pieceId;
          payload[MAP.metrics.date] = date;
          payload[MAP.metrics.volume] = asNumber(el('mx_volume').value);
          payload[MAP.metrics.interactions] = asNumber(el('mx_interactions').value);
          payload[MAP.metrics.spend] = asNumber(el('mx_spend').value);

          const id = el('mx_id').value;

          // If editing an existing row: update by id.
          // If new: upsert by unique (piece_id, date).
          const q = id
            ? supabase.from(MAP.metrics.table).update(payload).eq(MAP.metrics.id, id)
            : supabase.from(MAP.metrics.table).upsert(payload, { onConflict: `${MAP.metrics.piece_id},${MAP.metrics.date}` });

          const { error } = await withTimeout(q, 15000);
          if(error) throw error;

          bootstrap.Modal.getInstance(el('metricModal'))?.hide();
          await loadMetrics();
          showAlert('success','Guardado','Métrica guardada.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    };

    // --- LEADS ---
    async function loadLeads(){
      const { data, error } = await withTimeout(
        supabase.from(MAP.leads.table).select('*').order(MAP.leads.created_at, {ascending:false}),
        15000
      );
      if(error) throw error;
      state.leads = data || [];
      renderLeads(state.leads);
    }

    function renderLeads(rows){
      el('tblLeads').querySelector('tbody').innerHTML = rows.map(r => {
        const c = state.campaigns.find(x=>x[MAP.campaigns.id] == r[MAP.leads.campaign_id]);
        const p = state.pieces.find(x=>x[MAP.pieces.id] == r[MAP.leads.piece_id]);

        const tri = r[MAP.leads.triage_status] ?? '—';
        const appt = r[MAP.leads.appointment_date] ? fmtDTLocal(r[MAP.leads.appointment_date]).replace('T',' ') : '—';

        const origin = [
          r[MAP.leads.source_detail] || '',
          c ? c[MAP.campaigns.name] : '',
          p ? p[MAP.pieces.name] : ''
        ].filter(Boolean).join(' · ');

        return `
          <tr>
            <td class="small text-muted">${esc(String(r[MAP.leads.created_at] || '').slice(0,19).replace('T',' '))}</td>
            <td class="fw-bold text-primary">${esc(r[MAP.leads.full_name])}</td>
            <td>${esc(r[MAP.leads.phone] || '')}</td>
            <td class="small">${esc(r[MAP.leads.email] || '')}</td>
            <td class="truncate-2 small text-muted" style="max-width:220px" title="${esc(origin)}">${esc(origin)}</td>
            <td>${getStatusBadge(tri)}</td>
            <td class="small">${esc(appt)}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-white border" onclick="editLead('${r[MAP.leads.id]}')"><i class="bi bi-pencil-fill text-muted"></i></button>
              <button class="btn btn-sm btn-white border ms-1" onclick="delLead('${r[MAP.leads.id]}')"><i class="bi bi-trash-fill text-danger opacity-50"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editLead = (id) => {
      const r = state.leads.find(x => String(x[MAP.leads.id]) === String(id));

      el('ld_id').value = r?.[MAP.leads.id] || '';
      el('ld_full_name').value = r?.[MAP.leads.full_name] || '';
      el('ld_phone').value = r?.[MAP.leads.phone] || '';
      el('ld_email').value = r?.[MAP.leads.email] || '';
      el('ld_source_detail').value = r?.[MAP.leads.source_detail] || '';
      el('ld_campaign').value = r?.[MAP.leads.campaign_id] || '';
      el('ld_piece').value = r?.[MAP.leads.piece_id] || '';
      el('ld_triage_status').value = r?.[MAP.leads.triage_status] || 'nuevo';
      el('ld_triage_notes').value = r?.[MAP.leads.triage_notes] || '';
      el('ld_clinical_outcome').value = r?.[MAP.leads.clinical_outcome] || 'pendiente';
      el('ld_appointment_date').value = r?.[MAP.leads.appointment_date] ? fmtDTLocal(r[MAP.leads.appointment_date]) : '';
      el('ld_ticket_value').value = r?.[MAP.leads.ticket_value] ?? 0;
      el('ld_is_retained').checked = !!r?.[MAP.leads.is_retained];

      new bootstrap.Modal(el('leadModal')).show();
    };

    window.delLead = async (id) => {
      if(!confirm('¿Borrar lead?')) return;
      await runWithLoading(async () => {
        try{
          const { error } = await withTimeout(
            supabase.from(MAP.leads.table).delete().eq(MAP.leads.id, id),
            15000
          );
          if(error) throw error;
          await loadLeads();
          showAlert('success','Eliminado','Lead borrado.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    };

    el('btnSaveLead').onclick = async () => {
      const fullName = el('ld_full_name').value.trim();
      if(!fullName) return showAlert('warning','Validación','Nombre completo es obligatorio.');

      await runWithLoading(async () => {
        try{
          const payload = {};
          payload[MAP.leads.full_name] = fullName;
          payload[MAP.leads.phone] = el('ld_phone').value.trim() || null;
          payload[MAP.leads.email] = el('ld_email').value.trim() || null;
          payload[MAP.leads.source_detail] = el('ld_source_detail').value.trim() || null;
          payload[MAP.leads.campaign_id] = el('ld_campaign').value || null;
          payload[MAP.leads.piece_id] = el('ld_piece').value || null;
          payload[MAP.leads.triage_status] = el('ld_triage_status').value.trim() || null;
          payload[MAP.leads.triage_notes] = el('ld_triage_notes').value.trim() || null;
          payload[MAP.leads.clinical_outcome] = el('ld_clinical_outcome').value.trim() || null;
          payload[MAP.leads.appointment_date] = el('ld_appointment_date').value ? new Date(el('ld_appointment_date').value).toISOString() : null;
          payload[MAP.leads.ticket_value] = asNumber(el('ld_ticket_value').value);
          payload[MAP.leads.is_retained] = !!el('ld_is_retained').checked;

          const id = el('ld_id').value;
          const q = id
            ? supabase.from(MAP.leads.table).update(payload).eq(MAP.leads.id, id)
            : supabase.from(MAP.leads.table).insert(payload);

          const { error } = await withTimeout(q, 15000);
          if(error) throw error;

          bootstrap.Modal.getInstance(el('leadModal'))?.hide();
          await loadLeads();
          showAlert('success','Guardado','Lead guardado.');
        }catch(err){
          showAlert('danger','Error', humanize(err));
        }
      });
    };

    function applyLeadsFilters(){
      const camp = el('lCamp').value;
      const piece = el('lPiece').value;
      const q = el('lQ').value.trim().toLowerCase();

      const filtered = state.leads.filter(r => {
        if(camp && String(r[MAP.leads.campaign_id] || '') !== String(camp)) return false;
        if(piece && String(r[MAP.leads.piece_id] || '') !== String(piece)) return false;
        if(q){
          const blob = JSON.stringify({
            full_name: r[MAP.leads.full_name],
            phone: r[MAP.leads.phone],
            email: r[MAP.leads.email],
            source: r[MAP.leads.source_detail],
            triage: r[MAP.leads.triage_status]
          }).toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      renderLeads(filtered);
    }

    // --- SELECTS & UI ---
    function campaignLabel(c){
      const b = c[MAP.campaigns.bimester] ?? '';
      const s = fmtDate(c[MAP.campaigns.start]);
      const e = fmtDate(c[MAP.campaigns.end]);
      return `${c[MAP.campaigns.name]} · ${b} · ${s}→${e}`.trim();
    }

    function pieceLabel(p){
      const n = p[MAP.pieces.name] ?? '';
      const fmt = p[MAP.pieces.format] ?? '';
      return `${n} · ${fmt}`.trim();
    }

    function updateSelects(){
      // campaigns
      const campOptionsAll = '<option value="">Todas</option>' + state.campaigns.map(c => `<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`).join('');
      const campOptionsPick = '<option value="">(Sin campaña)</option>' + state.campaigns.map(c => `<option value="${c[MAP.campaigns.id]}">${esc(campaignLabel(c))}</option>`).join('');

      el('fCamp').innerHTML = campOptionsAll;
      el('p_campaign').innerHTML = campOptionsPick;
      el('ld_campaign').innerHTML = campOptionsPick;
      el('lCamp').innerHTML = campOptionsAll;

      // pieces
      const pieceOptionsPick = '<option value="">(Sin pieza)</option>' + state.pieces.map(p => `<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`).join('');
      const pieceOptionsAll = '<option value="">Todas</option>' + state.pieces.map(p => `<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`).join('');

      el('mx_piece').innerHTML = '<option value="">(Seleccionar)</option>' + state.pieces.map(p => `<option value="${p[MAP.pieces.id]}">${esc(pieceLabel(p))}</option>`).join('');
      el('mPiece').innerHTML = pieceOptionsAll;
      el('ld_piece').innerHTML = pieceOptionsPick;
      el('lPiece').innerHTML = pieceOptionsAll;

      // channels (nullable)
      const chBase = '<option value="">(Sin canal)</option>';
      const chOpts = state.channels.length
        ? chBase + state.channels.map(ch => `<option value="${ch[MAP.channels.id]}">${esc(ch[MAP.channels.name] ?? ch[MAP.channels.id])}</option>`).join('')
        : chBase + `<option value="" disabled>(No se pudo cargar tabla channels)</option>`;
      el('p_channel_id').innerHTML = chOpts;
    }

    function clearCampaignForm(){
      el('c_id').value = '';
      el('c_name').value = '';
      el('c_bim').value = 'B1';
      el('c_status').value = '';
      el('c_start').value = '';
      el('c_end').value = '';
      el('c_objective').value = '';
      el('c_anchor_event').value = '';
      el('c_lead_magnet').value = '';
      el('c_budget').value = 0;
    }

    function clearPieceForm(){
      el('p_id').value = '';
      el('p_campaign').value = '';
      el('p_channel_id').value = '';
      el('p_name').value = '';
      el('p_format').value = '';
      el('p_status').value = '';
      el('p_pillar').value = '';
      el('p_visual_style').value = '';
      el('p_hook_copy').value = '';
      el('p_cta').value = '';
      el('p_ad_id').value = '';
    }

    function clearMetricForm(){
      el('mx_id').value = '';
      el('mx_piece').value = '';
      el('mx_date').value = '';
      el('mx_volume').value = 0;
      el('mx_interactions').value = 0;
      el('mx_spend').value = 0;
    }

    function clearLeadForm(){
      el('ld_id').value = '';
      el('ld_full_name').value = '';
      el('ld_phone').value = '';
      el('ld_email').value = '';
      el('ld_source_detail').value = '';
      el('ld_campaign').value = '';
      el('ld_piece').value = '';
      el('ld_triage_status').value = 'nuevo';
      el('ld_triage_notes').value = '';
      el('ld_clinical_outcome').value = 'pendiente';
      el('ld_appointment_date').value = '';
      el('ld_ticket_value').value = 0;
      el('ld_is_retained').checked = false;
    }

    function bindUIOnce(){
      state.bound = true;

      // top buttons
      el('btnNewCampaign').onclick = () => { clearCampaignForm(); openCampaignModal(null); };
      el('btnNewPiece').onclick = () => { clearPieceForm(); new bootstrap.Modal(el('pieceModal')).show(); };
      el('btnNewMetric').onclick = () => { clearMetricForm(); new bootstrap.Modal(el('metricModal')).show(); };
      el('btnNewLead').onclick = () => { clearLeadForm(); new bootstrap.Modal(el('leadModal')).show(); };

      // reload buttons
      el('btnReloadCampaigns').onclick = async () => { await runWithLoading(loadCampaigns); updateSelects(); };
      el('btnReloadPieces').onclick = async () => { await runWithLoading(loadPieces); updateSelects(); applyPiecesFilters(); };
      el('btnReloadMetrics').onclick = async () => { await runWithLoading(loadMetrics); };
      el('btnReloadLeads').onclick = async () => { await runWithLoading(loadLeads); applyLeadsFilters(); };

      // filters
      el('fCamp').addEventListener('change', applyPiecesFilters);
      el('fPieceStatus').addEventListener('keyup', applyPiecesFilters);
      el('fQ').addEventListener('keyup', applyPiecesFilters);

      el('lCamp').addEventListener('change', applyLeadsFilters);
      el('lPiece').addEventListener('change', applyLeadsFilters);
      el('lQ').addEventListener('keyup', applyLeadsFilters);

      // metrics filter
      el('btnReloadMetrics').onclick = async () => { await runWithLoading(loadMetrics); };

      // If we change campaign/pieces, keep selects consistent
      el('p_campaign').addEventListener('change', () => {});
      el('ld_campaign').addEventListener('change', () => {});
    }

    init();
  </script>
</body>
</html>
